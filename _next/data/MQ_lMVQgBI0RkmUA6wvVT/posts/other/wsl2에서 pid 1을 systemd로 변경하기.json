{"pageProps":{"post":{"name":"wsl2에서 pid 1을 systemd로 변경하기","content":"\n# `systemd`로 인한 에러\n`wsl2`(이하 `wsl`)를 그냥 실행할 경우, 다음과 같은 에러를 겪을 때가 있다.\n```bash\nSystem has not been booted with systemd as init system (PID 1). Can't operate.\n```\n\n이는 pid 1번이 `systemd` 가 아니어서 생기는 문제로, 해결하기 위해서는 [genie](https://github.com/arkane-systems/genie)와 같은 별도의 프로그램을 실행해줘야 했다. 하지만 최근 처음부터 이를 해결한 상태로 wsl을 실행하는 프로젝트를 발견했는데, 바로 [Distrod](https://github.com/nullpo-head/wsl-distrod)다.\n\n# `Distrod`를 사용하자\n`Distrod`를 설치하는 방법은 크게 두가지로 나뉘는데,\n하나는 이미 해당 패치가 적용된 배포판을 사용하거나,\n기존에 사용하던 `wsl`환경에 해당 패치를 적용하는 것이다.\n\n## 신규 설치\n[링크](https://github.com/nullpo-head/wsl-distrod/releases/latest/download/distrod_wsl_launcher-x86_64.zip)의 압축 파일을 해제하면, 단일 exe 파일이 존재하는데, 해당 실행 파일을 실행시키면 끝이다.\n\n굉장히 다양한 배포판(아치, 데비안, 젠투, 보이드 등)을 지원하기에, 대부분의 경우, 선택권을 제한당한다는 기분은 느끼지 못할 것이다.\n\n## 기존 환경에 패치\n이것 또한 아주 간단하다. \n1. 패치 스크립트를 다운로드 한 다음, 실행한다.(아직 적용되지 않았다.)\n```bash\ncurl -L -O \"https://raw.githubusercontent.com/nullpo-head/wsl-distrod/main/install.sh\"\nchmod +x install.sh\nsudo ./install.sh install\n```\n\n2. wsl이 처음 실행됐을 때, 다음 명령어를 관리자 권한으로 실행하던가,\n```bash\n/opt/distrod/bin/distrod enable\n```\n3. 또는 다음 명령어로 윈도우 스케쥴러에 자동으로 해당 패치가 정상적으로 실행될 수 있도록 한다.\n```bash\n/opt/distrod/bin/distrod enable --start-on-windows-boot\n```\n\n이제 ```ps -ef | head -n 2```으로 확인해보면,\n```bash\nUID          PID    PPID  C STIME TTY          TIME CMD\nroot           1       0  0 21:34 ?        00:00:00 /sbin/init systemd.setenv=WSL_DISTRO_NAME=Distrod systemd.setenv=WSL_INTEROP=/run/WSL/11_interop systemd.setenv=WSLENV=WT_SESSION::WT_PROFILE_ID --unit=multi-user.target\n```\n위와 같이 `distrod`의 패치가 적용된 것을 확인할 수 있다.\n\n## 윈도우11은 주의\n`distrod`의 기능 중, `wsl`의 특정 포트를 외부로 포워딩 할 수 있는 `portproxy`라는 서비스가 있는데, 윈도우 11에서는 정상적으로 작동하지 않는 [버그](https://github.com/nullpo-head/wsl-distrod/blob/main/docs/references.md#know-bugs)가 있다고 한다.\n","mtime":"2022-08-20T22:17:59.496+09:00","href":"other/wsl2에서 pid 1을 systemd로 변경하기","data":{"title":"wsl2에서 pid 1을 systemd로 변경하기","tags":["windows","wsl","@all"],"page":null,"summary":"잘 만들어놓은 배포판을 가져다 쓰자","date":"2022-08-14T22:13:27.850+09:00"}},"prev_post":{"name":"vim 영문 키보드 자동 전환","content":"\n# 아래 글은 퍼온 글입니다.\n출처는 다음과 같습니다.\n\n[[Vim] Normal모드에서 영문 키보드로 자동 전환하기 (Windows)](https://rottk.tistory.com/entry/Vim-Normal%EB%AA%A8%EB%93%9C%EC%97%90%EC%84%9C-%EC%98%81%EB%AC%B8-%ED%82%A4%EB%B3%B4%EB%93%9C%EB%A1%9C-%EC%A0%84%ED%99%98%ED%95%98%EA%B8%B0-Windows)\n\n---\n\n# Windows에서 `Vim`을 사용하는 경우 (`VSCode`의 `Vim Extension`, `WSL`에서의 `Vim`)\n`Vim` 사용 시 흔히 겪는 문제가 한글로 주석 작성 후, Normal 모드로 전환하여 명령어를 입력하면 명령어가 적용되지 않는 문제가 있습니다.\n\n예를 들어, 파일 저장을 위해 `ESC` + `:w` 를 입력하였으나, 실제로는 `ESC`, `:ㅈ`가 입력되어 저장이 되지 않는 경우입니다.\n\n`Vim`에서 한글을 입력하는 경우는 코드에 주석을 넣는 경우 이외에는 없으므로, Normal 모드로 전환 시(즉, `ESC`를 누르면) 영문으로 자동전환이 되도록 설정하면 이러한 문제가 해결될 것입니다.\n\n※ 간단히 IME에서 해당 기능을 제공해준다면 별도의 프로그램을 설치하지 않아도 되겠지만 아쉽게도 `Microsoft IME`는 설정 기능이 존재하지 않아 외부 프로그램(키 매크로)을 설치하여 도움을 받아야 합니다.\n* 윈도에 [Auto HotKey](https://www.autohotkey.com/)를 설치합니다.\n* 메모장에 `Script.ahk`를 만들어 아래의 Script를 작성합니다.\n* 작성한 스크립트를 더블 클릭하여 실행합니다. 이후, `ESC`를 누르면 자동으로 영문 키보드로 전환됩니다.\n\n```auto hotkey\n$Esc::\n    if(IME_CHECK(\"A\"))\n        Send, {VK15}    ;영문이라면 한영전환 키를 입력해준다.\n    Send, {Escape}\n    return\n\n/*\n  IME check \n*/\nIME_CHECK(WinTitle) {\n  WinGet,hWnd,ID,%WinTitle%\n  Return Send_ImeControl(ImmGetDefaultIMEWnd(hWnd),0x005,\"\")\n}\nSend_ImeControl(DefaultIMEWnd, wParam, lParam) {\n  DetectSave := A_DetectHiddenWindows\n  DetectHiddenWindows,ON\n   SendMessage 0x283, wParam,lParam,,ahk_id %DefaultIMEWnd%\n  if (DetectSave <> A_DetectHiddenWindows)\n      DetectHiddenWindows,%DetectSave%\n  return ErrorLevel\n}\nImmGetDefaultIMEWnd(hWnd) {\n  return DllCall(\"imm32\\ImmGetDefaultIMEWnd\", Uint,hWnd, Uint)\n}\n```\n\n## Windows 실행시 자동으로 Script 시작하기\nScript를 실행파일(.exe)로 변환합니다.\n\n1. `C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\AutoHotkey` 폴더로 이동합니다.\n2. `Convert .ahk to .exe`를 더블클릭하여 실행합니다.\n3. `Source`항목에서 앞서 작성한 `script.ahk`를 추가합니다.\n4. `Convert` 를 클릭합니다.\n5. 'Conversion complete' 팝업이 표시되면, .exe 파일이 스크립트와 같은 폴더에 생성됩니다.\n\n실행파일을 윈도우즈 시작프로그램으로 추가합니다.\n\n1. Windows 로고 키 + R을 누르고 `shell:startup`을 입력한 다음 확인을 선택합니다. 그러면 시작 폴더가 열립니다.\n2. 앞서 변환한 실행파일(.exe)을 복사하여 시작 폴더에 붙여넣습니다.\n\n# 출처\n* [https://github.com/johngrib/simple_vim_guide/blob/master/md/with_korean.md](https://github.com/johngrib/simple_vim_guide/blob/master/md/with_korean.md)\n* [https://www.autohotkey.com/](https://www.autohotkey.com/)\n* [Windows 10에서 시작할 때 자동으로 실행되는 앱 추가](https://support.microsoft.com/ko-kr/windows/windows-10%EC%97%90%EC%84%9C-%EC%8B%9C%EC%9E%91%ED%95%A0-%EB%95%8C-%EC%9E%90%EB%8F%99%EC%9C%BC%EB%A1%9C-%EC%8B%A4%ED%96%89%EB%90%98%EB%8A%94-%EC%95%B1-%EC%B6%94%EA%B0%80-150da165-dcd9-7230-517b-cf3c295d89dd)\n* [AHK Startup Under Windows 10](https://www.autohotkey.com/boards/viewtopic.php?t=15820)\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"other/vim 영문 키보드 자동 전환","data":{"title":"[Vim] Normal모드에서 영문 키보드로 자동 전환하기 (Windows)","tags":["windows","wsl","vim","@all"],"page":null,"summary":"esc를 누르면 자동으로 영문 키보드가 된다.","date":"2022-08-06T20:00:32.948+09:00"}},"next_post":{"name":"wsl2를 localhost로 연결할 수 없을 때","content":"\n# `localhost` 연결이 왜 안돼\n`wsl2`(이하 `wsl`)에서 \n```bash\npython -m http.server\n```\n위와 같이 서버를 실행 한 다음, ```localhost:8000```으로 접근하면 해당 디렉토리를 탐색할 수 있는 페이지에 접근 할 수 있다.\n\n그런데 정확한 이유는 모르겠지만 이게 정상적으로 작동하지 않을 때가 있다.\n\n# `wsl`의 주소에 직접 접근하자\n`wslconfig`를 수정해봐도 동일한 문제가 반복되는게 짜증나서, `localhost`대신 `wsl`의 로컬 주소를 매핑하는 글을 찾아봤다.\n\n[Fixing WSL2 localhost access issue](https://abdus.dev/posts/fixing-wsl2-localhost-access-issue/)\n\n> 위 글에서 가져온, 아래에서 사용할 코드\n>```powershell {filename=remote-port-hosts.ps1}\n>$hostname = \"wslhost\"\n>\n># find ip of eth0\n>$ifconfig = (wsl -- ip -4 addr show eth0)\n>$ipPattern = \"((\\d+\\.?){4})\"\n>$ip = ([regex]\"inet $ipPattern\").Match($ifconfig).Groups[1].Value\n>if (-not $ip) {\n>    exit\n>}\n>Write-Host $ip\n>\n>$hostsPath = \"$env:windir/system32/drivers/etc/hosts\"\n>\n>$hosts = (Get-Content -Path $hostsPath -Raw -ErrorAction Ignore)\n>if ($null -eq $hosts) {\n>    $hosts = \"\"\n>}\n>$hosts = $hosts.Trim()\n>\n># update or add wsl ip\n>$find = \"$ipPattern\\s+$hostname\"\n>$entry = \"$ip $hostname\"\n>\n>if ($hosts -match $find) {\n>    $hosts = $hosts -replace $find, $entry\n>}\n>else {\n>    $hosts = \"$hosts`n$entry\".Trim()\n>}\n>\n>try {\n>    $temp = \"$hostsPath.new\"\n>    New-Item -Path $temp -ItemType File -Force | Out-Null\n>    Set-Content -Path $temp $hosts\n>\n>    Move-Item -Path $temp -Destination $hostsPath -Force\n>}\n>catch {\n>    Write-Error \"cannot update wsl ip\"\n>}\n>```\n\n해당 글에서는 `wsl`이 처음 시작하고, 네트워크가 연결되는 이벤트에 반응하는 스케쥴을 생성해서 관리하는 방식으로 되어있는데, 이전 글인 `Distrod`와 같이 쓰려니 알 수 없는 에러가 발생했다.\n\n`wsl`으로 지속적인 서비스를 띄워놓을 생각은 없으므로, 터미널 접근시 실행하는 스크립트를 하나 작성하기로 했다.\n\n```bash {filename=hosts.sh}\n#!/usr/bin/env bash\n\nwsl_host_name=wslhost\nwin_ps1='c:\\\\wsl\\\\remote-port-hosts.ps1'\n\nip_pattern='([0-9]{1,3}\\.){3}[0-9]{1,3}'\nwin_hosts='/mnt/c/Windows/System32/drivers/etc/hosts'\npowershell_cmd='Start-Process powershell -verb runas -ArgumentList '\\\n'\"-ExecutionPolicy Bypass -File '${win_ps1}'\"'\n\n# windows의 hosts에 작성되어 있는 wsl ip\nwin_hosts_ip=`cat ${win_hosts} | \\\n    grep ${wsl_host_name} | \\\n    egrep -o ${ip_pattern}`\n# linux의 hosts에 작성되어 있는 wsl ip\nlinux_hosts_ip=`cat /etc/hosts | \\\n    grep ${wsl_host_name} | \\\n    egrep -o ${ip_pattern}`\n# wsl이 실제로 실행되고 있는 ip\nreal_ip=`ip addr | \\\n    awk '/inet/ && /eth0/' | \\\n    awk '{print $2}' | \\\n    egrep -o ${ip_pattern}`\n\nif [ ${win_hosts_ip} == $real_ip ] && \\\n    [ $linux_hosts_ip == $real_ip ]; then\n    exit 0\nfi\n\n# 관리자권한 파워쉘을 실행하여 hosts파일 수정\necho run cmd to change windows hosts\npowershell.exe ${powershell_cmd}\n# 관리자권한으로 wsl의 hosts를 수정\necho change /etc/hosts\nsudo sed -i s/${linux_hosts_ip}/${real_ip}/g /etc/hosts\nexit 0\n```\n\n이제 위 스크립트를 ```.zshrc```와 같은 곳에서 실행하도록 설정하면 된다.\n\n이 스크립트가 정상적으로 실행된다면, 이제 `localhost`대신 `wslhost`로 `wsl`에서 실행한 서비스에 접근할 수 있게 된다.\n\n# 아쉽다\n`wsl`내에서 윈도우의 `hosts` 파일을 수정할 수 있다면 훨씬 간단했지만, 쓰기 권한을 얻을 방법이 보이지 않아 일단 돌아서 처리하기로 했다.\n\n좀 더 깔끔한 방법을 찾는다면 새로 포스팅하자.\n","mtime":"2022-08-20T23:27:38.285+09:00","href":"other/wsl2를 localhost로 연결할 수 없을 때","data":{"title":"wsl2를 localhost로 연결할 수 없을 때","tags":["windows","wsl","@all"],"page":null,"summary":"hosts 파일을 수정할 수 있게 만들자","date":"2022-08-20T22:40:09.881+09:00"}},"page_posts":null},"__N_SSG":true}