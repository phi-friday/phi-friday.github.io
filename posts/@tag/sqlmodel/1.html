<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="author" content="phi.friday@gmail.com, phi"/><meta name="robots" content="index,follow,noarchive"/><meta name="google-site-verification" content="lW107Dj5ageygd67UUzTm-kGls5d-THy9jJQZqLoauw"/><title>phi.log</title><link href="https://use.fontawesome.com/releases/v5.15.1/css/all.css" rel="stylesheet"/><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/e61452b80f7f8356.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e61452b80f7f8356.css" data-n-g=""/><link rel="preload" href="/_next/static/css/c0b66b64eb886a29.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c0b66b64eb886a29.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-5752944655d749a0.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-5dc3bdee87ff18dd.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f6271bdec05edb1f.js" defer=""></script><script src="/_next/static/chunks/996-f3cf67c2e3ac5e06.js" defer=""></script><script src="/_next/static/chunks/756-1349105dbea71525.js" defer=""></script><script src="/_next/static/chunks/224-ddba219ecdd5c904.js" defer=""></script><script src="/_next/static/chunks/pages/posts/@tag/%5B...tag%5D-5364b6481a3135f4.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_buildManifest.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_ssgManifest.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><style>
      #nprogress {
        pointer-events: none;
      }
      #nprogress .bar {
        background: #29D;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
      }
      #nprogress .peg {
        display: block;
        position: absolute;
        right: 0px;
        width: 100px;
        height: 100%;
        box-shadow: 0 0 10px #29D, 0 0 5px #29D;
        opacity: 1;
        -webkit-transform: rotate(3deg) translate(0px, -4px);
        -ms-transform: rotate(3deg) translate(0px, -4px);
        transform: rotate(3deg) translate(0px, -4px);
      }
      #nprogress .spinner {
        display: block;
        position: fixed;
        z-index: 1031;
        top: 15px;
        right: 15px;
      }
      #nprogress .spinner-icon {
        width: 18px;
        height: 18px;
        box-sizing: border-box;
        border: solid 2px transparent;
        border-top-color: #29D;
        border-left-color: #29D;
        border-radius: 50%;
        -webkit-animation: nprogresss-spinner 400ms linear infinite;
        animation: nprogress-spinner 400ms linear infinite;
      }
      .nprogress-custom-parent {
        overflow: hidden;
        position: relative;
      }
      .nprogress-custom-parent #nprogress .spinner,
      .nprogress-custom-parent #nprogress .bar {
        position: absolute;
      }
      @-webkit-keyframes nprogress-spinner {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }
      @keyframes nprogress-spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style><div class="container" style="max-width:900px;min-width:400px"><div class="container default_app"><header><div class="container"><nav class="navbar-light fixed-top navbar navbar-expand-sm bg-light" role="navigation"><div class="container" style="max-width:900px"><div class="container-fluid"><ul class="navbar-nav w-100"><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-home"></i> Home</div></a></li><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/posts/@tag"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-hashtag"></i> Post</div></a></li><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/posts/@page"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-blog"></i> Page</div></a></li><div class="container d-flex justify-content-end align-self-center"><div class="row"><div class="col"><form class="input-group w-auto" method="get" action="https://www.google.com/search" target="_blank" style="min-width:230px"><input type="hidden" name="sitesearch" value="phi-friday.github.io"/><input type="search" class="form-control" placeholder="Search in Google" aria-label="Search" name="q" maxLength="255"/><button class="ripple ripple-surface btn btn-outline-primary" role="button"><i class="fa fa-search"></i></button></form></div></div></div></ul></div></div></nav></div></header><main><div class="container"><div class="row"><div><span><span class="badge bg-light mx-1 text-dark">@all<!-- --> <span class="badge bg-danger">25</span></span></span><span><span class="badge bg-light mx-1 text-dark">#python<!-- --> <span class="badge bg-danger">21</span></span></span><span><span class="badge bg-light mx-1 text-dark">#fastapi<!-- --> <span class="badge bg-danger">14</span></span></span><span><span class="badge bg-primary mx-1">#sqlmodel<!-- --> <span class="badge bg-danger">8</span></span></span><span><span class="badge bg-light mx-1 text-dark">#fastapi-users<!-- --> <span class="badge bg-danger">4</span></span></span><span><span class="badge bg-light mx-1 text-dark">#crud<!-- --> <span class="badge bg-danger">4</span></span></span><span><span class="badge bg-light mx-1 text-dark">#returns<!-- --> <span class="badge bg-danger">3</span></span></span><span><span class="badge bg-light mx-1 text-dark">#í•¨ìˆ˜í˜• í”„ë¡œê·¸ë˜ë°<!-- --> <span class="badge bg-danger">3</span></span></span><span><span class="badge bg-light mx-1 text-dark">#windows<!-- --> <span class="badge bg-danger">3</span></span></span><span><span class="badge bg-light mx-1 text-dark">#wsl<!-- --> <span class="badge bg-danger">3</span></span></span><span><span class="badge bg-light mx-1 text-dark">#tdd<!-- --> <span class="badge bg-danger">2</span></span></span><span><span class="badge bg-light mx-1 text-dark">#anyio<!-- --> <span class="badge bg-danger">2</span></span></span><span><span class="badge bg-light mx-1 text-dark">#async<!-- --> <span class="badge bg-danger">2</span></span></span><span><span class="badge bg-light mx-1 text-dark">#vim<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#js<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#ts<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#nextjs<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#velog<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#github<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#restful<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#pytest<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#alembic<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#postgres<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#black<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#isort<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#vscode<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#asyncio<!-- --> <span class="badge bg-danger">1</span></span></span><span><span class="badge bg-light mx-1 text-dark">#trio<!-- --> <span class="badge bg-danger">1</span></span></span></div></div><div class="row"><div class="container"><div class="card border border-1 shadow-3 my-3 hover-shadow"><div class="card-header"><div><span><span class="badge bg-light mx-1 text-dark">#fastapi<!-- --> </span></span><span><span class="badge bg-light mx-1 text-dark">#fastapi-users<!-- --> </span></span><span><span class="badge bg-light mx-1 text-dark">#python<!-- --> </span></span><span><span class="badge bg-primary mx-1">#sqlmodel<!-- --> </span></span></div></div><div class="card-body"><h5 class="card-title">fastapi íŠœí† ë¦¬ì–¼ -8.2- FastAPI Users v10 ëŒ€ì‘</h5><p class="card-subtitle"><p class="card-text text-muted"><h6><time dateTime="2022-05-07T23:00:58.369+09:00">ì‘ì„±ì¼: 2022ë…„ 5ì›” 7ì¼</time></h6></p></p><p class="card-text">fastapi ì‚¬ìš©ë²•ì„ ë‹¤ì‹œ ê³µë¶€í• ê²¸, ì°¸ê³ í• ë§Œí•œ ì¢‹ì€ ì˜ˆì œê°€ ìˆì–´ì„œ ì´ ì‹œë¦¬ì¦ˆë¥¼ ì•½ê°„ì˜ ë³€ê²½ì„ ì£¼ê³  ë”°ë¼ê°€ë³´ë ¤ í•œë‹¤.</p></div></div><div class="card border border-1 shadow-3 my-3 hover-shadow"><div class="card-header"><div><span><span class="badge bg-light mx-1 text-dark">#fastapi<!-- --> </span></span><span><span class="badge bg-light mx-1 text-dark">#python<!-- --> </span></span><span><span class="badge bg-primary mx-1">#sqlmodel<!-- --> </span></span></div></div><div class="card-body"><h5 class="card-title">fastapi íŠœí† ë¦¬ì–¼ -8.1- SQLModel AsyncSession ê´€ë ¨ íƒ€ì… ë¬¸ì œ ì„ì‹œ í•´ê²° + ì¶”ê°€ ìˆ˜ì •</h5><p class="card-subtitle"><p class="card-text text-muted"><h6><time dateTime="2022-05-07T22:08:12.781+09:00">ì‘ì„±ì¼: 2022ë…„ 5ì›” 7ì¼</time></h6></p></p><p class="card-text">fastapi ì‚¬ìš©ë²•ì„ ë‹¤ì‹œ ê³µë¶€í• ê²¸, ì°¸ê³ í• ë§Œí•œ ì¢‹ì€ ì˜ˆì œê°€ ìˆì–´ì„œ ì´ ì‹œë¦¬ì¦ˆë¥¼ ì•½ê°„ì˜ ë³€ê²½ì„ ì£¼ê³  ë”°ë¼ê°€ë³´ë ¤ í•œë‹¤.</p></div></div><div class="card border border-1 shadow-3 my-3 hover-shadow"><div class="card-header"><div><span><span class="badge bg-light mx-1 text-dark">#python<!-- --> </span></span><span><span class="badge bg-primary mx-1">#sqlmodel<!-- --> </span></span></div></div><div class="card-body"><h5 class="card-title">sqlmodel ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ì‹œ ì£¼ì˜ì‚¬í•­ - validation</h5><p class="card-subtitle"><p class="card-text text-muted"><h6><time dateTime="2022-05-02T18:53:19.408+09:00">ì‘ì„±ì¼: 2022ë…„ 5ì›” 2ì¼</time></h6></p></p><p class="card-text">sqlmodelì—ì„œ ëª¨ë¸ì— table=True ì˜µì…˜ì„ ì£¼ë©´ from_orm, parse_objì—ì„œ validation ê³¼ì •ì„ ì§„í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤.</p></div></div><div class="card border border-1 shadow-3 my-3 hover-shadow"><div class="card-header"><div><span><span class="badge bg-light mx-1 text-dark">#fastapi<!-- --> </span></span><span><span class="badge bg-light mx-1 text-dark">#python<!-- --> </span></span><span><span class="badge bg-primary mx-1">#sqlmodel<!-- --> </span></span></div></div><div class="card-body"><h5 class="card-title">fastapi íŠœí† ë¦¬ì–¼ -3- sql ëª¨ë¸ ì •ì˜</h5><p class="card-subtitle"><p class="card-text text-muted"><h6><time dateTime="2022-04-28T21:51:36.869+09:00">ì‘ì„±ì¼: 2022ë…„ 4ì›” 28ì¼</time></h6></p></p><p class="card-text">fastapi ì‚¬ìš©ë²•ì„ ë‹¤ì‹œ ê³µë¶€í• ê²¸, ì°¸ê³ í• ë§Œí•œ ì¢‹ì€ ì˜ˆì œê°€ ìˆì–´ì„œ ì´ ì‹œë¦¬ì¦ˆë¥¼ ì•½ê°„ì˜ ë³€ê²½ì„ ì£¼ê³  ë”°ë¼ê°€ë³´ë ¤ í•œë‹¤.</p></div></div><div class="card border border-1 shadow-3 my-3 hover-shadow"><div class="card-header"><div><span><span class="badge bg-light mx-1 text-dark">#crud<!-- --> </span></span><span><span class="badge bg-light mx-1 text-dark">#fastapi<!-- --> </span></span><span><span class="badge bg-light mx-1 text-dark">#python<!-- --> </span></span><span><span class="badge bg-primary mx-1">#sqlmodel<!-- --> </span></span></div></div><div class="card-body"><h5 class="card-title">FastAPI, sqlmodelë¡œ ê°„ë‹¨í•œ crud api ìƒì„± 4</h5><p class="card-subtitle"><p class="card-text text-muted"><h6><time dateTime="2021-11-27T00:28:51.285+09:00">ì‘ì„±ì¼: 2021ë…„ 11ì›” 27ì¼</time></h6></p></p><p class="card-text">ì´ì œ ê¸°ì¡´ì— ì‘ì„±í•œ crud apië¥¼ ë³´ì™„í•´ë³´ê² ìŠµë‹ˆë‹¤.</p></div></div></div></div><div class="row"><ul class="pagination justify-content-center"><li class="page-item disabled"><a class="page-link" href="/posts/@tag/sqlmodel/1"><i class="fa fa-angle-double-left"></i></a></li><li class="page-item disabled"><a class="page-link" href="/posts/@tag/sqlmodel/0"><i class="fa fa-angle-left"></i></a></li><li class="page-item active"><a class="page-link">1</a></li><li class="page-item" href="/posts/@tag/sqlmodel/2"><a class="page-link">2</a></li><li class="page-item disabled"><a class="page-link" href="/posts/@tag/sqlmodel/6"><i class="fa fa-angle-right"></i></a></li><li class="page-item"><a class="page-link" href="/posts/@tag/sqlmodel/2"><i class="fa fa-angle-double-right"></i></a></li></ul></div></div></main><footer class="text-center text-muted"></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"tag":"sqlmodel","page":1,"max_page":2,"tag_counter":[["@all",25],["python",21],["fastapi",14],["sqlmodel",8],["fastapi-users",4],["crud",4],["returns",3],["í•¨ìˆ˜í˜• í”„ë¡œê·¸ë˜ë°",3],["windows",3],["wsl",3],["tdd",2],["anyio",2],["async",2],["vim",1],["js",1],["ts",1],["nextjs",1],["velog",1],["github",1],["restful",1],["pytest",1],["alembic",1],["postgres",1],["black",1],["isort",1],["vscode",1],["asyncio",1],["trio",1]],"posts":[{"name":"fastapi íŠœí† ë¦¬ì–¼ -8.2- FastAPI Users v10 ëŒ€ì‘","content":"\n**`fastapi`** ì‚¬ìš©ë²•ì„ ë‹¤ì‹œ ê³µë¶€í• ê²¸, ì°¸ê³ í• ë§Œí•œ ì¢‹ì€ [ì˜ˆì œ](https://www.jeffastor.com/blog/populating-cleaning-jobs-with-user-offers-in-fastapi)ê°€ ìˆì–´ì„œ ì´ ì‹œë¦¬ì¦ˆë¥¼ ì•½ê°„ì˜ ë³€ê²½ì„ ì£¼ê³  ë”°ë¼ê°€ë³´ë ¤ í•œë‹¤.\nì§€ë‚œë²ˆì²˜ëŸ¼ ì–´ì©Œë‹¤ ê·¸ë§Œë‘˜ ìˆ˜ë„ ìˆê¸´ í•˜ì§€ë§Œ...\n\n---\n\n## `Breaking` `changes`\n\nì´í‹€ì „ **`fastapi-users`** ì— í° ë³€í™”ê°€ ìƒê²¼ë‹¤. `v10` ë¦´ë¦¬ì¦ˆê°€ ê³µê°œëëŠ”ë°, `db` ëª¨ë¸ê³¼ ì—¬ëŸ¬ ì œë„¤ë¦­ íƒ€ì…ì— ëŒ€í•œ ë³€í™”ê°€ ìƒê²¨ì„œ, `v10`ì„ ì´ìš©í•˜ë ¤ë©´ ëŒ€ì‘ íŒ¨ì¹˜ê°€ í•„ìˆ˜ì ì¸ ìƒí™©..\n\nì•„ë˜ëŠ” í•´ë‹¹ ë¦´ë¦¬ì¦ˆì— ëŒ€í•œ ì „ë¬¸ì´ë‹¤.\n\n\u003e ### [Breaking changes](https://github.com/fastapi-users/fastapi-users/releases/tag/v10.0.0)\n\u003e\n\u003e Version 10 marks important changes in how we manage User models and their ID.\n\u003e\n\u003e Before, we were relying only on Pydantic models to work with users. In particular the current_user dependency would return you an instance of UserDB, a Pydantic model. This proved to be quite problematic with some ORM if you ever needed to retrieve relationship data or make specific requests.\n\u003e\n\u003e Now, FastAPI Users is designed to always return you a native object for your ORM model, whether it's an SQLAlchemy model or a Beanie document. Pydantic models are now only used for validation and serialization inside the API.\n\u003e\n\u003e Before, we were forcing the use of UUID as primary key ID; a consequence of the design above. This proved to be quite problematic on some databases, like MongoDB which uses a special ObjectID format by default. Some SQL folks also prefer to use traditional auto-increment integers.\n\u003e\n\u003e Now, FastAPI Users is designed to use generic ID type. It means that you can use any type you want for your user's ID. By default, SQLAlchemy adapter still use UUID; but you can quite easily switch to another thing, like an integer. Beanie adapter for MongoDB will use native ObjectID by default, but it also can be overriden.\n\n### ìœ ì € ëª¨ë¸ ìƒì„± ë° ìˆ˜ì •\n\nê¸°ì¡´ `fastapi_users.models` ì—ì„œ `fastapi_users.schemas`ë¡œ ë°”ë€ ê²ƒ ì™¸ì— í¬ê²Œ ë‹¬ë¼ì§„ ê²ƒì€ ì—†ë‹¤. ì‚¬ì‹¤ ì´ì „ì— ì–˜ê¸°í–ˆë˜ `user` ì™€ `user_model`ì„ í†µí•©í•˜ëŠ” ì‘ì—…ì„ ì´ë¯¸ í•œ ë‹¤ìŒ `v10` ë¦´ë¦¬ì¦ˆë¥¼ í™•ì¸í–ˆê¸°ì— ë”ìš± ê·¸ë ‡ê²Œ ëŠê»´ì¡Œë‹¤...\n\n```python\n# backend/app/models/user.py\nfrom typing import TypeVar\n\nfrom fastapi_users import schemas\nfrom pydantic import EmailStr\nfrom pydantic import Field as _Field\nfrom sqlmodel import Field, select\n\nfrom ..db.session import async_session\nfrom .core import base_model, datetime_model, uuid_id_model\n\nmin_name_length = 4\nmax_name_length = 20\n\n\n_T = TypeVar(\"_T\", bound=\"user\")\nid_model = uuid_id_model\nuser_id_type = id_model.id_type\n\n\nclass user(id_model, datetime_model, base_model, table=True):\n    __tablename__: str = \"users\"\n\n    name: str = Field(min_length=min_name_length, max_length=max_name_length)\n    hashed_password: str = Field(max_length=2**10)\n    email: EmailStr = Field(index=True)\n    is_active: bool = True\n    is_superuser: bool = False\n    is_verified: bool = False\n\n    @classmethod\n    async def get_from_email(\n        cls: type[_T], session: async_session, email: str\n    ) -\u003e _T | None:\n        is_user_cur = await session.exec(select(cls).where(cls.email == email))\n        return is_user_cur.first()\n\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n        self.validate(self)\n\n\nclass user_read(schemas.BaseUser[user_id_type], datetime_model):\n    name: str = _Field(min_length=min_name_length, max_length=max_name_length)\n\n\nclass user_create(schemas.BaseUserCreate):\n    name: str = _Field(min_length=min_name_length, max_length=max_name_length)\n\n\nclass user_update(schemas.BaseUserUpdate):\n    name: str = _Field(min_length=min_name_length, max_length=max_name_length)\n```\n\n### ì¸ì¦ ëª¨ë“ˆ ì œë„¤ë¦­ íƒ€ì… ë®ì–´ì”Œìš°ê¸°\n\n**`fastapi-users`** ì—ì„œ ì›í•˜ëŠ” í˜•íƒœëŠ” `SQLAlchemyBaseUserTable`ë¥¼ ìƒì†í•œ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ì§€ë§Œ, **`sqlmodel`** ë„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³  **`fastapi-users`** ì˜ íƒ€ì… íŒíŠ¸ë„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³  ì‹¶ê¸°ì—, ë‘ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì—®ì–´ì¤„ ìƒˆë¡œìš´ ì œë„¤ë¦­ í´ë˜ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.\n`# type: ignore`ë¥¼ ë‚¨ë°œí•˜ê¸°ì— ê·¸ë‹¤ì§€ ì¢‹ì€ ëª¨ìŠµì´ë¼ê³  ìƒê°ë˜ì§€ ì•Šì§€ë§Œ, ì´ê±° ì™¸ì— ë‹¹ì¥ ìƒê°ë‚˜ëŠ” ë°©ë²•ì´ ì—†ê¸°ì— ì¼ë‹¨ ë„˜ì–´ê°€ì.\n\n```bash\nâ¯ mkdir backend/app/services/authentication\nâ¯ mv backend/app/services/authentication.py backend/app/services/authentication/authentication.py\nâ¯ touch backend/app/services/authentication/__init__.py backend/app/services/authentication/convert.py\n```\n\n```python\n# backend/app/services/authentication/__init__.py\nfrom .authentication import *\n```\n\n```python\n# backend/app/services/authentication/convert.py\nfrom typing import Generic, TypeVar\n\nfrom fastapi_users import BaseUserManager, FastAPIUsers\nfrom fastapi_users.authentication import AuthenticationBackend, JWTStrategy, Strategy\nfrom fastapi_users.db import SQLAlchemyUserDatabase\n\nfrom ...models.core import base_model\nfrom ...models.user import user\n\nuser_id_type = user.id_type\n_T = TypeVar(\"_T\", bound=base_model)\n_D = TypeVar(\"_D\")\n\n# fmt: off\nclass user_db_class(SQLAlchemyUserDatabase[_T, _D], Generic[_T, _D]): ... # type: ignore\nclass strategy_class(Strategy[_T, _D], Generic[_T, _D]): ... # type: ignore\nclass jwt_strategy_class(JWTStrategy[_T, _D], Generic[_T, _D]): ... # type: ignore\nclass auth_backend_class(AuthenticationBackend[_T, _D], Generic[_T, _D]): ... # type: ignore\nclass user_manager_class(BaseUserManager[_T, _D], Generic[_T, _D]): ...  # type: ignore\nclass fastapi_users_class(FastAPIUsers[_T, _D], Generic[_T, _D]): ...  # type: ignore\n# fmt: on\n\n\nuser_manager_type = user_manager_class[user, user_id_type]\nstrategy_type = strategy_class[user, user_id_type]\n```\n\n### ë³€ê²½ì  ì¸ì¦ ëª¨ë“ˆì— ì ìš©\n\n```python\n# backend/app/services/authentication/authentication.py\nimport re\nfrom dataclasses import dataclass\nfrom re import Pattern\nfrom typing import AsyncGenerator, Sequence\n\nfrom fastapi import Depends, Request\nfrom fastapi_users import IntegerIDMixin, InvalidPasswordException\nfrom fastapi_users.authentication import BearerTransport, Transport\n\nfrom ...core import config\nfrom ...db.session import async_session, get_session\nfrom ...models import user\nfrom .convert import (\n    auth_backend_class,\n    fastapi_users_class,\n    jwt_strategy_class,\n    strategy_class,\n    strategy_type,\n    user_db_class,\n    user_id_type,\n    user_manager_class,\n    user_manager_type,\n)\n\n\nasync def get_user_db(\n    session: async_session = Depends(get_session),\n) -\u003e AsyncGenerator[user_db_class[user.user, user_id_type], None]:\n    yield user_db_class(session, user.user)\n\n\ndef create_transport() -\u003e Transport:\n    return BearerTransport(tokenUrl=config.TOKEN_PREFIX)\n\n\ndef create_strategy() -\u003e strategy_class[user.user, user_id_type]:\n    return jwt_strategy_class(  # type: ignore\n        secret=str(config.SECRET_KEY),\n        lifetime_seconds=config.ACCESS_TOKEN_EXPIRE_SECONDS,\n        token_audience=[config.JWT_AUDIENCE],\n        algorithm=config.JWT_ALGORITHM,\n    )\n\n\ndef create_backend() -\u003e list[auth_backend_class[user.user, user_id_type]]:\n    transport = create_transport()\n    return [\n        auth_backend_class(\n            name=config.AUTH_BACKEND_NAME,\n            transport=transport,\n            get_strategy=create_strategy,\n        )\n    ]\n\n\nclass UserManager(IntegerIDMixin, user_manager_class[user.user, user_id_type]):\n    reset_password_token_secret = str(config.SECRET_KEY)\n    verification_token_secret = str(config.SECRET_KEY)\n\n    min_password_length: int = 10\n    max_password_length: int = 30\n    re_password_need_list: list[Pattern] = [\n        re.compile(r\"[a-zA-Z]\"),\n        re.compile(r\"[0-9]\"),\n        re.compile(r\"[\\{\\}\\[\\]\\/?.,;:|\\)*~`!^\\-_+\u003c\u003e@\\#$%\u0026\\\\\\=\\(\\'\\\"]\"),\n    ]\n    re_password_deny_list: list[Pattern] = []\n\n    async def validate_password(\n        self, password: str, user: user.user_create | user.user\n    ) -\u003e None:\n        if len(password) \u003c self.min_password_length:\n            raise InvalidPasswordException(\n                reason=f\"Password should be at least {self.min_password_length} characters\"\n            )\n        elif len(password) \u003e self.max_password_length:\n            raise InvalidPasswordException(\n                reason=f\"Password should be at most {self.max_password_length} characters\"\n            )\n\n        for pattern in self.re_password_deny_list:\n            if pattern.search(password):\n                raise InvalidPasswordException(\n                    reason=f\"Password should not include {pattern.pattern}\"\n                )\n\n        for pattern in self.re_password_need_list:\n            if not pattern.search(password):\n                raise InvalidPasswordException(\n                    reason=f\"Password must include {pattern.pattern}\"\n                )\n\n    async def on_after_register(self, user: user.user, request: Request | None = None):\n        print(f\"User {user.id} has registered.\")\n\n    async def on_after_forgot_password(\n        self, user: user.user, token: str, request: Request | None = None\n    ):\n        print(f\"User {user.id} has forgot their password. Reset token: {token}\")\n\n    async def on_after_request_verify(\n        self, user: user.user, token: str, request: Request | None = None\n    ):\n        print(f\"Verification requested for user {user.id}. Verification token: {token}\")\n\n\nasync def get_user_manager(\n    user_db=Depends(get_user_db),\n) -\u003e AsyncGenerator[UserManager, None]:\n    yield UserManager(user_db)\n\n\ndef create_fastapi_users(\n    *backends: auth_backend_class[user.user, user_id_type],\n) -\u003e fastapi_users_class[user.user, user_id_type]:\n    return fastapi_users_class(\n        get_user_manager=get_user_manager, auth_backends=backends\n    )\n\n\n@dataclass(frozen=True)\nclass fastapi_user_class:\n    users: fastapi_users_class[user.user, user_id_type]\n\n    @classmethod\n    def init(cls) -\u003e \"fastapi_user_class\":\n        users = create_fastapi_users(*create_backend())\n        return cls(users=users)\n\n    @property\n    def backends(self) -\u003e Sequence[auth_backend_class[user.user, user_id_type]]:\n        return self.users.authenticator.backends  # type: ignore\n\n    @property\n    def user_manager_depends(self) -\u003e user_manager_type:\n        return Depends(self.users.get_user_manager)\n\n    def strategy_depends(self, num: int = 0, /) -\u003e strategy_type:\n        backend = self.backends[num]\n        return Depends(backend.get_strategy)\n```\n\nê½¤ ë§ì´ ë°”ë€Œê¸´ í–ˆì§€ë§Œ, ì‹¤ì œë¡œ ì‚¬ìš©í• ë•ŒëŠ” ì´ë¦„ì •ë„ë§Œ ë°”ë€Œì§€ ì‚¬ìš©ë²• ìì²´ëŠ” ë³€í•œê²Œ ì—†ë‹¤. ë°”ë€ ì´ë¦„ì— ë§ì¶°ì„œ ë¼ìš°í„°ì™€ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì£¼ë©´, ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\nì´ë²ˆ ê¸°íšŒì— í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì–¼ë§ˆë‚˜ ì¢‹ì€ê±´ì§€ ì•Œê²Œëë‹¤.. ê¸´ê°€ë¯¼ê°€í• ë•Œ `pytest --tb=short` í•œë°©ì´ë©´ ì˜ë¬¸ì´ í•´ê²°ëœë‹¤.\n\nì‚¬ì‹¤ ë³€ê²½í• ê²Œ í•˜ë‚˜ ë” ë‚¨ê¸´ í–ˆì§€ë§Œ, ì´ê±° ì•„ì§ ì‹œë„í•´ë³´ì§€ ì•Šì•˜ë‹¤.\ní˜„ì¬ í—¤ë”ë¥¼ ì‚¬ìš©í•œ ì¸ì¦ ë°©ì‹ì¸ë°, ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ê³ , `access-token`ê³¼ `refresh-token`ì„ ì‚¬ìš©í•œ ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•´ë³´ë ¤ í•œë‹¤. ë‹¤ë§Œ **`fastapi-users`** ìì²´ì ìœ¼ë¡œëŠ” ì§€ì›í•˜ì§€ ì•Šê¸°ì—, ì§ì ‘ ì‘ì„±í•  í•„ìš”ê°€ ìˆì–´ì„œ ì•½ê°„ ê³ ë¯¼ì´ í•„ìš”í• ë“¯.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/fastapi íŠœí† ë¦¬ì–¼ -8.2- FastAPI Users v10 ëŒ€ì‘","data":{"title":"fastapi íŠœí† ë¦¬ì–¼ -8.2- FastAPI Users v10 ëŒ€ì‘","date":"2022-05-07T23:00:58.369+09:00","tags":["fastapi","fastapi-users","python","sqlmodel","@all"],"page":"fastapi íŠœí† ë¦¬ì–¼","summary":"fastapi ì‚¬ìš©ë²•ì„ ë‹¤ì‹œ ê³µë¶€í• ê²¸, ì°¸ê³ í• ë§Œí•œ ì¢‹ì€ ì˜ˆì œê°€ ìˆì–´ì„œ ì´ ì‹œë¦¬ì¦ˆë¥¼ ì•½ê°„ì˜ ë³€ê²½ì„ ì£¼ê³  ë”°ë¼ê°€ë³´ë ¤ í•œë‹¤."}},{"name":"fastapi íŠœí† ë¦¬ì–¼ -8.1- SQLModel AsyncSession ê´€ë ¨ íƒ€ì… ë¬¸ì œ ì„ì‹œ í•´ê²° + ì¶”ê°€ ìˆ˜ì •","content":"\n**`fastapi`** ì‚¬ìš©ë²•ì„ ë‹¤ì‹œ ê³µë¶€í• ê²¸, ì°¸ê³ í• ë§Œí•œ ì¢‹ì€ [ì˜ˆì œ](https://www.jeffastor.com/blog/populating-cleaning-jobs-with-user-offers-in-fastapi)ê°€ ìˆì–´ì„œ ì´ ì‹œë¦¬ì¦ˆë¥¼ ì•½ê°„ì˜ ë³€ê²½ì„ ì£¼ê³  ë”°ë¼ê°€ë³´ë ¤ í•œë‹¤.\nì§€ë‚œë²ˆì²˜ëŸ¼ ì–´ì©Œë‹¤ ê·¸ë§Œë‘˜ ìˆ˜ë„ ìˆê¸´ í•˜ì§€ë§Œ...\n\n---\n\n## `Session`ì˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ë³µë¶™\n\nì´ì „ê¹Œì§€ ê¸€ì—ì„œ ê³„ì†í•´ì„œ `AsyncSession`ì˜ íƒ€ì… ê´€ë ¨ ë¬¸ì œê°€ ë°œìƒí•˜ëŠ”ê²Œ ë„ˆë¬´ ì§œì¦ë‚˜ì„œ, ì„ì‹œë¡œ ë•œë¹µìš© í´ë˜ìŠ¤ë¥¼ ìƒì„±í•´ì„œ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆë‹¤.\n\n````python\n# backend/app/db/session.py\n(...)\n\n_TSelectParam = TypeVar(\"_TSelectParam\")\n\nclass async_session(AsyncSession):\n    # sqlmodel.orm.session.Session\n    @overload\n    async def exec(\n        self,\n        statement: Select[_TSelectParam],\n        *,\n        params: Optional[Union[Mapping[str, Any], Sequence[Mapping[str, Any]]]] = None,\n        execution_options: Mapping[str, Any] = util.EMPTY_DICT,\n        bind_arguments: Optional[Mapping[str, Any]] = None,\n        _parent_execute_state: Optional[Any] = None,\n        _add_event: Optional[Any] = None,\n        **kw: Any,\n    ) -\u003e Result[_TSelectParam]:\n        ...\n\n    @overload\n    async def exec(\n        self,\n        statement: SelectOfScalar[_TSelectParam],\n        *,\n        params: Optional[Union[Mapping[str, Any], Sequence[Mapping[str, Any]]]] = None,\n        execution_options: Mapping[str, Any] = util.EMPTY_DICT,\n        bind_arguments: Optional[Mapping[str, Any]] = None,\n        _parent_execute_state: Optional[Any] = None,\n        _add_event: Optional[Any] = None,\n        **kw: Any,\n    ) -\u003e ScalarResult[_TSelectParam]:\n        ...\n\n    async def exec(\n        self,\n        statement: Union[\n            Select[_TSelectParam],\n            SelectOfScalar[_TSelectParam],\n            Executable[_TSelectParam],\n        ],\n        *,\n        params: Optional[Union[Mapping[str, Any], Sequence[Mapping[str, Any]]]] = None,\n        execution_options: Mapping[str, Any] = util.EMPTY_DICT,\n        bind_arguments: Optional[Mapping[str, Any]] = None,\n        _parent_execute_state: Optional[Any] = None,\n        _add_event: Optional[Any] = None,\n        **kw: Any,\n    ) -\u003e Union[Result[_TSelectParam], ScalarResult[_TSelectParam]]:\n        \"\"\"\n        sqlmodel.orm.session.Session\n        \"\"\"\n        return await super().exec(\n            statement,  # type: ignore\n            params=params,\n            execution_options=execution_options,\n            bind_arguments=bind_arguments,\n            _parent_execute_state=_parent_execute_state,\n            _add_event=_add_event,\n            **kw,\n        )\n\n    async def execute(\n        self,\n        statement: _Executable,\n        params: Optional[Union[Mapping[str, Any], Sequence[Mapping[str, Any]]]] = None,\n        execution_options: Optional[Mapping[str, Any]] = util.EMPTY_DICT,\n        bind_arguments: Optional[Mapping[str, Any]] = None,\n        _parent_execute_state: Optional[Any] = None,\n        _add_event: Optional[Any] = None,\n        **kw: Any,\n    ) -\u003e Result[Any]:\n        \"\"\"\n        sqlmodel.orm.session.Session\n        ***\n\n        ğŸš¨ You probably want to use `session.exec()` instead of `session.execute()`.\n\n        This is the original SQLAlchemy `session.execute()` method that returns objects\n        of type `Row`, and that you have to call `scalars()` to get the model objects.\n\n        For example:\n\n        ```Python\n        heroes = session.execute(select(Hero)).scalars().all()\n        ```\n\n        instead you could use `exec()`:\n\n        ```Python\n        heroes = session.exec(select(Hero)).all()\n        ```\n        \"\"\"\n        return await super().execute(  # type: ignore\n            statement,\n            params=params,\n            execution_options=execution_options,\n            bind_arguments=bind_arguments,\n            _parent_execute_state=_parent_execute_state,\n            _add_event=_add_event,\n            **kw,\n        )\n\n    async def get(\n        self,\n        entity: Type[_TSelectParam],\n        ident: Any,\n        options: Optional[Sequence[Any]] = None,\n        populate_existing: bool = False,\n        with_for_update: Optional[Union[Literal[True], Mapping[str, Any]]] = None,\n        identity_token: Optional[Any] = None,\n    ) -\u003e Optional[_TSelectParam]:\n        \"\"\"\n        sqlmodel.orm.session.Session\n        \"\"\"\n        return await super().get(\n            entity,\n            ident,\n            options=options,\n            populate_existing=populate_existing,\n            with_for_update=with_for_update,\n            identity_token=identity_token,\n        )\n````\n\nì£¼ì„ì„ ë³´ë©´ ì•Œê² ì§€ë§Œ, ê·¸ëƒ¥ `sqlmodel.orm.session.Session` ê°ì²´ì˜ ê° ë©”ì†Œë“œì˜ íƒ€ì… íŒíŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ì™”ë‹¤. ì´ì— ë§ì¶°ì„œ ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì˜ `AsyncSession`ë„ ëª¨ë‘ `async_session`ì— ëŒ€í•œ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë³€í™˜í•´ì¤€ë‹¤. ê·¸ë¦¬ê³  í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•´ë³´ë©´ ë¬¸ì œì—†ì´ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.\n\n---\n\n## `datetime_model` ê´€ë ¨ ë¬¸ì œ í•´ê²°\n\n`datetime_model`ì˜ `datetime_attrs` ì†ì„±ì´ ì˜ë„í•œëŒ€ë¡œ ì¶œë ¤ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ìˆì–´ì„œ ì¶”ê°€ë¡œ ìˆ˜ì •í–ˆë‹¤. `cls.__fields__.keys()` ë¥¼ `datetime_model.__fields__.keys()`ë¡œ ìˆ˜ì •í•œ ê²ƒì™¸ì— ëª¨ë‘ ë™ì¼í•˜ë‹¤.\n\n```python\n# backend/app/models/core.py\n(...)\n\nclass datetime_model(fix_return_type_model):\n    created_at: datetime = Field(default_factory=datetime.now)\n    updated_at: datetime = Field(default_factory=datetime.now)\n\n    def update(self: _D) -\u003e _D:\n        self.updated_at = datetime.now()\n        return self\n\n    @classmethod\n    @property\n    def datetime_attrs(cls) -\u003e set[str]:\n        return set(datetime_model.__fields__.keys())\n```\n\n## `id_model` ì„¸ë¶„í™”\n\nê¸°ì¡´ì— ì‚¬ìš©í•˜ë˜ `id_model`ì„ `int_id_model`ê³¼ `uuid_id_model`ë¡œ ì„¸ë¶„í™”í•´ì„œ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆë‹¤.\n\n```python\n# backend/app/models/core.py\nfrom uuid import uuid4\nfrom pydantic import UUID4\n\n(...)\n\nclass id_model(fix_return_type_model):\n    @classmethod\n    @property\n    def id_type(cls) -\u003e Any:\n        return cls.__fields__[\"id\"].type_\n\n\nclass int_id_model(id_model):\n    id: int | None = Field(None, primary_key=True)\n\n\nclass uuid_id_model(id_model):\n    id: UUID4 | None = Field(default_factory=uuid4, primary_key=True)\n```\n\n## `dependencies` ëª¨ë“ˆ ìƒì„±\n\nê¸°ì¡´ì— ì‚¬ìš©í•˜ë˜ `get_session`ì´ë‚˜ `get_current_user`ê°™ì€ `Depends`ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ë˜ í•¨ìˆ˜ë¥¼ ë”°ë¡œ ê´€ë¦¬í•˜ê¸°ë¡œ í–ˆë‹¤.\n\n```python\n# backend/app/dependencies/database.py\nfrom typing import AsyncIterator\n\nfrom fastapi import Depends, Request\nfrom sqlalchemy.ext.asyncio.engine import AsyncEngine\n\nfrom ..db.session import async_session\n\n\nasync def get_database(request: Request) -\u003e AsyncEngine:\n    if (engine := getattr(request.app.state, \"_db\", None)) is None:\n        raise AttributeError(\"there is no database engine in request as state\")\n    return engine\n\n\nasync def get_session(\n    engine: AsyncEngine = Depends(get_database),\n) -\u003e AsyncIterator[async_session]:\n    async with async_session(engine, autoflush=False, autocommit=False) as session:\n        yield session\n```\n\n```python\n# backend/app/dependencies/auth.py\nfrom ..services.authentication import fastapi_user_class\n\nfastapi_user = fastapi_user_class.init()\n\nget_current_user = fastapi_user.users.current_user(\n    optional=False, active=True, verified=False, superuser=False\n)\nget_user_manager = fastapi_user.get_user_manager\nget_backend = fastapi_user.get_backend\nget_transport = fastapi_user.get_transport\nget_strategy = fastapi_user.get_strategy\n```\n\n```python\n# backend/app/services/authentication/authentication.py\n(...)\n\n@dataclass(frozen=True)\nclass fastapi_user_class:\n    users: fastapi_users_class[user.user, user_id_type]\n    named_backends: dict[str, auth_backend_type] = field(default_factory=dict)\n\n    @classmethod\n    def init(cls) -\u003e \"fastapi_user_class\":\n        users = create_fastapi_users(*create_backend())\n        return cls(users=users)\n\n    @property\n    def backends(self) -\u003e Sequence[auth_backend_type]:\n        return self.users.authenticator.backends  # type: ignore\n\n    @property\n    def get_user_manager(self):\n        return self.users.get_user_manager\n\n    def find_backend(self, _val: str, /) -\u003e auth_backend_type:\n        for backend in self.backends:\n            if backend.name == _val:\n                return backend\n        raise IndexError(f\"there is not auth_backend name: {_val}\")\n\n    def get_backend(self, _val: int | str = 0, /) -\u003e auth_backend_type:\n        if isinstance(_val, int):\n            return self.backends[_val]\n\n        if (backend := self.named_backends.get(_val)) is None:\n            backend = self.named_backends[_val] = self.find_backend(_val)\n        return backend\n\n    def get_transport(self, _val: int | str = 0, /) -\u003e Transport:\n        backend = self.get_backend(_val)\n        return backend.transport\n\n    def get_strategy(self, _val: int | str = 0, /):\n        backend = self.get_backend(_val)\n        return backend.get_strategy\n```\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/fastapi íŠœí† ë¦¬ì–¼ -8.1- SQLModel AsyncSession ê´€ë ¨ íƒ€ì… ë¬¸ì œ ì„ì‹œ í•´ê²° + ì¶”ê°€ ìˆ˜ì •","data":{"title":"fastapi íŠœí† ë¦¬ì–¼ -8.1- SQLModel AsyncSession ê´€ë ¨ íƒ€ì… ë¬¸ì œ ì„ì‹œ í•´ê²° + ì¶”ê°€ ìˆ˜ì •","date":"2022-05-07T22:08:12.781+09:00","tags":["fastapi","python","sqlmodel","@all"],"page":"fastapi íŠœí† ë¦¬ì–¼","summary":"fastapi ì‚¬ìš©ë²•ì„ ë‹¤ì‹œ ê³µë¶€í• ê²¸, ì°¸ê³ í• ë§Œí•œ ì¢‹ì€ ì˜ˆì œê°€ ìˆì–´ì„œ ì´ ì‹œë¦¬ì¦ˆë¥¼ ì•½ê°„ì˜ ë³€ê²½ì„ ì£¼ê³  ë”°ë¼ê°€ë³´ë ¤ í•œë‹¤."}},{"name":"sqlmodel ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ì‹œ ì£¼ì˜ì‚¬í•­ - validation","content":"`sqlmodel`ì€ `fastapi`ì˜ ê°œë°œì `tiangolo`ì˜ ì£¼ë„ í•˜ì— ê°œë°œì´ ì§„í–‰ì¤‘ì¸ `sql`ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤. `pydantic`ì˜ ëª¨ë¸ê³¼ `sqlalchemy`ì˜ í…Œì´ë¸”ì„ í•œë²ˆì˜ ì •ì˜ë¡œ ê°™ì´ ì“¸ ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆì–´ì„œ, ë‹¤ì†Œ ë¶ˆì•ˆì •í•œ ë¶€ë¶„ì´ ìˆë”ë¼ë„ ì¢…ì¢… ì“°ê³  ìˆìŠµë‹ˆë‹¤.\n\nê·¸ëŸ°ë° ìµœê·¼ ì•„ì£¼ ë¬´ì„œìš´ ì¼ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.. `sqlmodel`ë¡œ ì •ì˜í•œ ëª¨ë¸ì— `table=True`ì˜µì…˜ì„ ì£¼ë©´ `pydantic`ì—ì„œ ìë‘í•˜ëŠ” ê²€ì¦ ê³¼ì •ì´ ì „í˜€ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì‚¬ì‹¤ì„..\n\n`from_orm`, `parse_obj` ì´ ë‘ ë©”ì†Œë“œ ëª¨ë‘ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ì§€ ì•Šìœ¼ë‹ˆ, `validate` ë©”ì†Œë“œë¥¼ ì´ìš©í•´ì„œ ë ˆì½”ë“œë¥¼ ìƒì„±í•˜ë©´ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/sqlmodel ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ì‹œ ì£¼ì˜ì‚¬í•­ - validation","data":{"title":"sqlmodel ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ì‹œ ì£¼ì˜ì‚¬í•­ - validation","date":"2022-05-02T18:53:19.408+09:00","tags":["python","sqlmodel","@all"],"page":null,"summary":"sqlmodelì—ì„œ ëª¨ë¸ì— table=True ì˜µì…˜ì„ ì£¼ë©´ from_orm, parse_objì—ì„œ validation ê³¼ì •ì„ ì§„í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤."}},{"name":"fastapi íŠœí† ë¦¬ì–¼ -3- sql ëª¨ë¸ ì •ì˜","content":"\n**`fastapi`** ì‚¬ìš©ë²•ì„ ë‹¤ì‹œ ê³µë¶€í• ê²¸, ì°¸ê³ í• ë§Œí•œ ì¢‹ì€ [ì˜ˆì œ](https://www.jeffastor.com/blog/populating-cleaning-jobs-with-user-offers-in-fastapi)ê°€ ìˆì–´ì„œ ì´ ì‹œë¦¬ì¦ˆë¥¼ ì•½ê°„ì˜ ë³€ê²½ì„ ì£¼ê³  ë”°ë¼ê°€ë³´ë ¤ í•œë‹¤.\nì§€ë‚œë²ˆì²˜ëŸ¼ ì–´ì©Œë‹¤ ê·¸ë§Œë‘˜ ìˆ˜ë„ ìˆê¸´ í•˜ì§€ë§Œ...\n\n---\n\n## **cleanings** ëª¨ë¸ ìƒì„±\n\n### ëª¨ë¸ ì •ì˜\n\nì‘ì„± ì „ ë¯¸ë¦¬ ì „ë°˜ì ì¸ ë‚´ìš©ì„ í›‘ì–´ë³´ë‹ˆ, `repository`ëŠ” **`sqlmodel`** ì‚¬ìš©ì‹œ ë”±íˆ ì˜ë¯¸ê°€ ì—†ëŠ” ëª¨ë“ˆì´ë¯€ë¡œ ì œê±°í•˜ì.\në˜í•œ, ì§€ë‚œ ê¸€ì—ì„œ ì„ì‹œë¡œ ìƒì„±í•œ `models`ì˜ ìœ„ì¹˜ê°€ `db`ì˜ í•˜ìœ„ ëª¨ë“ˆì´ ì•„ë‹Œ `app`ì˜ í•˜ìœ„ ëª¨ë“ˆë¡œ ê²°ì •ëê¸°ì— ê°™ì´ ìˆ˜ì •í•œë‹¤.\n\n```bash\nâ¯ rm -rf backend/app/db/repositories\nâ¯ mv backend/app/db/models backend/app/models\nâ¯ touch backend/app/models/__init__.py\nâ¯ mv backend/app/models/base.py backend/app/models/core.py\nâ¯ mv backend/app/models/temp.py backend/app/models/cleaning.py\n```\n\n```python\n# backend/app/models/core.py\nfrom typing import Any, TypeVar, cast\n\nfrom sqlmodel import Field, SQLModel, Table\n\n_T = TypeVar(\"_T\", bound=SQLModel)\n\n\nclass fix_parse_obj_model(SQLModel):\n    \"\"\"\n    sqlmodelì—ì„œ parse_obj ë¦¬í„´ê°’ ì •ìƒì ìœ¼ë¡œ ìˆ˜ì •í•˜ê¸° ì „ê¹Œì§€ ì‚¬ìš©\n    \"\"\"\n    @classmethod\n    def parse_obj(cls: type[_T], obj: Any, update: dict[str, Any] | None = None) -\u003e _T:\n        return cast(_T, super().parse_obj(obj, update))\n\n\nclass base_model(fix_parse_obj_model):\n    @classmethod\n    def get_table(cls) -\u003e Table:\n        if (table := getattr(cls, \"__table__\", None)) is None:\n            raise ValueError(\"not table\")\n        return table\n\n\nclass id_model(fix_parse_obj_model):\n    id: int | None = Field(None, primary_key=True)\n```\n\n```python\n# backend/app/models/cleaning.py\nfrom enum import Enum\n\nfrom pydantic import condecimal\nfrom sqlmodel import Field\n\nfrom .core import base_model, id_model\n\nprice_decimal_type = condecimal(max_digits=10, decimal_places=2)\n\n\nclass cleaning_type_enum(str, Enum):\n    dust_up = \"dust_up\"\n    spot_clean = \"spot_clean\"\n    full_clean = \"full_clean\"\n\n\nclass cleaning_base(base_model):\n    name: str | None = None\n    description: str | None = None\n    cleaning_type: cleaning_type_enum = cleaning_type_enum.spot_clean\n    price: price_decimal_type | None = None\n\n\nclass cleaning_create(cleaning_base):\n    name: str\n    price: price_decimal_type\n\n\nclass cleaning_update(cleaning_base):\n    cleaning_type: cleaning_type_enum | None = None\n\n\nclass cleanings(id_model, cleaning_base, table=True):\n    name: str = Field(index=True)\n    cleaning_type: cleaning_type_enum = Field(\n        cleaning_type_enum.spot_clean,\n        sa_column_kwargs={\"server_default\": cleaning_type_enum.spot_clean},\n    )\n    price: price_decimal_type\n\n\nclass cleaning_public(id_model, cleaning_base):\n    ...\n```\n\n```python\n# backend/app/db/migrations/versions/f721febf752b_create_account_table.py\n(...)\n\ndef create_cleanings_table() -\u003e None:\n    import sys\n    from pathlib import Path\n    sys.path.append(Path(__file__).resolve().parents[4].as_posix())\n    from app.models.cleaning import cleanings\n\n(...)\n```\n\n`get_table` ë©”ì†Œë“œê°€ ì •ì˜ëœ `base_model`ì„ ìƒì†í•˜ëŠ” 5ê°œ ëª¨ë¸ì€ ê° ë¦¬ì†ŒìŠ¤ì— ì‚¬ìš©ë  íŒ¨í„´ì„ ë³´ì—¬ì¤€ë‹¤.\n\n\u003e - `cleaning_base`: ê³µìœ  ì†ì„±\n\u003e - `cleaning_create`: ìƒˆë¡œìš´ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„± ~ **POST**\n\u003e - `cleaning_update`: ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ë¥¼ ìˆ˜ì • ~ **PUT**\n\u003e - `cleaning`: ë°ì´í„°ë² ì´ìŠ¤ì— ì •ì˜ë  í…Œì´ë¸”ì´ì ë ˆì½”ë“œ ~ **GET**, **POST**, **PUT**,...\n\u003e - `cleaning_public`: ë ˆì½”ë“œì— ëŒ€í•œ ë°˜í™˜ í˜•íƒœ ~ **GET**, **POST**, **PUT**,...\n\n### `session` ëª¨ë“ˆ ì •ì˜\n\nì› ì‘ì„±ìì¸ **jeffastor**ëŠ” ì´í›„ `repository` ëª¨ë“ˆì„ ìƒì„±í•˜ì—¬ CRUD ê³¼ì •ì— í•„ìš”í•œ í”„ë¡œì„¸ìŠ¤ë¥¼ êµ¬í˜„í–ˆì§€ë§Œ, **`sqlmodel`** ì„ ì‚¬ìš©í•˜ê¸°ì— ê·¸ëŸ¬í•œ ê³¼ì •ì´ ë”°ë¡œ í•„ìš”í•˜ì§€ ì•Šë‹¤.\nì•±ì—ì„œ ì‚¬ìš©í•  `session`ì— ëŒ€í•´ì„œë§Œ ë”°ë¡œ ì •ì˜í•œë‹¤.\n\n```bash\nâ¯ touch backend/app/db/session.py\n```\n\n```python\n# backend/app/db/session.py\nfrom typing import AsyncIterator\n\nfrom fastapi import Depends, Request\nfrom sqlalchemy.ext.asyncio.engine import AsyncEngine\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\n\nasync def get_database(request: Request) -\u003e AsyncEngine:\n    if (engine := getattr(request.app.state, \"_db\", None)) is None:\n        raise AttributeError(\"there is no database engine in request as state\")\n    return engine\n\n\nasync def get_session(\n    engine: AsyncEngine = Depends(get_database),\n) -\u003e AsyncIterator[AsyncSession]:\n    async with AsyncSession(engine, autoflush=False, autocommit=False) as session:\n        yield session\n```\n\n## `cleanings` ëª¨ë¸ `api` ì˜ˆì‹œ\n\n### `cleanings` ë ˆì½”ë“œ ì¶”ê°€ `POST` `api` ì˜ˆì‹œ\n\nì´ì œ ì„¸ì…˜ì„ í™œìš©í•œ ê°„ë‹¨í•œ í˜•íƒœì˜ **POST** apië¥¼ ìƒì„±í•œë‹¤.\n\n```python\n# backend/app/api/routes/cleanings.py\nfrom fastapi import APIRouter, Body, Depends\nfrom sqlmodel.ext.asyncio.session import AsyncSession\nfrom starlette.status import HTTP_201_CREATED\n\nfrom ...db.session import get_session\nfrom ...models.cleaning import cleaning_create, cleaning_public, cleanings\n\nrouter = APIRouter()\n\n\n@router.get(\"/\")\nasync def get_all_cleanings() -\u003e list[dict]:\n    cleanings = [\n        {\n            \"id\": 1,\n            \"name\": \"My house\",\n            \"cleaning_type\": \"full_clean\",\n            \"price_per_hour\": 29.99,\n        },\n        {\n            \"id\": 2,\n            \"name\": \"Someone else's house\",\n            \"cleaning_type\": \"spot_clean\",\n            \"price_per_hour\": 19.99,\n        },\n    ]\n    return cleanings\n\n\n@router.post(\n    \"/\",\n    response_model=cleaning_public,\n    name=\"cleanings:create-cleaning\",\n    status_code=HTTP_201_CREATED,\n)\nasync def create_new_cleaning(\n    new_cleaning: cleaning_create = Body(..., embed=True),\n    session: AsyncSession = Depends(get_session),\n) -\u003e cleanings:\n    # data = cleanings.from_orm(new_cleaning) ìœ¼ë¡œ í•´ë„ ê°€ëŠ¥\n    # exclude_none=True, exclude_unset=True ì˜µì…˜ì„ ìœ„í•´ parse_obj ì‚¬ìš©\n    data = cleanings.parse_obj(\n        new_cleaning.dict(\n            exclude_none=True,\n            exclude_unset=True,\n        )\n    )\n    session.add(data)\n    await session.flush()\n    await session.commit()\n    await session.refresh(data)\n\n    return data\n```\n\nì´ì œ **`docker`** ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê³ , [http://localhost:8000/docs](http://localhost:8000/docs)ì—ì„œ ìƒì„±í•œ **POST** apiê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.\n\n`body`ì— ê°’ì„\n\n```yaml\n{\n  'new_cleaning':\n    { 'name': 'string', 'description': 'string', 'cleaning_type': 'asd', 'price': 0 },\n}\n```\n\nì´ë ‡ê²Œ ì£¼ë©´\n\n```yaml\n{\n  'detail':\n    [\n      {\n        'loc': ['body', 'new_cleaning', 'cleaning_type'],\n        'msg': \"value is not a valid enumeration member; permitted: 'dust_up', 'spot_clean', 'full_clean'\",\n        'type': 'type_error.enum',\n        'ctx': { 'enum_values': ['dust_up', 'spot_clean', 'full_clean'] },\n      },\n    ],\n}\n```\n\nì´ë ‡ê²Œ ì™œ ì—ëŸ¬(422)ê°€ ë‚˜ëŠ”ì§€ ì¹œì ˆí•˜ê²Œ ì„¤ëª…ë„ í•´ì¤€ë‹¤.\nì •ìƒì ì¸ ê°’ì„ ë„£ìœ¼ë©´\n\n```yaml\n{\n  'new_cleaning':\n    { 'name': 'test', 'description': 'test', 'cleaning_type': 'dust_up', 'price': 123 },\n}\n```\n\nì„¤ì •í•œëŒ€ë¡œ\n\n```yaml\n{\n  'name': 'test',\n  'description': 'test',\n  'cleaning_type': 'dust_up',\n  'price': 123,\n  'id': 1,\n}\n```\n\n`cleaning_public`ì˜ ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ê°’ì„ ë°˜í™˜(201)í•œë‹¤. ë§Œì•½ `cleaning_public`ê°€ `id_model`ì„ ìƒì†í•˜ë„ë¡ ì •ì˜í•˜ì§€ ì•Šì•˜ë‹¤ë©´ `id`ì†ì„±ì€ ìƒëµëœ ì±„ë¡œ ë°˜í™˜ëì„ ê²ƒì´ë‹¤.\n\n\u003e **`fastapi`** ê°€ ìœ„ **POST** apiì—ì„œ ì‹¤í–‰í•œ ê³¼ì •\n\u003e\n\u003e 1. **`json`** í˜•íƒœì˜ `body`ë¥¼ ì½ëŠ”ë‹¤.\n\u003e 2. `body`ì˜ ê°’ì„ ê²€ì¦í•œë‹¤. ~ **`pydantic`**\n\u003e 3. ê²€ì¦ ê²°ê³¼ì— ë”°ë¼ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ê±°ë‚˜, ìƒì„±í•œ ëª¨ë¸ ê°ì²´ë¡œ ê³„ì‚°í•œ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.\n\n### `FastAPI`ì˜ `DI` ì‚¬ìš©ë²•\n\n`Depends`ë¡œ ë³€ìˆ˜ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì´ ìƒì†Œí•  ìˆ˜ ìˆë‹¤. ì‚¬ìš©ìì˜ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì‚¬ì „ì— í˜¸ì¶œ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ì •ì˜í•˜ê³ , ê·¸ ê³¼ì •ì„ í•œë²ˆì— ì‹¤í–‰í•œ ê²°ê³¼ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•œë‹¤.\n\nì§ì „ì— ìƒì„±í•œ `session.py`ì—ì„œ `get_database`ê°€ `request`ë¥¼ ë°›ê³ ,\n`get_session`ì´ `get_database`ë¥¼ ë°›ê³ ,\n`create_new_cleaning`ì´ `get_session`ì„ ë°›ì•„ì„œ `session`ê°ì²´ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•œë‹¤.\n\në§ˆì§€ë§‰ìœ¼ë¡œ, sql ì„œë²„ì—ì„œ ì •ìƒì ìœ¼ë¡œ ë ˆì½”ë“œê°€ ì…ë ¥ëëŠ”ì§€ í™•ì¸í•´ë³¸ë‹¤.\n\n```bash\nbash-5.1# psql -h localhost -U postgres --dbname=postgres\npsql (14.2)\nType \"help\" for help.\n\npostgres=# select * from cleanings;\n name | description | cleaning_type | price  | id\n------+-------------+---------------+--------+----\n test | test        | dust_up       | 123.00 |  1\n(1 row)\n```\n\në‹¤ìŒì—ëŠ” **`pytest`** ë¥¼ í™œìš©í•œë‹¤.\n**`alembic`** ì²˜ëŸ¼ ì‚¬ìš©í•´ë³¸ì ì´ ì—†ê¸°ì— ê¸°ëŒ€ê°€ ëœë‹¤.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/fastapi íŠœí† ë¦¬ì–¼ -3- sql ëª¨ë¸ ì •ì˜","data":{"title":"fastapi íŠœí† ë¦¬ì–¼ -3- sql ëª¨ë¸ ì •ì˜","date":"2022-04-28T21:51:36.869+09:00","tags":["fastapi","python","sqlmodel","@all"],"page":"fastapi íŠœí† ë¦¬ì–¼","summary":"fastapi ì‚¬ìš©ë²•ì„ ë‹¤ì‹œ ê³µë¶€í• ê²¸, ì°¸ê³ í• ë§Œí•œ ì¢‹ì€ ì˜ˆì œê°€ ìˆì–´ì„œ ì´ ì‹œë¦¬ì¦ˆë¥¼ ì•½ê°„ì˜ ë³€ê²½ì„ ì£¼ê³  ë”°ë¼ê°€ë³´ë ¤ í•œë‹¤."}},{"name":"FastAPI, sqlmodelë¡œ ê°„ë‹¨í•œ crud api ìƒì„± 4","content":"\nì´ì œ ê¸°ì¡´ì— ì‘ì„±í•œ `crud` apië¥¼ ë³´ì™„í•´ë³´ê² ìŠµë‹ˆë‹¤.\n\n## ìœ ì €ë¥¼ ì¶”ê°€í• ë•Œ ì¤‘ë³µ í™•ì¸\n\nê¸°ì¡´ ì‘ì„±ëœ `create` apiëŠ” ì…ë ¥ë°›ì€ `body`ë¥¼ ê·¸ëŒ€ë¡œ dbì— ìƒˆë¡œìš´ ë ˆì½”ë“œë¡œ ì¶”ê°€í•˜ëŠ” ì—­í• ë§Œ í–ˆìŠµë‹ˆë‹¤.\nì´ì œ `email`ì†ì„±ì„ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µì„ í™•ì¸ í•œ ë‹¤ìŒ ë ˆì½”ë“œë¡œ ì¶”ê°€í•  ìˆ˜ ìˆê²Œ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤.\n\n```python\n# api/scripts/routes/user/crud.py\n(ì „ëµ)\n\n@app.post(\"/create_user\", response_model=user.user)\nasync def create_user(data: user.user, *, session: AsyncSession = Depends(get_session)):\n    user_email = await session.exec(select(user.user.email))  # type: ignore\n    if data.email in user_email: # type: ignore\n        raise HTTPException(status_code=400, detail=\"ë™ì¼í•œ email ìœ ì € ìˆìŒ\")\n\n    user_instance = user.user.from_orm(data)\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n(í›„ëµ)\n```\n\nì´ì œ ì¤‘ë³µëœ ìœ ì € ë°ì´í„°ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ 400ì—ëŸ¬ì™€ í•¨ê»˜ ë‹¤ìŒê³¼ ê°™ì€ ê°’ì„ ë°˜í™˜í•©ë‹ˆë‹¤.\n\n```json\n{\n  \"detail\": \"ë™ì¼í•œ email ìœ ì € ìˆìŒ\"\n}\n```\n\në¡œê·¸ë¥¼ í™•ì¸í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```sql\nINFO sqlalchemy.engine.Engine BEGIN (implicit)\nINFO sqlalchemy.engine.Engine SELECT \"user\".email\nFROM \"user\"\nINFO sqlalchemy.engine.Engine [no key 0.00018s] ()\nINFO:     10.0.2.100:43750 - \"POST /user/create_user HTTP/1.1\" 400 Bad Request\nINFO sqlalchemy.engine.Engine ROLLBACK\n```\n\në§Œì•½ ì¤‘ë³µì´ ì•„ë‹Œ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì€ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```sql\nINFO sqlalchemy.engine.Engine BEGIN (implicit)\nINFO sqlalchemy.engine.Engine SELECT \"user\".email\nFROM \"user\"\nINFO sqlalchemy.engine.Engine [no key 0.00016s] ()\nINFO sqlalchemy.engine.Engine INSERT INTO \"user\" (name, email, registered_date) VALUES (%s, %s, %s) RETURNING \"user\".id\nINFO sqlalchemy.engine.Engine [cached since 276.6s ago] ('test', 'test@example.com', datetime.datetime(--))\nINFO sqlalchemy.engine.Engine COMMIT\nINFO sqlalchemy.engine.Engine BEGIN (implicit)\nINFO sqlalchemy.engine.Engine SELECT \"user\".id, \"user\".name, \"user\".email, \"user\".registered_date\nFROM \"user\"\nWHERE \"user\".id = %s\nINFO sqlalchemy.engine.Engine [cached since 276.6s ago] (3,)\nINFO:     10.0.2.100:43796 - \"POST /user/create_user HTTP/1.1\" 200 OK\nINFO sqlalchemy.engine.Engine ROLLBACK\n```\n\n\u003e ì§€ê¸ˆì€ api ì„œë²„ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì„ ë³´ì´ê¸° ìœ„í•´ ì´ë ‡ê²Œ ì½”ë“œë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.\n\u003e í•˜ì§€ë§Œ **ë” ê°„ë‹¨í•˜ê²Œ ì¤‘ë³µì„ ì œì™¸í•˜ëŠ” ë°©ë²•**ì´ ìˆìŠµë‹ˆë‹¤.\n\u003e `user.user` ëª¨ë¸ì„ ì •ì˜í•  ë•Œ, `email` í•„ë“œì— `sa_column_kwargs={\"unique\": True}` íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.\n\u003e ê·¸ëŸ¬ë©´ api ì„œë²„ê°€ ì•„ë‹Œ, dbì—ì„œ ì¤‘ë³µì„ í™•ì¸í•˜ê³ , ì—ëŸ¬ë¥¼ ë°˜í™˜í•  ê²ƒì…ë‹ˆë‹¤.\n\u003e ë‹¤ë§Œ, **ì´ ì—ëŸ¬ì— ëŒ€í•œ ì˜ˆì™¸ì²˜ë¦¬ëŠ” ì§ì ‘ í•´ì•¼í•©ë‹ˆë‹¤.**\n\n## ìœ ì € ì •ë³´ë¥¼ ìˆ˜ì •í•œ ìµœì¢… ì¼ì ê¸°ë¡\n\nê¸°ì¡´ `user` ëª¨ë¸ì€ ìµœì´ˆ ì…ë ¥ ì¼ìì— ëŒ€í•œ ì •ë³´ë§Œ ë³´ì¡´í•˜ê³ , ìˆ˜ì •í•œ ì¼ìì— ëŒ€í•´ì„œëŠ” ë³´ì¡´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ëŠ” í…Œì´ë¸”ì— ìƒˆë¡œìš´ í•„ë“œë¥¼ ì¶”ê°€í•´ì•¼ ê°€ëŠ¥í•œ ì¼ì´ë¯€ë¡œ, `user`ëª¨ë¸ì„ ì§ì ‘ì ìœ¼ë¡œ ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤.\n\n```python\n# api/scripts/models/user/__init__.py\n(ì „ëµ)\n\nclass user(SQLModel, table=True):\n    id: Optional[int] = Field(None, primary_key=True)\n    name: str = Field(..., min_length=1, nullable=False)\n    email: EmailStr = Field(..., nullable=False)\n    registered_date: datetime = Field(default_factory=datetime.today)\n    last_updated_date: datetime = Field(default_factory=datetime.today)\n```\n\n`last_updated_date` í•„ë“œë§Œ ì¶”ê°€í•˜ê³  ëëƒˆìŠµë‹ˆë‹¤.\nì§€ê¸ˆ ì´ìƒíƒœ ê·¸ëŒ€ë¡œ ì§„í–‰í•˜ë©´ `update` apië¥¼ ìˆ˜ì •í•˜ë”ë¼ë„, ì—ëŸ¬ë¥¼ ë°˜í™˜í•  ê²ƒì…ë‹ˆë‹¤. ê¸°ì¡´ì— db ìƒì„±í•œ `user`í…Œì´ë¸”ì—ëŠ” `last_updated_date` í•„ë“œê°€ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\nsqlì˜ `alter` ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•´ë„ ë˜ê³ , `sqlalchemy`ì˜ `drop_all` ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•´ë„ ë©ë‹ˆë‹¤.\nì§€ê¸ˆì€ ê°œë°œ ì´ˆê¸°ì¤‘ì˜ ì´ˆê¸°ì´ë¯€ë¡œ `drop_all`ë¡œ í•´ê²°í•˜ê² ìŠµë‹ˆë‹¤.\n\n```python\n# api/scripts/database/default.py\n(ì „ëµ)\n\nasync def create_model_table() -\u003e None:\n    async with engine.begin() as conn:\n        if settings.debug:\n            await conn.run_sync(SQLModel.metadata.drop_all)\n        await conn.run_sync(SQLModel.metadata.create_all)\n```\n\nê¸°ì¡´ì— ì—†ë˜ `await conn.run_sync(SQLModel.metadata.drop_all)`ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.\n`create_model_table`í•¨ìˆ˜ê°€ ì´ë¯¸ ì„œë²„ë¥¼ ì‹œì‘í• ë•Œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •ë¼ ìˆê¸° ë•Œë¬¸ì—, ì´ì œ ì„œë²„ë¥¼ ì‹œì‘í•˜ë©´ ì‘ì„±í•œ ëª¨ë¸ì— ëŒ€ì‘í•˜ëŠ” í…Œì´ë¸”ì„ ëª¨ë‘ `drop`í•˜ê³  ë‹¤ì‹œ `create`í•  ê²ƒì…ë‹ˆë‹¤.\nê°œë°œì¤‘ì—ë§Œ ì‚¬ìš©í•˜ìëŠ” ì˜ë¯¸ë¡œ `settings.debug`ë¥¼ í™•ì¸í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œë¡œëŠ” ë” ì—„ê²©í•˜ê²Œ í™•ì¸í•˜ëŠ”ê²Œ ë§ìŠµë‹ˆë‹¤.\n\nì´ì œ `update` apië¥¼ ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤.\n\n```python\n# api/scripts/routes/user/crud.py\n\nfrom datetime import datetime\n\nfrom fastapi import Depends, HTTPException, Path\nfrom sqlmodel import select\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom ...database import get_session\nfrom ...models import user\nfrom .app import app\n\n(ì¤‘ëµ)\n\n@app.patch(\"/update_user/{user_id}\", response_model=user.user)\nasync def update_user(\n    data: user.user,\n    user_id: int = Path(..., ge=1),\n    *,\n    session: AsyncSession = Depends(get_session),\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    update_data = data.dict(exclude_unset=True)\n    for key, value in update_data.items():\n        setattr(user_instance, key, value)\n\n    user_instance.last_updated_date = datetime.today()\n\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n(í›„ëµ)\n```\n\n`user_instance.last_updated_date = datetime.today()`ê°€ ì¶”ê°€ëìŠµë‹ˆë‹¤.\nì´ì œ ì •ìƒì ìœ¼ë¡œ `update` apiê°€ ì‹¤í–‰ë˜ë©´, `last_update_date` ê°’ì´ ë³€í•©ë‹ˆë‹¤.\n\nì‹¤ì œë¡œ ì‹¤í–‰í•´ë³´ë©´, ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ë¥¼ ë°˜í™˜ë°›ìŠµë‹ˆë‹¤.\n\n```json\n{\n  \"id\": 1,\n  \"registered_date\": \"2021-11-26T23:59:37.359332\",\n  \"last_updated_date\": \"2021-11-26T23:59:52.837064\",\n  \"name\": \"aaa\",\n  \"email\": \"user@example.com\"\n}\n```\n\n## ê° apiì˜ `response_model`ê³¼ `body` í˜•íƒœ ìˆ˜ì •\n\nì§€ê¸ˆê¹Œì§€ ì‘ì„±ëœ `crud` apiëŠ” `delete`ë¥¼ ì œì™¸í•˜ê³  `response_model=user.user` íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì´ê²ƒì€ ë°˜í™˜í•œ ê°’ì´ `user.user` ì¸ìŠ¤í„´ìŠ¤ì´ê³ , `user.user` ì˜ ìŠ¤í‚¤ë§ˆë¡œ ë°ì´í„°ë¥¼ ë°˜í™˜í•´ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ ëª¨ë“  apiì—ì„œ ê·¸ë ‡ê²Œ í•˜ëŠ” ê²ƒì€ **ìœ„í—˜í•œ ì¼**ì…ë‹ˆë‹¤.\nì§€ê¸ˆì€ ë”°ë¡œ ì„¤ì •í•˜ì§€ ì•Šì•˜ì§€ë§Œ ì‚¬ìš©ìì˜ **ë¹„ë°€ë²ˆí˜¸**ê°€ í•„ë“œì— ìˆì„ ìˆ˜ë„ ìˆê³ , **ë¯¼ê°í•œ ê°œì¸ì •ë³´** ë˜í•œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\në˜í•œ ì…ë ¥ë°›ëŠ” `body` ì—­ì‹œ `user.user`ì˜ ìŠ¤í‚¤ë§ˆë¡œ êµ¬ì„±ëœ ë°ì´í„°ë¥¼ ë°›ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ê²ƒì€ ë¶ˆí•„ìš”í•œ ì¼ì´ê³ , ì–´ì©Œë©´ **ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.**\n\nì‚¬ìš©ìê°€ `user`ë¥¼ ì¶”ê°€í•  ë•Œ, `id`ë‚˜ `registered_date`ì™€ ê°™ì´ ë ˆì½”ë“œì— ìë™ìœ¼ë¡œ ì…ë ¥ë˜ëŠ” ê°’ì€ **ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì„ ë°›ì„ í•„ìš”ë„ ì—†ê³ , ë°›ì•„ì„  ì•ˆë˜ëŠ” ê°’ì…ë‹ˆë‹¤.**\n\në”°ë¼ì„œ, ì‚¬ìš©ìê°€ ì…ë ¥í•˜ëŠ” ê°’ê³¼, ì‚¬ìš©ìì—ê²Œ ë°˜í™˜í•  ê°’ì— ëŒ€í•œ ìƒˆë¡œìš´ ìŠ¤í‚¤ë§ˆê°€ í•„ìš”í•©ë‹ˆë‹¤. ì´ì— ëŒ€í•œ ëª¨ë¸ì„ ìƒˆë¡œ ìƒì„±í•˜ë©´ì„œ, ê¸°ì¡´ì˜ ëª¨ë¸ì„ ì •ì˜í•˜ëŠ”ë° ìˆì–´ì„œ **ì•½ê°„ì˜ ë³€í™”**ë¥¼ ì£¼ê² ìŠµë‹ˆë‹¤.\n\n```python\n# api/scripts/models/user/__init__.py\n\n(ì „ëµ)\n\nclass user_base(SQLModel):\n    name: str = Field(..., min_length=1, nullable=False)\n    email: EmailStr = Field(..., nullable=False)\n\n\nclass user_create(user_base):\n    pass\n\n\nclass user_read(user_base):\n    id: int\n\n\nclass user_update(user_base):\n    name: Optional[str] = Field(None, min_length=1)\n    email: Optional[EmailStr] = None\n\n\nclass user(user_base, table=True):\n    id: Optional[int] = Field(None, primary_key=True)\n    registered_date: datetime = Field(default_factory=datetime.today)\n    last_updated_date: datetime = Field(default_factory=datetime.today)\n```\n\n`user_base`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ `create`, `read`, `update`ì— ëŒ€ì‘í•˜ëŠ” ëª¨ë¸ê³¼ `user` í…Œì´ë¸”ì— í•´ë‹¹í•˜ëŠ” ëª¨ë¸ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.\n\n\u003e `user_update`ëŠ” `user_base`ì—ì„œ ì •ì˜ëœ ëª¨ë“  í•„ë“œë¥¼ ë®ì–´ì”Œìš°ì§€ë§Œ, ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš°ë„ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì¼ë‹¨ ìƒì†í–ˆìŠµë‹ˆë‹¤.\n\nì´ì „ì— `table=True` íŒŒë¼ë¯¸í„°ê°€ ìˆì–´ì•¼ dbì— í…Œì´ë¸”ì´ ìƒì„±ëœë‹¤ê³  í•œ ì ì´ ìˆìŠµë‹ˆë‹¤. ìœ„ ì½”ë“œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë“¯ì´, `user` í´ë˜ìŠ¤ë§Œ `table=True` íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ `user` í´ë˜ìŠ¤ë¥¼ ì œì™¸í•œ ëª¨ë¸ì€ ì‚¬ì‹¤ìƒ `pydantic`ì˜ ëª¨ë¸ë¡œ í™œìš©í•˜ê²Œ ë©ë‹ˆë‹¤.\n\nì´ì œ ì´ ëª¨ë¸ì„ ì ìš©í•œ `crud` apië¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.\n\n```python\n# api/scripts/routes/user/crud.py\n\n(ì „ëµ)\n\n@app.post(\"/create_user\", response_model=user.user_read)\nasync def create_user(\n    data: user.user_create, *, session: AsyncSession = Depends(get_session)\n):\n    user_email = await session.exec(select(user.user.email))  # type: ignore\n    if data.email in user_email:  # type: ignore\n        raise HTTPException(status_code=400, detail=\"ë™ì¼í•œ email ìœ ì € ìˆìŒ\")\n\n    user_instance = user.user.from_orm(data)\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n@app.get(\"/get_user/{user_id}\", response_model=user.user_read)\nasync def get_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    return user_instance\n\n\n@app.patch(\"/update_user/{user_id}\", response_model=user.user_read)\nasync def update_user(\n    data: user.user_update,\n    user_id: int = Path(..., ge=1),\n    *,\n    session: AsyncSession = Depends(get_session),\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    update_data = data.dict(exclude_unset=True)\n    for key, value in update_data.items():\n        setattr(user_instance, key, value)\n\n    user_instance.last_updated_date = datetime.today()\n\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n@app.delete(\"/delete_user/{user_id}\")\nasync def delete_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    await session.delete(user_instance)\n    await session.commit()\n\n    return user_id\n```\n\n`reponse_model`ì„ `user.user_read`ë¡œ ìˆ˜ì •í•˜ê³ , `body`ì— í•´ë‹¹í•˜ëŠ” `data`ì˜ íƒ€ì…ì„ `user.user_create` ë˜ëŠ” `user.user_update`ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.\n`response_model`ì„ `user.user_read`ë¡œ ì •í–ˆê¸° ë•Œë¬¸ì—, `user.user` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜í•˜ë”ë¼ë„, `user.user_read`ì˜ ìŠ¤í‚¤ë§ˆì— ë”°ë¼ ê°’ì´ ë°˜í™˜ë©ë‹ˆë‹¤.\n![](/images/9a191a49-09af-4cad-acf6-fe48c31b5fa5-docs.png)\ndocsì—ì„œ í•œ ëˆˆì— í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\n## ëìœ¼ë¡œ..\n\në” ì ê³  ì‹¶ì€ë°, ë” ì ì„ê²Œ ë­ê°€ ìˆì„ì§€ ì˜ ëª¨ë¥´ê² ì–´ìš”.\nì¼ë‹¨ ì—¬ê¸°ì„œ ì¤‘ë‹¨\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/FastAPI, sqlmodelë¡œ ê°„ë‹¨í•œ crud api ìƒì„± 4","data":{"title":"FastAPI, sqlmodelë¡œ ê°„ë‹¨í•œ crud api ìƒì„± 4","date":"2021-11-27T00:28:51.285+09:00","tags":["crud","fastapi","python","sqlmodel","@all"],"page":"FastAPI, sqlmodelë¡œ ê°„ë‹¨í•œ crud api ìƒì„±","summary":"ì´ì œ ê¸°ì¡´ì— ì‘ì„±í•œ crud apië¥¼ ë³´ì™„í•´ë³´ê² ìŠµë‹ˆë‹¤."}}]},"__N_SSG":true},"page":"/posts/@tag/[...tag]","query":{"tag":["sqlmodel","1"]},"buildId":"MQ_lMVQgBI0RkmUA6wvVT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>