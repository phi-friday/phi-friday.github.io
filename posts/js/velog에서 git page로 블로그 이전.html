<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="author" content="phi.friday@gmail.com, phi"/><meta name="robots" content="index,follow,noarchive"/><meta name="google-site-verification" content="lW107Dj5ageygd67UUzTm-kGls5d-THy9jJQZqLoauw"/><title>phi.log - velog에서 git page로 블로그 이전</title><link href="https://use.fontawesome.com/releases/v5.15.1/css/all.css" rel="stylesheet"/><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/e61452b80f7f8356.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e61452b80f7f8356.css" data-n-g=""/><link rel="preload" href="/_next/static/css/1f4d813b299120ae.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1f4d813b299120ae.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-5752944655d749a0.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-5dc3bdee87ff18dd.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f6271bdec05edb1f.js" defer=""></script><script src="/_next/static/chunks/996-f3cf67c2e3ac5e06.js" defer=""></script><script src="/_next/static/chunks/756-1349105dbea71525.js" defer=""></script><script src="/_next/static/chunks/3-4b8664ceef873544.js" defer=""></script><script src="/_next/static/chunks/224-ddba219ecdd5c904.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...name%5D-98f81935dc747879.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_buildManifest.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_ssgManifest.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><style>
      #nprogress {
        pointer-events: none;
      }
      #nprogress .bar {
        background: #29D;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
      }
      #nprogress .peg {
        display: block;
        position: absolute;
        right: 0px;
        width: 100px;
        height: 100%;
        box-shadow: 0 0 10px #29D, 0 0 5px #29D;
        opacity: 1;
        -webkit-transform: rotate(3deg) translate(0px, -4px);
        -ms-transform: rotate(3deg) translate(0px, -4px);
        transform: rotate(3deg) translate(0px, -4px);
      }
      #nprogress .spinner {
        display: block;
        position: fixed;
        z-index: 1031;
        top: 15px;
        right: 15px;
      }
      #nprogress .spinner-icon {
        width: 18px;
        height: 18px;
        box-sizing: border-box;
        border: solid 2px transparent;
        border-top-color: #29D;
        border-left-color: #29D;
        border-radius: 50%;
        -webkit-animation: nprogresss-spinner 400ms linear infinite;
        animation: nprogress-spinner 400ms linear infinite;
      }
      .nprogress-custom-parent {
        overflow: hidden;
        position: relative;
      }
      .nprogress-custom-parent #nprogress .spinner,
      .nprogress-custom-parent #nprogress .bar {
        position: absolute;
      }
      @-webkit-keyframes nprogress-spinner {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }
      @keyframes nprogress-spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style><div class="container" style="max-width:900px;min-width:400px"><div class="container default_app"><header><div class="container"><nav class="navbar-light fixed-top navbar navbar-expand-sm bg-light" role="navigation"><div class="container" style="max-width:900px"><div class="container-fluid"><ul class="navbar-nav w-100"><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-home"></i> Home</div></a></li><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/posts/@tag"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-hashtag"></i> Post</div></a></li><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/posts/@page"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-blog"></i> Page</div></a></li><div class="container d-flex justify-content-end align-self-center"><div class="row"><div class="col"><form class="input-group w-auto" method="get" action="https://www.google.com/search" target="_blank" style="min-width:230px"><input type="hidden" name="sitesearch" value="phi-friday.github.io"/><input type="search" class="form-control" placeholder="Search in Google" aria-label="Search" name="q" maxLength="255"/><button class="ripple ripple-surface btn btn-outline-primary" role="button"><i class="fa fa-search"></i></button></form></div></div></div></ul></div></div></nav></div></header><main><div class="container"><article><div class="row"><div class="display-6 mb-3">velog에서 git page로 블로그 이전</div><h6 class="mb-0 text-muted text-end"><time dateTime="2022-06-12T04:27:48.097+09:00">작성일: 2022년 6월 12일 4시 27분 48초</time></h6><h6 class="mt-0 text-muted text-end"><time dateTime="2022-08-13T00:12:20.000+09:00">수정일: 2022년 8월 13일 24시 12분 20초</time></h6><div class="d-flex justify-content-end"><div><span><span class="badge bg-info mx-1">#js<!-- --> </span></span><span><span class="badge bg-info mx-1">#ts<!-- --> </span></span><span><span class="badge bg-info mx-1">#nextjs<!-- --> </span></span><span><span class="badge bg-info mx-1">#velog<!-- --> </span></span><span><span class="badge bg-info mx-1">#github<!-- --> </span></span></div></div></div><div class="row"><div class="mt-3 mb-5 border-top"></div></div><div class="row"><div><div class="toolbar"><div></div></div><div class="markdown-body"><nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#왜-옮겼나">왜 옮겼나?</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#처음부터-git-page를-쓰고-싶었다">처음부터 git page를 쓰고 싶었다.</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#velog는-다-좋은데-이게-없다">velog는 다 좋은데 이게 없다.</a></li></ol></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#어떻게-옮겼나">어떻게 옮겼나?</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#앞으로-추가할-기능">앞으로 추가할 기능</a></li></ol></nav><h1 id="왜-옮겼나">왜 옮겼나?</h1>
<p>지난 몇달간 <code>velog</code>에서 몇몇 포스트를 작성했다.
잘 만들어진 구성이다 보니 별다른 불만 없이 잘 사용했다.
하지만 지난 며칠간의 연습 끝에 <code>git page</code>로 블로그를 이전했다.</p>
<h2 id="처음부터-git-page를-쓰고-싶었다">처음부터 <code>git page</code>를 쓰고 싶었다.</h2>
<p>사실 이전부터 <code>git page</code>로 블로그를 만들고 싶었다.
가장 많이 알려진 간단한 방법은 <code>jekyll</code>를 사용하는 것이다.
하지만 <code>ruby</code>로 작성된 엔진이다 보니 제대로 알아보는데 힘이 들었다.
그렇다고 <code>ruby</code>를 따로 배워보자니, 살면서 <code>ruby</code>를 사용할 일이 얼마나 있을까 하는 생각이 문득 들었다.
차라리 <code>go</code>나 <code>rust</code>라면 노력해보겠지만, <code>ruby</code>라니..</p>
<p>그렇게 그냥 하지 말까? 하다가 알게된게 <code>velog</code>였다.
<code>velog</code>는 내가 처음에 기대한 거의 모든 것을 만족했다.</p>
<ul>
<li>마크다운을 이용한 포스팅</li>
<li>코드 블록 하이라이팅</li>
<li>실시간 포스팅 프리뷰</li>
</ul>
<p>겨우 세가지지만 이 세가지를 만족하는 곳이 사실상 없다.
그리고 따로 내가 레이아웃을 수정할 필요가 없다보니(사실 방법도 없다), 그냥 잘 만들어진 플랫폼에 글만 쓰면 내가 원하는게 다 됐다.</p>
<h2 id="velog는-다-좋은데-이게-없다"><code>velog</code>는 다 좋은데 이게 없다.</h2>
<p>하지만 쓰다보니 역시 아쉬운게 보인다.</p>
<ul>
<li>명확한 기준은 모르겠지만, 몇몇 양식에 대한 하이라이팅 미지원(log 등)</li>
<li>작성글 숨기기</li>
</ul>
<p>그리고 무엇보다도.. 내가 직접 만든다는 성취감이 없었다.
그래서 결국 직접 만들기로 했다.</p>
<p>다만 <code>velog</code>덕분에 카테고리가 무조건 있어야 한다는 고정관념에서 벗어날 수 있었다.
태그를 추가하면, 태그가 기존의 카테고리처럼 사용될 수 있게 하면 된다.
또한 특정 포스트간의 연결이 필요하다면, 따로 지정할 수 있는 기능이 있으면 된다.</p>
<p><code>velog</code>에서 얻은 소중한 경험을 토대로, <code>git page</code>에 블로그를 만들기 위한 준비를 했다.</p>
<h1 id="어떻게-옮겼나">어떻게 옮겼나?</h1>
<p>처음에는 그냥 익숙한 <code>python</code>으로 작성하려 했다.
<code>pelican</code>이라는 라이브러리가 있어서, <code>jekyll</code>처럼 간단하게 정적 사이트를 배포할 수 있게 한다. 사용 언어가 <code>python</code>이다 보니 관련 스크립트를 확인하며, 작동 방식을 파악하는 것도 할만했다.</p>
<p>하지만 반응형으로 작성해보려 하니, 결국 <code>javascript</code>를 쓸 수 밖에 없었다.
그리고 어차피 <code>javascript</code>를 써야한다면.. 이번기회에 공부도 할 겸 완전히 <code>javascript</code>로 작성해보자는 생각이 들었다.</p>
<p>여기서 <code>vue</code>냐, <code>react</code>냐 많은 고민이 있었고, 여러 시도가 있었는데, 결국 선택한건 <code>react</code>다.
그리고 <code>react</code> 앱을 간단하게 작성하고 배포할 수 있는 프레임워크로 <code>nextjs</code>를 사용했다.</p>
<p>처음 생각은 <code>javascript</code>였는데, <code>python</code>의 타입 힌트를 이용한 <code>vscode</code>의 자동완성 기능에 너무 익숙해져서 그런가, 코드 작성이 너무 불편했다.
마침 <code>nextjs</code>가 <code>typescript</code>를 지원하기도 해서, 약간의 수고가 있었지만 <code>typescript</code>로 앱을 작성했다.</p>
<p>많은 삽질끝에 그래도 <code>git page</code>에 배포할 수 있는 형태로 만드는데 성공했다.
이제 부족한 몇몇 기능을 추가하고, 디자인을 손보기만 하면 된다.
그러고보니... <code>typescript</code>보다 <code>css</code>가 더 어려운 것 같다..
아무리 해도 예쁘게 보이지를 않는다..</p>
<h1 id="앞으로-추가할-기능">앞으로 추가할 기능</h1>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->다크모드 토글<!-- -->
<blockquote>
<p>사실 이미 기능 추가는 했지만, css 작성하기가 힘들어서 주석으로 놔둔 상태</p>
</blockquote>
</li>
<li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->문단 제목 역링크</li>
<li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->코드 블럭 라인 하이라이트</li>
</ul></div></div></div><div class="row"><div class="mt-5 mb-3 border-bottom"></div></div><div class="row"><span class="d-flex justify-content-between"><span><h6 class=""><i class="fa fa-angle-left mx-2"></i>fastapi 튜토리얼 -8.2-...</h6></span><span><h6 class="">[Vim] Normal모드에서 영문...<i class="fa fa-angle-right mx-2"></i></h6></span></span><div class="mt-3"><div><section style="width:100%"></section></div></div></div></article></div></main><footer class="text-center text-muted"></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"name":"velog에서 git page로 블로그 이전","content":"\n# 왜 옮겼나?\n\n지난 몇달간 `velog`에서 몇몇 포스트를 작성했다.\n잘 만들어진 구성이다 보니 별다른 불만 없이 잘 사용했다.\n하지만 지난 며칠간의 연습 끝에 `git page`로 블로그를 이전했다.\n\n## 처음부터 `git page`를 쓰고 싶었다.\n\n사실 이전부터 `git page`로 블로그를 만들고 싶었다.\n가장 많이 알려진 간단한 방법은 `jekyll`를 사용하는 것이다.\n하지만 `ruby`로 작성된 엔진이다 보니 제대로 알아보는데 힘이 들었다.\n그렇다고 `ruby`를 따로 배워보자니, 살면서 `ruby`를 사용할 일이 얼마나 있을까 하는 생각이 문득 들었다.\n차라리 `go`나 `rust`라면 노력해보겠지만, `ruby`라니..\n\n그렇게 그냥 하지 말까? 하다가 알게된게 `velog`였다.\n`velog`는 내가 처음에 기대한 거의 모든 것을 만족했다.\n\n- 마크다운을 이용한 포스팅\n- 코드 블록 하이라이팅\n- 실시간 포스팅 프리뷰\n\n겨우 세가지지만 이 세가지를 만족하는 곳이 사실상 없다.\n그리고 따로 내가 레이아웃을 수정할 필요가 없다보니(사실 방법도 없다), 그냥 잘 만들어진 플랫폼에 글만 쓰면 내가 원하는게 다 됐다.\n\n## `velog`는 다 좋은데 이게 없다.\n\n하지만 쓰다보니 역시 아쉬운게 보인다.\n\n- 명확한 기준은 모르겠지만, 몇몇 양식에 대한 하이라이팅 미지원(log 등)\n- 작성글 숨기기\n\n그리고 무엇보다도.. 내가 직접 만든다는 성취감이 없었다.\n그래서 결국 직접 만들기로 했다.\n\n다만 `velog`덕분에 카테고리가 무조건 있어야 한다는 고정관념에서 벗어날 수 있었다.\n태그를 추가하면, 태그가 기존의 카테고리처럼 사용될 수 있게 하면 된다.\n또한 특정 포스트간의 연결이 필요하다면, 따로 지정할 수 있는 기능이 있으면 된다.\n\n`velog`에서 얻은 소중한 경험을 토대로, `git page`에 블로그를 만들기 위한 준비를 했다.\n\n# 어떻게 옮겼나?\n\n처음에는 그냥 익숙한 `python`으로 작성하려 했다.\n`pelican`이라는 라이브러리가 있어서, `jekyll`처럼 간단하게 정적 사이트를 배포할 수 있게 한다. 사용 언어가 `python`이다 보니 관련 스크립트를 확인하며, 작동 방식을 파악하는 것도 할만했다.\n\n하지만 반응형으로 작성해보려 하니, 결국 `javascript`를 쓸 수 밖에 없었다.\n그리고 어차피 `javascript`를 써야한다면.. 이번기회에 공부도 할 겸 완전히 `javascript`로 작성해보자는 생각이 들었다.\n\n여기서 `vue`냐, `react`냐 많은 고민이 있었고, 여러 시도가 있었는데, 결국 선택한건 `react`다.\n그리고 `react` 앱을 간단하게 작성하고 배포할 수 있는 프레임워크로 `nextjs`를 사용했다.\n\n처음 생각은 `javascript`였는데, `python`의 타입 힌트를 이용한 `vscode`의 자동완성 기능에 너무 익숙해져서 그런가, 코드 작성이 너무 불편했다.\n마침 `nextjs`가 `typescript`를 지원하기도 해서, 약간의 수고가 있었지만 `typescript`로 앱을 작성했다.\n\n많은 삽질끝에 그래도 `git page`에 배포할 수 있는 형태로 만드는데 성공했다.\n이제 부족한 몇몇 기능을 추가하고, 디자인을 손보기만 하면 된다.\n그러고보니... `typescript`보다 `css`가 더 어려운 것 같다..\n아무리 해도 예쁘게 보이지를 않는다..\n\n# 앞으로 추가할 기능\n\n- [ ] 다크모드 토글\n  \u003e 사실 이미 기능 추가는 했지만, css 작성하기가 힘들어서 주석으로 놔둔 상태\n- [ ] 문단 제목 역링크\n- [ ] 코드 블럭 라인 하이라이트\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"js/velog에서 git page로 블로그 이전","data":{"title":"velog에서 git page로 블로그 이전","tags":["js","ts","nextjs","velog","github","@all"],"page":null,"date":"2022-06-12T04:27:48.097+09:00","summary":"there is no summary"}},"prev_post":{"name":"fastapi 튜토리얼 -8.2- FastAPI Users v10 대응","content":"\n**`fastapi`** 사용법을 다시 공부할겸, 참고할만한 좋은 [예제](https://www.jeffastor.com/blog/populating-cleaning-jobs-with-user-offers-in-fastapi)가 있어서 이 시리즈를 약간의 변경을 주고 따라가보려 한다.\n지난번처럼 어쩌다 그만둘 수도 있긴 하지만...\n\n---\n\n## `Breaking` `changes`\n\n이틀전 **`fastapi-users`** 에 큰 변화가 생겼다. `v10` 릴리즈가 공개됐는데, `db` 모델과 여러 제네릭 타입에 대한 변화가 생겨서, `v10`을 이용하려면 대응 패치가 필수적인 상황..\n\n아래는 해당 릴리즈에 대한 전문이다.\n\n\u003e ### [Breaking changes](https://github.com/fastapi-users/fastapi-users/releases/tag/v10.0.0)\n\u003e\n\u003e Version 10 marks important changes in how we manage User models and their ID.\n\u003e\n\u003e Before, we were relying only on Pydantic models to work with users. In particular the current_user dependency would return you an instance of UserDB, a Pydantic model. This proved to be quite problematic with some ORM if you ever needed to retrieve relationship data or make specific requests.\n\u003e\n\u003e Now, FastAPI Users is designed to always return you a native object for your ORM model, whether it's an SQLAlchemy model or a Beanie document. Pydantic models are now only used for validation and serialization inside the API.\n\u003e\n\u003e Before, we were forcing the use of UUID as primary key ID; a consequence of the design above. This proved to be quite problematic on some databases, like MongoDB which uses a special ObjectID format by default. Some SQL folks also prefer to use traditional auto-increment integers.\n\u003e\n\u003e Now, FastAPI Users is designed to use generic ID type. It means that you can use any type you want for your user's ID. By default, SQLAlchemy adapter still use UUID; but you can quite easily switch to another thing, like an integer. Beanie adapter for MongoDB will use native ObjectID by default, but it also can be overriden.\n\n### 유저 모델 생성 및 수정\n\n기존 `fastapi_users.models` 에서 `fastapi_users.schemas`로 바뀐 것 외에 크게 달라진 것은 없다. 사실 이전에 얘기했던 `user` 와 `user_model`을 통합하는 작업을 이미 한 다음 `v10` 릴리즈를 확인했기에 더욱 그렇게 느껴졌다...\n\n```python\n# backend/app/models/user.py\nfrom typing import TypeVar\n\nfrom fastapi_users import schemas\nfrom pydantic import EmailStr\nfrom pydantic import Field as _Field\nfrom sqlmodel import Field, select\n\nfrom ..db.session import async_session\nfrom .core import base_model, datetime_model, uuid_id_model\n\nmin_name_length = 4\nmax_name_length = 20\n\n\n_T = TypeVar(\"_T\", bound=\"user\")\nid_model = uuid_id_model\nuser_id_type = id_model.id_type\n\n\nclass user(id_model, datetime_model, base_model, table=True):\n    __tablename__: str = \"users\"\n\n    name: str = Field(min_length=min_name_length, max_length=max_name_length)\n    hashed_password: str = Field(max_length=2**10)\n    email: EmailStr = Field(index=True)\n    is_active: bool = True\n    is_superuser: bool = False\n    is_verified: bool = False\n\n    @classmethod\n    async def get_from_email(\n        cls: type[_T], session: async_session, email: str\n    ) -\u003e _T | None:\n        is_user_cur = await session.exec(select(cls).where(cls.email == email))\n        return is_user_cur.first()\n\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n        self.validate(self)\n\n\nclass user_read(schemas.BaseUser[user_id_type], datetime_model):\n    name: str = _Field(min_length=min_name_length, max_length=max_name_length)\n\n\nclass user_create(schemas.BaseUserCreate):\n    name: str = _Field(min_length=min_name_length, max_length=max_name_length)\n\n\nclass user_update(schemas.BaseUserUpdate):\n    name: str = _Field(min_length=min_name_length, max_length=max_name_length)\n```\n\n### 인증 모듈 제네릭 타입 덮어씌우기\n\n**`fastapi-users`** 에서 원하는 형태는 `SQLAlchemyBaseUserTable`를 상속한 클래스를 사용하는 것이지만, **`sqlmodel`** 도 그대로 사용하고 **`fastapi-users`** 의 타입 힌트도 그대로 사용하고 싶기에, 두 라이브러리를 엮어줄 새로운 제네릭 클래스를 생성한다.\n`# type: ignore`를 남발하기에 그다지 좋은 모습이라고 생각되지 않지만, 이거 외에 당장 생각나는 방법이 없기에 일단 넘어가자.\n\n```bash\n❯ mkdir backend/app/services/authentication\n❯ mv backend/app/services/authentication.py backend/app/services/authentication/authentication.py\n❯ touch backend/app/services/authentication/__init__.py backend/app/services/authentication/convert.py\n```\n\n```python\n# backend/app/services/authentication/__init__.py\nfrom .authentication import *\n```\n\n```python\n# backend/app/services/authentication/convert.py\nfrom typing import Generic, TypeVar\n\nfrom fastapi_users import BaseUserManager, FastAPIUsers\nfrom fastapi_users.authentication import AuthenticationBackend, JWTStrategy, Strategy\nfrom fastapi_users.db import SQLAlchemyUserDatabase\n\nfrom ...models.core import base_model\nfrom ...models.user import user\n\nuser_id_type = user.id_type\n_T = TypeVar(\"_T\", bound=base_model)\n_D = TypeVar(\"_D\")\n\n# fmt: off\nclass user_db_class(SQLAlchemyUserDatabase[_T, _D], Generic[_T, _D]): ... # type: ignore\nclass strategy_class(Strategy[_T, _D], Generic[_T, _D]): ... # type: ignore\nclass jwt_strategy_class(JWTStrategy[_T, _D], Generic[_T, _D]): ... # type: ignore\nclass auth_backend_class(AuthenticationBackend[_T, _D], Generic[_T, _D]): ... # type: ignore\nclass user_manager_class(BaseUserManager[_T, _D], Generic[_T, _D]): ...  # type: ignore\nclass fastapi_users_class(FastAPIUsers[_T, _D], Generic[_T, _D]): ...  # type: ignore\n# fmt: on\n\n\nuser_manager_type = user_manager_class[user, user_id_type]\nstrategy_type = strategy_class[user, user_id_type]\n```\n\n### 변경점 인증 모듈에 적용\n\n```python\n# backend/app/services/authentication/authentication.py\nimport re\nfrom dataclasses import dataclass\nfrom re import Pattern\nfrom typing import AsyncGenerator, Sequence\n\nfrom fastapi import Depends, Request\nfrom fastapi_users import IntegerIDMixin, InvalidPasswordException\nfrom fastapi_users.authentication import BearerTransport, Transport\n\nfrom ...core import config\nfrom ...db.session import async_session, get_session\nfrom ...models import user\nfrom .convert import (\n    auth_backend_class,\n    fastapi_users_class,\n    jwt_strategy_class,\n    strategy_class,\n    strategy_type,\n    user_db_class,\n    user_id_type,\n    user_manager_class,\n    user_manager_type,\n)\n\n\nasync def get_user_db(\n    session: async_session = Depends(get_session),\n) -\u003e AsyncGenerator[user_db_class[user.user, user_id_type], None]:\n    yield user_db_class(session, user.user)\n\n\ndef create_transport() -\u003e Transport:\n    return BearerTransport(tokenUrl=config.TOKEN_PREFIX)\n\n\ndef create_strategy() -\u003e strategy_class[user.user, user_id_type]:\n    return jwt_strategy_class(  # type: ignore\n        secret=str(config.SECRET_KEY),\n        lifetime_seconds=config.ACCESS_TOKEN_EXPIRE_SECONDS,\n        token_audience=[config.JWT_AUDIENCE],\n        algorithm=config.JWT_ALGORITHM,\n    )\n\n\ndef create_backend() -\u003e list[auth_backend_class[user.user, user_id_type]]:\n    transport = create_transport()\n    return [\n        auth_backend_class(\n            name=config.AUTH_BACKEND_NAME,\n            transport=transport,\n            get_strategy=create_strategy,\n        )\n    ]\n\n\nclass UserManager(IntegerIDMixin, user_manager_class[user.user, user_id_type]):\n    reset_password_token_secret = str(config.SECRET_KEY)\n    verification_token_secret = str(config.SECRET_KEY)\n\n    min_password_length: int = 10\n    max_password_length: int = 30\n    re_password_need_list: list[Pattern] = [\n        re.compile(r\"[a-zA-Z]\"),\n        re.compile(r\"[0-9]\"),\n        re.compile(r\"[\\{\\}\\[\\]\\/?.,;:|\\)*~`!^\\-_+\u003c\u003e@\\#$%\u0026\\\\\\=\\(\\'\\\"]\"),\n    ]\n    re_password_deny_list: list[Pattern] = []\n\n    async def validate_password(\n        self, password: str, user: user.user_create | user.user\n    ) -\u003e None:\n        if len(password) \u003c self.min_password_length:\n            raise InvalidPasswordException(\n                reason=f\"Password should be at least {self.min_password_length} characters\"\n            )\n        elif len(password) \u003e self.max_password_length:\n            raise InvalidPasswordException(\n                reason=f\"Password should be at most {self.max_password_length} characters\"\n            )\n\n        for pattern in self.re_password_deny_list:\n            if pattern.search(password):\n                raise InvalidPasswordException(\n                    reason=f\"Password should not include {pattern.pattern}\"\n                )\n\n        for pattern in self.re_password_need_list:\n            if not pattern.search(password):\n                raise InvalidPasswordException(\n                    reason=f\"Password must include {pattern.pattern}\"\n                )\n\n    async def on_after_register(self, user: user.user, request: Request | None = None):\n        print(f\"User {user.id} has registered.\")\n\n    async def on_after_forgot_password(\n        self, user: user.user, token: str, request: Request | None = None\n    ):\n        print(f\"User {user.id} has forgot their password. Reset token: {token}\")\n\n    async def on_after_request_verify(\n        self, user: user.user, token: str, request: Request | None = None\n    ):\n        print(f\"Verification requested for user {user.id}. Verification token: {token}\")\n\n\nasync def get_user_manager(\n    user_db=Depends(get_user_db),\n) -\u003e AsyncGenerator[UserManager, None]:\n    yield UserManager(user_db)\n\n\ndef create_fastapi_users(\n    *backends: auth_backend_class[user.user, user_id_type],\n) -\u003e fastapi_users_class[user.user, user_id_type]:\n    return fastapi_users_class(\n        get_user_manager=get_user_manager, auth_backends=backends\n    )\n\n\n@dataclass(frozen=True)\nclass fastapi_user_class:\n    users: fastapi_users_class[user.user, user_id_type]\n\n    @classmethod\n    def init(cls) -\u003e \"fastapi_user_class\":\n        users = create_fastapi_users(*create_backend())\n        return cls(users=users)\n\n    @property\n    def backends(self) -\u003e Sequence[auth_backend_class[user.user, user_id_type]]:\n        return self.users.authenticator.backends  # type: ignore\n\n    @property\n    def user_manager_depends(self) -\u003e user_manager_type:\n        return Depends(self.users.get_user_manager)\n\n    def strategy_depends(self, num: int = 0, /) -\u003e strategy_type:\n        backend = self.backends[num]\n        return Depends(backend.get_strategy)\n```\n\n꽤 많이 바뀌긴 했지만, 실제로 사용할때는 이름정도만 바뀌지 사용법 자체는 변한게 없다. 바뀐 이름에 맞춰서 라우터와 테스트 코드를 수정해주면, 정상적으로 작동하는 것을 확인할 수 있다.\n\n이번 기회에 테스트 코드가 얼마나 좋은건지 알게됐다.. 긴가민가할때 `pytest --tb=short` 한방이면 의문이 해결된다.\n\n사실 변경할게 하나 더 남긴 했지만, 이거 아직 시도해보지 않았다.\n현재 헤더를 사용한 인증 방식인데, 쿠키를 사용하고, `access-token`과 `refresh-token`을 사용한 방식으로 변경해보려 한다. 다만 **`fastapi-users`** 자체적으로는 지원하지 않기에, 직접 작성할 필요가 있어서 약간 고민이 필요할듯.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/fastapi 튜토리얼 -8.2- FastAPI Users v10 대응","data":{"title":"fastapi 튜토리얼 -8.2- FastAPI Users v10 대응","date":"2022-05-07T23:00:58.369+09:00","tags":["fastapi","fastapi-users","python","sqlmodel","@all"],"page":"fastapi 튜토리얼","summary":"fastapi 사용법을 다시 공부할겸, 참고할만한 좋은 예제가 있어서 이 시리즈를 약간의 변경을 주고 따라가보려 한다."}},"next_post":{"name":"vim 영문 키보드 자동 전환","content":"\n# 아래 글은 퍼온 글입니다.\n출처는 다음과 같습니다.\n\n[[Vim] Normal모드에서 영문 키보드로 자동 전환하기 (Windows)](https://rottk.tistory.com/entry/Vim-Normal%EB%AA%A8%EB%93%9C%EC%97%90%EC%84%9C-%EC%98%81%EB%AC%B8-%ED%82%A4%EB%B3%B4%EB%93%9C%EB%A1%9C-%EC%A0%84%ED%99%98%ED%95%98%EA%B8%B0-Windows)\n\n---\n\n# Windows에서 `Vim`을 사용하는 경우 (`VSCode`의 `Vim Extension`, `WSL`에서의 `Vim`)\n`Vim` 사용 시 흔히 겪는 문제가 한글로 주석 작성 후, Normal 모드로 전환하여 명령어를 입력하면 명령어가 적용되지 않는 문제가 있습니다.\n\n예를 들어, 파일 저장을 위해 `ESC` + `:w` 를 입력하였으나, 실제로는 `ESC`, `:ㅈ`가 입력되어 저장이 되지 않는 경우입니다.\n\n`Vim`에서 한글을 입력하는 경우는 코드에 주석을 넣는 경우 이외에는 없으므로, Normal 모드로 전환 시(즉, `ESC`를 누르면) 영문으로 자동전환이 되도록 설정하면 이러한 문제가 해결될 것입니다.\n\n※ 간단히 IME에서 해당 기능을 제공해준다면 별도의 프로그램을 설치하지 않아도 되겠지만 아쉽게도 `Microsoft IME`는 설정 기능이 존재하지 않아 외부 프로그램(키 매크로)을 설치하여 도움을 받아야 합니다.\n* 윈도에 [Auto HotKey](https://www.autohotkey.com/)를 설치합니다.\n* 메모장에 `Script.ahk`를 만들어 아래의 Script를 작성합니다.\n* 작성한 스크립트를 더블 클릭하여 실행합니다. 이후, `ESC`를 누르면 자동으로 영문 키보드로 전환됩니다.\n\n```auto hotkey\n$Esc::\n    if(IME_CHECK(\"A\"))\n        Send, {VK15}    ;영문이라면 한영전환 키를 입력해준다.\n    Send, {Escape}\n    return\n\n/*\n  IME check \n*/\nIME_CHECK(WinTitle) {\n  WinGet,hWnd,ID,%WinTitle%\n  Return Send_ImeControl(ImmGetDefaultIMEWnd(hWnd),0x005,\"\")\n}\nSend_ImeControl(DefaultIMEWnd, wParam, lParam) {\n  DetectSave := A_DetectHiddenWindows\n  DetectHiddenWindows,ON\n   SendMessage 0x283, wParam,lParam,,ahk_id %DefaultIMEWnd%\n  if (DetectSave \u003c\u003e A_DetectHiddenWindows)\n      DetectHiddenWindows,%DetectSave%\n  return ErrorLevel\n}\nImmGetDefaultIMEWnd(hWnd) {\n  return DllCall(\"imm32\\ImmGetDefaultIMEWnd\", Uint,hWnd, Uint)\n}\n```\n\n## Windows 실행시 자동으로 Script 시작하기\nScript를 실행파일(.exe)로 변환합니다.\n\n1. `C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\AutoHotkey` 폴더로 이동합니다.\n2. `Convert .ahk to .exe`를 더블클릭하여 실행합니다.\n3. `Source`항목에서 앞서 작성한 `script.ahk`를 추가합니다.\n4. `Convert` 를 클릭합니다.\n5. 'Conversion complete' 팝업이 표시되면, .exe 파일이 스크립트와 같은 폴더에 생성됩니다.\n\n실행파일을 윈도우즈 시작프로그램으로 추가합니다.\n\n1. Windows 로고 키 + R을 누르고 `shell:startup`을 입력한 다음 확인을 선택합니다. 그러면 시작 폴더가 열립니다.\n2. 앞서 변환한 실행파일(.exe)을 복사하여 시작 폴더에 붙여넣습니다.\n\n# 출처\n* [https://github.com/johngrib/simple_vim_guide/blob/master/md/with_korean.md](https://github.com/johngrib/simple_vim_guide/blob/master/md/with_korean.md)\n* [https://www.autohotkey.com/](https://www.autohotkey.com/)\n* [Windows 10에서 시작할 때 자동으로 실행되는 앱 추가](https://support.microsoft.com/ko-kr/windows/windows-10%EC%97%90%EC%84%9C-%EC%8B%9C%EC%9E%91%ED%95%A0-%EB%95%8C-%EC%9E%90%EB%8F%99%EC%9C%BC%EB%A1%9C-%EC%8B%A4%ED%96%89%EB%90%98%EB%8A%94-%EC%95%B1-%EC%B6%94%EA%B0%80-150da165-dcd9-7230-517b-cf3c295d89dd)\n* [AHK Startup Under Windows 10](https://www.autohotkey.com/boards/viewtopic.php?t=15820)\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"other/vim 영문 키보드 자동 전환","data":{"title":"[Vim] Normal모드에서 영문 키보드로 자동 전환하기 (Windows)","tags":["windows","wsl","vim","@all"],"page":null,"summary":"esc를 누르면 자동으로 영문 키보드가 된다.","date":"2022-08-06T20:00:32.948+09:00"}},"page_posts":null},"__N_SSG":true},"page":"/posts/[...name]","query":{"name":["js","velog에서 git page로 블로그 이전"]},"buildId":"MQ_lMVQgBI0RkmUA6wvVT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>