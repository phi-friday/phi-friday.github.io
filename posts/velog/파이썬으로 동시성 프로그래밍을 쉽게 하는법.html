<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="author" content="phi.friday@gmail.com, phi"/><meta name="robots" content="index,follow,noarchive"/><meta name="google-site-verification" content="lW107Dj5ageygd67UUzTm-kGls5d-THy9jJQZqLoauw"/><title>phi.log - 파이썬으로 동시성 프로그래밍을 쉽게 하는법</title><link href="https://use.fontawesome.com/releases/v5.15.1/css/all.css" rel="stylesheet"/><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/e61452b80f7f8356.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e61452b80f7f8356.css" data-n-g=""/><link rel="preload" href="/_next/static/css/1f4d813b299120ae.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1f4d813b299120ae.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-5752944655d749a0.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-5dc3bdee87ff18dd.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f6271bdec05edb1f.js" defer=""></script><script src="/_next/static/chunks/996-f3cf67c2e3ac5e06.js" defer=""></script><script src="/_next/static/chunks/756-1349105dbea71525.js" defer=""></script><script src="/_next/static/chunks/3-4b8664ceef873544.js" defer=""></script><script src="/_next/static/chunks/224-ddba219ecdd5c904.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...name%5D-98f81935dc747879.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_buildManifest.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_ssgManifest.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><style>
      #nprogress {
        pointer-events: none;
      }
      #nprogress .bar {
        background: #29D;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
      }
      #nprogress .peg {
        display: block;
        position: absolute;
        right: 0px;
        width: 100px;
        height: 100%;
        box-shadow: 0 0 10px #29D, 0 0 5px #29D;
        opacity: 1;
        -webkit-transform: rotate(3deg) translate(0px, -4px);
        -ms-transform: rotate(3deg) translate(0px, -4px);
        transform: rotate(3deg) translate(0px, -4px);
      }
      #nprogress .spinner {
        display: block;
        position: fixed;
        z-index: 1031;
        top: 15px;
        right: 15px;
      }
      #nprogress .spinner-icon {
        width: 18px;
        height: 18px;
        box-sizing: border-box;
        border: solid 2px transparent;
        border-top-color: #29D;
        border-left-color: #29D;
        border-radius: 50%;
        -webkit-animation: nprogresss-spinner 400ms linear infinite;
        animation: nprogress-spinner 400ms linear infinite;
      }
      .nprogress-custom-parent {
        overflow: hidden;
        position: relative;
      }
      .nprogress-custom-parent #nprogress .spinner,
      .nprogress-custom-parent #nprogress .bar {
        position: absolute;
      }
      @-webkit-keyframes nprogress-spinner {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }
      @keyframes nprogress-spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style><div class="container" style="max-width:900px;min-width:400px"><div class="container default_app"><header><div class="container"><nav class="navbar-light fixed-top navbar navbar-expand-sm bg-light" role="navigation"><div class="container" style="max-width:900px"><div class="container-fluid"><ul class="navbar-nav w-100"><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-home"></i> Home</div></a></li><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/posts/@tag"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-hashtag"></i> Post</div></a></li><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/posts/@page"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-blog"></i> Page</div></a></li><div class="container d-flex justify-content-end align-self-center"><div class="row"><div class="col"><form class="input-group w-auto" method="get" action="https://www.google.com/search" target="_blank" style="min-width:230px"><input type="hidden" name="sitesearch" value="phi-friday.github.io"/><input type="search" class="form-control" placeholder="Search in Google" aria-label="Search" name="q" maxLength="255"/><button class="ripple ripple-surface btn btn-outline-primary" role="button"><i class="fa fa-search"></i></button></form></div></div></div></ul></div></div></nav></div></header><main><div class="container"><article><div class="row"><div class="display-6 mb-3">파이썬으로 동시성 프로그래밍을 쉽게 하는법</div><h6 class="mb-0 text-muted text-end"><time dateTime="2021-11-27T17:20:16.241+09:00">작성일: 2021년 11월 27일 17시 20분 16초</time></h6><h6 class="mt-0 text-muted text-end"><time dateTime="2022-08-13T00:12:20.000+09:00">수정일: 2022년 8월 13일 24시 12분 20초</time></h6><div class="d-flex justify-content-end"><div><span><span class="badge bg-info mx-1">#anyio<!-- --> </span></span><span><span class="badge bg-info mx-1">#async<!-- --> </span></span><span><span class="badge bg-info mx-1">#asyncio<!-- --> </span></span><span><span class="badge bg-info mx-1">#python<!-- --> </span></span><span><span class="badge bg-info mx-1">#trio<!-- --> </span></span></div></div></div><div class="row"><div class="mt-3 mb-5 border-top"></div></div><div class="row"><div><div class="toolbar"><div class="accordion mx-1 mb-4"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button">@Page: 파이썬 동시성 프로그래밍</button></h2><div id="1" class="collapse"><div class="accordion-body"><div href="velog/파이썬으로 동시성 프로그래밍을 쉽게 하는법"><a class="mb-2"><small class="text-muted">1<!-- -->. </small>파이썬으로 동시성 프로그래밍을 쉽게 하는법</a></div><div href="velog/파이썬으로 동시성 프로그래밍을 쉽게 하는법 - 2"><a class="mb-2"><small class="text-muted">2<!-- -->. </small>파이썬으로 동시성 프로그래밍을 쉽게 하는법 - 2</a></div></div></div></div></div></div><div class="markdown-body"><nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#동시성-프로그래밍이란">동시성 프로그래밍이란</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#asyncio-동시성-프로그래밍의-아주-간단한-예">asyncio, 동시성 프로그래밍의 아주 간단한 예</a><ol class="toc-level toc-level-3"><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#왜-timesleep이-아닌-asynciosleep인가">왜 time.sleep이 아닌 asyncio.sleep인가?</a></li></ol></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#하지만-뭔가-어색하다">하지만 뭔가 어색하다</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#trio-조금-더-현대적인-방식으로">trio, 조금 더 현대적인 방식으로</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#다른게-별로-없는데-왜-trio를-써야하지">다른게 별로 없는데 왜 trio를 써야하지</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#잘-작성된-document">잘 작성된 document</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#아쉽게도-기존-asyncio와-호환-안됨">아쉽게도 기존 asyncio와 호환 안됨</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#anyio-현대적-방식과-호환성을-한번에">anyio, 현대적 방식과 호환성을 한번에</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#상대적으로-빈약한-document">상대적으로 빈약한 document</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#내-선택은-anyio">내 선택은 anyio</a></li></ol></nav><h2 id="동시성-프로그래밍이란">동시성 프로그래밍이란</h2>
<p>동시성 프로그래밍은, <strong>한 사람이 두가지 이상의 일을 같이 작업하는 것</strong>을 말합니다.</p>
<p>예를 들자면, 한 사람이 세탁기를 돌리고, 세탁기가 돌아가던 중 설거지를 하고, 설거지를 하던 중 전화를 받고, 세탁기가 끝나서 빨래를 널고, 설거지를 마저 끝내는 것입니다.</p>
<p>이것을 만약 순차적으로 한다면, 세탁기를 돌리고 끝날 때 까지 기다린 다음 빨래를 널고, 이후 설거지를 합니다. 설거지가 끝나지 않았으니 전화는 받을 수 없고, 설거지가 끝난 다음 전화를 받습니다.</p>
<p>어떤 방식이 더 효율적인지는 따로 설명하지 않아도 알 수 있습니다.</p>
<h3 id="asyncio-동시성-프로그래밍의-아주-간단한-예"><code>asyncio</code>, 동시성 프로그래밍의 아주 간단한 예</h3>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-python" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#cc7832">import</span><span> asyncio
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span></span><span class="token" style="color:#cc7832">from</span><span> datetime </span><span class="token" style="color:#cc7832">import</span><span> datetime
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">just_sleep</span><span class="token" style="color:#a9b7c6">(</span><span>num</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#e8bf6a">int</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#e8bf6a">float</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span>    </span><span class="token" style="color:#cc7832">print</span><span class="token" style="color:#a9b7c6">(</span><span class="token string-interpolation" style="color:#6a8759">f&quot;</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">datetime</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">.</span><span class="token string-interpolation interpolation">today</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">(</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">)</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">:: </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">num</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">, </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">second</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759"> sleep start&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span>    </span><span class="token" style="color:#cc7832">await</span><span> asyncio</span><span class="token" style="color:#a9b7c6">.</span><span>sleep</span><span class="token" style="color:#a9b7c6">(</span><span>second</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span><span>    </span><span class="token" style="color:#cc7832">print</span><span class="token" style="color:#a9b7c6">(</span><span class="token string-interpolation" style="color:#6a8759">f&quot;</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">datetime</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">.</span><span class="token string-interpolation interpolation">today</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">(</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">)</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">:: </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">num</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">, </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">second</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759"> sleep end&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">11</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">main</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">12</span><span>    tasks </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#a9b7c6">[</span><span>just_sleep</span><span class="token" style="color:#a9b7c6">(</span><span>num</span><span class="token" style="color:#a9b7c6">,</span><span> </span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">)</span><span> </span><span class="token" style="color:#cc7832">for</span><span> num </span><span class="token" style="color:#cc7832">in</span><span> </span><span class="token" style="color:#e8bf6a">range</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6897bb">5</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">13</span><span>    </span><span class="token" style="color:#cc7832">await</span><span> asyncio</span><span class="token" style="color:#a9b7c6">.</span><span>gather</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">*</span><span>tasks</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">15</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">16</span><span></span><span class="token" style="color:#cc7832">if</span><span> __name__ </span><span class="token" style="color:#a9b7c6">==</span><span> </span><span class="token" style="color:#6a8759">&quot;__main__&quot;</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">17</span><span>    asyncio</span><span class="token" style="color:#a9b7c6">.</span><span>run</span><span class="token" style="color:#a9b7c6">(</span><span>main</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">)</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">python</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p><code>asyncio</code>는 파이썬의 동시성 프로그래밍을 위한 기본 라이브러리입니다. 동시성 프로그래밍을 위해서는 <code>async</code>와 <code>await</code> 키워드를 알아야 합니다.</p>
<blockquote>
<p><code>async</code>는 이 함수가 다른 작업을 위해 기다릴 수 있다는 것을 의미합니다.
<code>await</code>은 <code>async</code>로 정의된 함수가 기다리는 지점을 특정합니다.</p>
</blockquote>
<p>따라서 위 코드는 1초간 기다리는 5개의 작업을 실시하는 간단한 코드입니다.</p>
<blockquote>
<p>1초간 기다리 행위는, 데이터를 쓰거나 읽는 등의 작업이 걸리는 시간을 흉내내는 것입니다.</p>
</blockquote>
<p>실제로 실행해보면, 다음과 같은 출력을 얻습니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-log" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:17:25.901585</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">0</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep start
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:17:25.901626</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep start
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:17:25.901642</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">2</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep start
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:17:25.901653</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">3</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep start
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:17:25.901662</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">4</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep start
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:17:26.902915</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">0</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep end
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:17:26.902996</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep end
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:17:26.903025</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">2</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep end
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:17:26.903053</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">3</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep end
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:17:26.903080</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">4</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep end</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">log</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p><code>num=0</code>인 작업이 <code>await asyncio.sleep(sencond=1)</code>에서 1초간 대기하기 때문에, 그동안 <code>num=1</code>작업을 실행할 수 있습니다.</p>
<blockquote>
<h4 id="왜-timesleep이-아닌-asynciosleep인가">왜 <code>time.sleep</code>이 아닌 <code>asyncio.sleep</code>인가?</h4>
<p><code>time.sleep</code>은 블로킹 함수입니다. 블로킹 함수는 <code>async</code>로 정의되지 않아 기다릴 수 없는 함수입니다. 만약 <code>asyncio.sleep</code>대신 <code>time.sleep</code>을 사용한다면, io작업을 흉내낸다기 보다, cpu작업을 흉내내게 됩니다.</p>
</blockquote>
<h3 id="하지만-뭔가-어색하다">하지만 뭔가 어색하다</h3>
<p>구글에서 검색해서 얻을 수 있는 자료나, 시중에서 판매하는 책을 보면 <code>yield</code> 키워드를 쓴다던가, <code>ensure_future</code>를 쓴다던가, <code>get_running_loop</code>를 쓴다던가.. 최신의 <code>asyncio</code>의 사용법에 맞지 않은 방법을 소개하는 글이 많습니다.</p>
<blockquote>
<p>물론 <code>ensure_future</code>나 <code>get_running_loop</code>와 같은 함수를 쓸 수도 있습니다. 하지만 <strong>저수준 api를 다뤄야 할 때 필요하지, 대부분의 경우 그렇지 않습니다.</strong></p>
</blockquote>
<p>아직 파이썬에서 동시성 프로그래밍을 제대로 지원한지 얼마 되지 않아, 버전이 올라갈수록 변경사항이 많아서 이런 일이 생긴겁니다.</p>
<h2 id="trio-조금-더-현대적인-방식으로"><code>trio</code>, 조금 더 현대적인 방식으로</h2>
<p>그렇다면 차라리 더 최근에 만들어진 라이브러리를 사용하는게 어떨까요? 적어도 검색했을때 헷갈리는 일은 없을테니까요.</p>
<p>기본 라이브러리인 <code>asyncio</code> 대신 <code>trio</code>라는 라이브러리가 있습니다. 개인적으로 좋아하는 <code>open_nursery</code>라는 함수가 있습니다. <del>끔찍한 gather는 이제 그만두고</del> 앞에서 <code>asyncio</code>로 작성한 코드를 <code>trio</code>로는 어떻게 작성할 수 있을까요.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-python" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#cc7832">from</span><span> datetime </span><span class="token" style="color:#cc7832">import</span><span> datetime
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span></span><span class="token" style="color:#cc7832">import</span><span> trio
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">just_sleep</span><span class="token" style="color:#a9b7c6">(</span><span>num</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#e8bf6a">int</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#e8bf6a">float</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span>    </span><span class="token" style="color:#cc7832">print</span><span class="token" style="color:#a9b7c6">(</span><span class="token string-interpolation" style="color:#6a8759">f&quot;</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">datetime</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">.</span><span class="token string-interpolation interpolation">today</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">(</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">)</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">:: </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">num</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">, </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">second</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759"> sleep start&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span><span>    </span><span class="token" style="color:#cc7832">await</span><span> trio</span><span class="token" style="color:#a9b7c6">.</span><span>sleep</span><span class="token" style="color:#a9b7c6">(</span><span>second</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span><span>    </span><span class="token" style="color:#cc7832">print</span><span class="token" style="color:#a9b7c6">(</span><span class="token string-interpolation" style="color:#6a8759">f&quot;</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">datetime</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">.</span><span class="token string-interpolation interpolation">today</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">(</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">)</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">:: </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">num</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">, </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">second</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759"> sleep end&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">11</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">12</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">main</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">13</span><span>    </span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">with</span><span> trio</span><span class="token" style="color:#a9b7c6">.</span><span>open_nursery</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span> </span><span class="token" style="color:#cc7832">as</span><span> nursery</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">14</span><span>        </span><span class="token" style="color:#cc7832">for</span><span> num </span><span class="token" style="color:#cc7832">in</span><span> </span><span class="token" style="color:#e8bf6a">range</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6897bb">5</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">15</span><span>            nursery</span><span class="token" style="color:#a9b7c6">.</span><span>start_soon</span><span class="token" style="color:#a9b7c6">(</span><span>just_sleep</span><span class="token" style="color:#a9b7c6">,</span><span> num</span><span class="token" style="color:#a9b7c6">,</span><span> </span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">16</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">17</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">18</span><span></span><span class="token" style="color:#cc7832">if</span><span> __name__ </span><span class="token" style="color:#a9b7c6">==</span><span> </span><span class="token" style="color:#6a8759">&quot;__main__&quot;</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">19</span><span>    trio</span><span class="token" style="color:#a9b7c6">.</span><span>run</span><span class="token" style="color:#a9b7c6">(</span><span>main</span><span class="token" style="color:#a9b7c6">)</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">python</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p>사실 여기서 달라진건 많이 없습니다. 특징적인 부분은 <code>gather</code>로 작업을 모으는 대신, <code>nursery</code> 블록에서 <code>nursery.start_soon</code> 메소드로 <code>just_sleep</code> 작업 5개를 지시한 것입니다.</p>
<p>출력 결과를 보면 이전과 대동소이합니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-log" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:38:19.661314</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">4</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep start
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:38:19.661370</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">3</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep start
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:38:19.661393</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">2</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep start
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:38:19.661415</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep start
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:38:19.661434</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">0</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep start
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:38:20.662955</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">4</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep end
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:38:20.663113</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">3</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep end
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:38:20.663196</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">2</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep end
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:38:20.663272</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep end
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span><span></span><span class="token date" style="color:#6897bb">2021-11-27</span><span> </span><span class="token time" style="color:#6897bb">16:38:20.663347</span><span class="token" style="color:#a9b7c6">:</span><span class="token" style="color:#a9b7c6">:</span><span> num</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">0</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span> sleep end</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">log</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<h3 id="다른게-별로-없는데-왜-trio를-써야하지">다른게 별로 없는데 왜 <code>trio</code>를 써야하지</h3>
<p>위 코드만 봤을때, <code>trio</code>를 써서 얻는 이득은 그다지 없어 보입니다. 하지만 그건 지금 코드가 아주 간단한 형태로 작성되어 있기 때문에 그렇습니다. 이후 사용하게 될 <code>channel</code> (<code>anyio</code>에서는 <code>stream</code>) 과 <code>CancelScope</code>, <code>Semaphore</code> 에서 그 이점이 드러나게 됩니다.</p>
<h3 id="잘-작성된-document">잘 작성된 document</h3>
<p><code>trio</code>의 <a href="https://trio.readthedocs.io/en/stable/index.html">document</a>는 꽤 잘만들었다 생각합니다. 사용하다 막히는 부분이 있을때 따로 검색하기 보다는 공식 문서를 다시 한번 읽어보는게 도움이 되는 경우가 더 많았습니다.</p>
<h3 id="아쉽게도-기존-asyncio와-호환-안됨">아쉽게도 기존 asyncio와 호환 안됨</h3>
<p><code>trio</code>는 다 좋은데 기존 <code>asyncio</code>와 호환이 되지 않습니다. 즉, 이미 <code>asyncio</code>로 작성된 코드가 있다면 <code>trio</code>를 사용하기 위해서는 전부 수정을 해야합니다.</p>
<p>무엇보다도 <code>uvloop</code>를 지원하지 않습니다. <code>uvloop</code>는 간단한 사용법으로 파이썬 동시성 프로그래밍의 성능을 끌어올릴 수 있는데, <code>trio</code>에서는 사용할 수가 없습니다.</p>
<p>그렇다면 <code>trio</code>의 기능적 특징을 가지고, <code>asyncio</code>와 호환되고, <code>uvloop</code>도 지원하는 그런 라이브러리는 없을까요? <strong>있습니다.</strong> <code>anyio</code>라는 라이브러리를 사용하면 됩니다.</p>
<h2 id="anyio-현대적-방식과-호환성을-한번에"><code>anyio</code>, 현대적 방식과 호환성을 한번에</h2>
<p><code>anyio</code>는 <code>asyncio</code>와 <code>trio</code>를 둘 다 사용할 수 있습니다. <code>asyncio</code>를 사용하고 싶다면 백엔드로 <code>asyncio</code>를 지정하고, <code>trio</code>를 사용하고 싶다면 <code>trio</code>를 지정하기만 하면 됩니다. <code>uvloop</code>를 사용하고 싶다면? <code>use_uvloop=True</code> 파라미터를 입력하기만 하면 됩니다.</p>
<blockquote>
<p>그렇다면 <code>trio</code>의 기능을 사용하기 위해 무조건 백엔드를 <code>trio</code>로 지정해야 할까요? <strong>아닙니다.</strong> <code>anyio</code>는 <code>trio</code>의 기능을 <code>asyncio</code>로 구현한 라이브러리이기 때문에, <code>asyncio</code>를 백엔드로 사용해도 아무 문제가 없습니다.</p>
</blockquote>
<p>앞에서 <code>asyncio</code>와 <code>trio</code>로 작성했던 코드를 <code>anyio</code>로 다시 작성하겠습니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-python" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#cc7832">from</span><span> datetime </span><span class="token" style="color:#cc7832">import</span><span> datetime
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span></span><span class="token" style="color:#cc7832">import</span><span> anyio
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">just_sleep</span><span class="token" style="color:#a9b7c6">(</span><span>num</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#e8bf6a">int</span><span class="token" style="color:#a9b7c6">,</span><span> second</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#e8bf6a">float</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span>    </span><span class="token" style="color:#cc7832">print</span><span class="token" style="color:#a9b7c6">(</span><span class="token string-interpolation" style="color:#6a8759">f&quot;</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">datetime</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">.</span><span class="token string-interpolation interpolation">today</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">(</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">)</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">:: </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">num</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">, </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">second</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759"> sleep start&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span><span>    </span><span class="token" style="color:#cc7832">await</span><span> anyio</span><span class="token" style="color:#a9b7c6">.</span><span>sleep</span><span class="token" style="color:#a9b7c6">(</span><span>second</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span><span>    </span><span class="token" style="color:#cc7832">print</span><span class="token" style="color:#a9b7c6">(</span><span class="token string-interpolation" style="color:#6a8759">f&quot;</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">datetime</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">.</span><span class="token string-interpolation interpolation">today</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">(</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">)</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">:: </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">num</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759">, </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">second</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759"> sleep end&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">11</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">12</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">main</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">13</span><span>    </span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">with</span><span> anyio</span><span class="token" style="color:#a9b7c6">.</span><span>create_task_group</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span> </span><span class="token" style="color:#cc7832">as</span><span> task_group</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">14</span><span>        </span><span class="token" style="color:#cc7832">for</span><span> num </span><span class="token" style="color:#cc7832">in</span><span> </span><span class="token" style="color:#e8bf6a">range</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6897bb">5</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">15</span><span>            task_group</span><span class="token" style="color:#a9b7c6">.</span><span>start_soon</span><span class="token" style="color:#a9b7c6">(</span><span>just_sleep</span><span class="token" style="color:#a9b7c6">,</span><span> num</span><span class="token" style="color:#a9b7c6">,</span><span> </span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">16</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">17</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">18</span><span></span><span class="token" style="color:#cc7832">if</span><span> __name__ </span><span class="token" style="color:#a9b7c6">==</span><span> </span><span class="token" style="color:#6a8759">&quot;__main__&quot;</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">19</span><span>    anyio</span><span class="token" style="color:#a9b7c6">.</span><span>run</span><span class="token" style="color:#a9b7c6">(</span><span>main</span><span class="token" style="color:#a9b7c6">,</span><span> backend_options</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#e8bf6a">dict</span><span class="token" style="color:#a9b7c6">(</span><span>use_uvloop</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#cc7832">True</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">)</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">python</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<blockquote>
<p><code>uvloop</code> 사용이 가능하다는 것을 보이기 위해 <code>backend_options=dict(use_uvloop=True)</code> 파라미터를 추가했습니다. 추가하지 않아도 문제 없습니다.</p>
</blockquote>
<p><code>trio</code>로 작성된 코드와 차이점이 있다면 <code>trio.open_nursery</code>가 <code>anyio.create_task_group</code>로 바뀐 것 정도입니다. 실제로 대부분 용어의 문제지, <code>trio</code>에서 작성된 <a href="https://trio.readthedocs.io/en/stable/index.html">document</a>는 <code>anyio</code>에 대부분 적용이 가능합니다.</p>
<h3 id="상대적으로-빈약한-document">상대적으로 빈약한 document</h3>
<p><code>anyio</code>의 <a href="https://anyio.readthedocs.io/en/stable/index.html">document</a>는 상대적으로 좀 부족하다는 느낌을 받았습니다. 그래서 쓰다가 부족한 부분이 있으면 <code>trio</code>의 <a href="https://trio.readthedocs.io/en/stable/index.html">document</a>를 읽어보고, <code>trio</code>와 대응하는 <code>anyio</code>의 모듈을 찾아서 해결하곤 했습니다.</p>
<h2 id="내-선택은-anyio">내 선택은 <code>anyio</code></h2>
<p>저는 동시성 프로그래밍을 해야 할 일이 있으면 우선 <code>anyio</code>를 사용하는 편입니다. 특히 제가 좋아하는 프레임워크인 <code>fastapi</code>에서 <code>anyio</code>를 사용하기 때문에 거리낌 없이 사용할 수 있습니다. (<code>fastapi</code>에서 사용하는 <code>starlette</code>의 특정 버전부터 <code>anyio</code>를 지원하기 때문에 가능한 것으로, <code>anyio</code>를 사용하려면 버전 확인이 필요합니다.)</p>
<p>이후 글에서는 <code>anyio</code>의 메소드와 클래스를 활용하는 것에 대해 작성할 예정입니다.</p></div></div></div><div class="row"><div class="mt-5 mb-3 border-bottom"></div></div><div class="row"><span class="d-flex justify-content-between"><span><h6 class=""><i class="fa fa-angle-left mx-2"></i>FastAPI, sqlmodel로 간단한...</h6></span><span><h6 class="">파이썬으로 동시성 프로그래밍을 쉽게 하는법...<i class="fa fa-angle-right mx-2"></i></h6></span></span><div class="mt-3"><div><section style="width:100%"></section></div></div></div></article></div></main><footer class="text-center text-muted"></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"name":"파이썬으로 동시성 프로그래밍을 쉽게 하는법","content":"\n## 동시성 프로그래밍이란\n\n동시성 프로그래밍은, **한 사람이 두가지 이상의 일을 같이 작업하는 것**을 말합니다.\n\n예를 들자면, 한 사람이 세탁기를 돌리고, 세탁기가 돌아가던 중 설거지를 하고, 설거지를 하던 중 전화를 받고, 세탁기가 끝나서 빨래를 널고, 설거지를 마저 끝내는 것입니다.\n\n이것을 만약 순차적으로 한다면, 세탁기를 돌리고 끝날 때 까지 기다린 다음 빨래를 널고, 이후 설거지를 합니다. 설거지가 끝나지 않았으니 전화는 받을 수 없고, 설거지가 끝난 다음 전화를 받습니다.\n\n어떤 방식이 더 효율적인지는 따로 설명하지 않아도 알 수 있습니다.\n\n### `asyncio`, 동시성 프로그래밍의 아주 간단한 예\n\n```python\nimport asyncio\nfrom datetime import datetime\n\n\nasync def just_sleep(num: int, second: float):\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep start\")\n    await asyncio.sleep(second)\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep end\")\n\n\nasync def main():\n    tasks = [just_sleep(num, 1) for num in range(5)]\n    await asyncio.gather(*tasks)\n\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n```\n\n`asyncio`는 파이썬의 동시성 프로그래밍을 위한 기본 라이브러리입니다. 동시성 프로그래밍을 위해서는 `async`와 `await` 키워드를 알아야 합니다.\n\n\u003e `async`는 이 함수가 다른 작업을 위해 기다릴 수 있다는 것을 의미합니다.\n\u003e `await`은 `async`로 정의된 함수가 기다리는 지점을 특정합니다.\n\n따라서 위 코드는 1초간 기다리는 5개의 작업을 실시하는 간단한 코드입니다.\n\n\u003e 1초간 기다리 행위는, 데이터를 쓰거나 읽는 등의 작업이 걸리는 시간을 흉내내는 것입니다.\n\n실제로 실행해보면, 다음과 같은 출력을 얻습니다.\n\n```log\n2021-11-27 16:17:25.901585:: num=0, second=1 sleep start\n2021-11-27 16:17:25.901626:: num=1, second=1 sleep start\n2021-11-27 16:17:25.901642:: num=2, second=1 sleep start\n2021-11-27 16:17:25.901653:: num=3, second=1 sleep start\n2021-11-27 16:17:25.901662:: num=4, second=1 sleep start\n2021-11-27 16:17:26.902915:: num=0, second=1 sleep end\n2021-11-27 16:17:26.902996:: num=1, second=1 sleep end\n2021-11-27 16:17:26.903025:: num=2, second=1 sleep end\n2021-11-27 16:17:26.903053:: num=3, second=1 sleep end\n2021-11-27 16:17:26.903080:: num=4, second=1 sleep end\n```\n\n`num=0`인 작업이 `await asyncio.sleep(sencond=1)`에서 1초간 대기하기 때문에, 그동안 `num=1`작업을 실행할 수 있습니다.\n\n\u003e #### 왜 `time.sleep`이 아닌 `asyncio.sleep`인가?\n\u003e\n\u003e `time.sleep`은 블로킹 함수입니다. 블로킹 함수는 `async`로 정의되지 않아 기다릴 수 없는 함수입니다. 만약 `asyncio.sleep`대신 `time.sleep`을 사용한다면, io작업을 흉내낸다기 보다, cpu작업을 흉내내게 됩니다.\n\n### 하지만 뭔가 어색하다\n\n구글에서 검색해서 얻을 수 있는 자료나, 시중에서 판매하는 책을 보면 `yield` 키워드를 쓴다던가, `ensure_future`를 쓴다던가, `get_running_loop`를 쓴다던가.. 최신의 `asyncio`의 사용법에 맞지 않은 방법을 소개하는 글이 많습니다.\n\n\u003e 물론 `ensure_future`나 `get_running_loop`와 같은 함수를 쓸 수도 있습니다. 하지만 **저수준 api를 다뤄야 할 때 필요하지, 대부분의 경우 그렇지 않습니다.**\n\n아직 파이썬에서 동시성 프로그래밍을 제대로 지원한지 얼마 되지 않아, 버전이 올라갈수록 변경사항이 많아서 이런 일이 생긴겁니다.\n\n## `trio`, 조금 더 현대적인 방식으로\n\n그렇다면 차라리 더 최근에 만들어진 라이브러리를 사용하는게 어떨까요? 적어도 검색했을때 헷갈리는 일은 없을테니까요.\n\n기본 라이브러리인 `asyncio` 대신 `trio`라는 라이브러리가 있습니다. 개인적으로 좋아하는 `open_nursery`라는 함수가 있습니다. ~~끔찍한 gather는 이제 그만두고~~ 앞에서 `asyncio`로 작성한 코드를 `trio`로는 어떻게 작성할 수 있을까요.\n\n```python\nfrom datetime import datetime\n\nimport trio\n\n\nasync def just_sleep(num: int, second: float):\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep start\")\n    await trio.sleep(second)\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep end\")\n\n\nasync def main():\n    async with trio.open_nursery() as nursery:\n        for num in range(5):\n            nursery.start_soon(just_sleep, num, 1)\n\n\nif __name__ == \"__main__\":\n    trio.run(main)\n```\n\n사실 여기서 달라진건 많이 없습니다. 특징적인 부분은 `gather`로 작업을 모으는 대신, `nursery` 블록에서 `nursery.start_soon` 메소드로 `just_sleep` 작업 5개를 지시한 것입니다.\n\n출력 결과를 보면 이전과 대동소이합니다.\n\n```log\n2021-11-27 16:38:19.661314:: num=4, second=1 sleep start\n2021-11-27 16:38:19.661370:: num=3, second=1 sleep start\n2021-11-27 16:38:19.661393:: num=2, second=1 sleep start\n2021-11-27 16:38:19.661415:: num=1, second=1 sleep start\n2021-11-27 16:38:19.661434:: num=0, second=1 sleep start\n2021-11-27 16:38:20.662955:: num=4, second=1 sleep end\n2021-11-27 16:38:20.663113:: num=3, second=1 sleep end\n2021-11-27 16:38:20.663196:: num=2, second=1 sleep end\n2021-11-27 16:38:20.663272:: num=1, second=1 sleep end\n2021-11-27 16:38:20.663347:: num=0, second=1 sleep end\n```\n\n### 다른게 별로 없는데 왜 `trio`를 써야하지\n\n위 코드만 봤을때, `trio`를 써서 얻는 이득은 그다지 없어 보입니다. 하지만 그건 지금 코드가 아주 간단한 형태로 작성되어 있기 때문에 그렇습니다. 이후 사용하게 될 `channel` (`anyio`에서는 `stream`) 과 `CancelScope`, `Semaphore` 에서 그 이점이 드러나게 됩니다.\n\n### 잘 작성된 document\n\n`trio`의 [document](https://trio.readthedocs.io/en/stable/index.html)는 꽤 잘만들었다 생각합니다. 사용하다 막히는 부분이 있을때 따로 검색하기 보다는 공식 문서를 다시 한번 읽어보는게 도움이 되는 경우가 더 많았습니다.\n\n### 아쉽게도 기존 asyncio와 호환 안됨\n\n`trio`는 다 좋은데 기존 `asyncio`와 호환이 되지 않습니다. 즉, 이미 `asyncio`로 작성된 코드가 있다면 `trio`를 사용하기 위해서는 전부 수정을 해야합니다.\n\n무엇보다도 `uvloop`를 지원하지 않습니다. `uvloop`는 간단한 사용법으로 파이썬 동시성 프로그래밍의 성능을 끌어올릴 수 있는데, `trio`에서는 사용할 수가 없습니다.\n\n그렇다면 `trio`의 기능적 특징을 가지고, `asyncio`와 호환되고, `uvloop`도 지원하는 그런 라이브러리는 없을까요? **있습니다.** `anyio`라는 라이브러리를 사용하면 됩니다.\n\n## `anyio`, 현대적 방식과 호환성을 한번에\n\n`anyio`는 `asyncio`와 `trio`를 둘 다 사용할 수 있습니다. `asyncio`를 사용하고 싶다면 백엔드로 `asyncio`를 지정하고, `trio`를 사용하고 싶다면 `trio`를 지정하기만 하면 됩니다. `uvloop`를 사용하고 싶다면? `use_uvloop=True` 파라미터를 입력하기만 하면 됩니다.\n\n\u003e 그렇다면 `trio`의 기능을 사용하기 위해 무조건 백엔드를 `trio`로 지정해야 할까요? **아닙니다.** `anyio`는 `trio`의 기능을 `asyncio`로 구현한 라이브러리이기 때문에, `asyncio`를 백엔드로 사용해도 아무 문제가 없습니다.\n\n앞에서 `asyncio`와 `trio`로 작성했던 코드를 `anyio`로 다시 작성하겠습니다.\n\n```python\nfrom datetime import datetime\n\nimport anyio\n\n\nasync def just_sleep(num: int, second: float):\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep start\")\n    await anyio.sleep(second)\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep end\")\n\n\nasync def main():\n    async with anyio.create_task_group() as task_group:\n        for num in range(5):\n            task_group.start_soon(just_sleep, num, 1)\n\n\nif __name__ == \"__main__\":\n    anyio.run(main, backend_options=dict(use_uvloop=True))\n```\n\n\u003e `uvloop` 사용이 가능하다는 것을 보이기 위해 `backend_options=dict(use_uvloop=True)` 파라미터를 추가했습니다. 추가하지 않아도 문제 없습니다.\n\n`trio`로 작성된 코드와 차이점이 있다면 `trio.open_nursery`가 `anyio.create_task_group`로 바뀐 것 정도입니다. 실제로 대부분 용어의 문제지, `trio`에서 작성된 [document](https://trio.readthedocs.io/en/stable/index.html)는 `anyio`에 대부분 적용이 가능합니다.\n\n### 상대적으로 빈약한 document\n\n`anyio`의 [document](https://anyio.readthedocs.io/en/stable/index.html)는 상대적으로 좀 부족하다는 느낌을 받았습니다. 그래서 쓰다가 부족한 부분이 있으면 `trio`의 [document](https://trio.readthedocs.io/en/stable/index.html)를 읽어보고, `trio`와 대응하는 `anyio`의 모듈을 찾아서 해결하곤 했습니다.\n\n## 내 선택은 `anyio`\n\n저는 동시성 프로그래밍을 해야 할 일이 있으면 우선 `anyio`를 사용하는 편입니다. 특히 제가 좋아하는 프레임워크인 `fastapi`에서 `anyio`를 사용하기 때문에 거리낌 없이 사용할 수 있습니다. (`fastapi`에서 사용하는 `starlette`의 특정 버전부터 `anyio`를 지원하기 때문에 가능한 것으로, `anyio`를 사용하려면 버전 확인이 필요합니다.)\n\n이후 글에서는 `anyio`의 메소드와 클래스를 활용하는 것에 대해 작성할 예정입니다.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/파이썬으로 동시성 프로그래밍을 쉽게 하는법","data":{"title":"파이썬으로 동시성 프로그래밍을 쉽게 하는법","date":"2021-11-27T17:20:16.241+09:00","tags":["anyio","async","asyncio","python","trio","@all"],"page":"파이썬 동시성 프로그래밍","summary":"asyncio? trio? anyio!"}},"prev_post":{"name":"FastAPI, sqlmodel로 간단한 crud api 생성 4","content":"\n이제 기존에 작성한 `crud` api를 보완해보겠습니다.\n\n## 유저를 추가할때 중복 확인\n\n기존 작성된 `create` api는 입력받은 `body`를 그대로 db에 새로운 레코드로 추가하는 역할만 했습니다.\n이제 `email`속성을 기준으로 중복을 확인 한 다음 레코드로 추가할 수 있게 코드를 수정하겠습니다.\n\n```python\n# api/scripts/routes/user/crud.py\n(전략)\n\n@app.post(\"/create_user\", response_model=user.user)\nasync def create_user(data: user.user, *, session: AsyncSession = Depends(get_session)):\n    user_email = await session.exec(select(user.user.email))  # type: ignore\n    if data.email in user_email: # type: ignore\n        raise HTTPException(status_code=400, detail=\"동일한 email 유저 있음\")\n\n    user_instance = user.user.from_orm(data)\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n(후략)\n```\n\n이제 중복된 유저 데이터를 입력하면 다음과 같은 400에러와 함께 다음과 같은 값을 반환합니다.\n\n```json\n{\n  \"detail\": \"동일한 email 유저 있음\"\n}\n```\n\n로그를 확인해보면 다음과 같이 에러를 반환하는 것을 확인할 수 있습니다.\n\n```sql\nINFO sqlalchemy.engine.Engine BEGIN (implicit)\nINFO sqlalchemy.engine.Engine SELECT \"user\".email\nFROM \"user\"\nINFO sqlalchemy.engine.Engine [no key 0.00018s] ()\nINFO:     10.0.2.100:43750 - \"POST /user/create_user HTTP/1.1\" 400 Bad Request\nINFO sqlalchemy.engine.Engine ROLLBACK\n```\n\n만약 중복이 아닌 데이터를 입력하면, 다음과 같은 로그를 확인할 수 있습니다.\n\n```sql\nINFO sqlalchemy.engine.Engine BEGIN (implicit)\nINFO sqlalchemy.engine.Engine SELECT \"user\".email\nFROM \"user\"\nINFO sqlalchemy.engine.Engine [no key 0.00016s] ()\nINFO sqlalchemy.engine.Engine INSERT INTO \"user\" (name, email, registered_date) VALUES (%s, %s, %s) RETURNING \"user\".id\nINFO sqlalchemy.engine.Engine [cached since 276.6s ago] ('test', 'test@example.com', datetime.datetime(--))\nINFO sqlalchemy.engine.Engine COMMIT\nINFO sqlalchemy.engine.Engine BEGIN (implicit)\nINFO sqlalchemy.engine.Engine SELECT \"user\".id, \"user\".name, \"user\".email, \"user\".registered_date\nFROM \"user\"\nWHERE \"user\".id = %s\nINFO sqlalchemy.engine.Engine [cached since 276.6s ago] (3,)\nINFO:     10.0.2.100:43796 - \"POST /user/create_user HTTP/1.1\" 200 OK\nINFO sqlalchemy.engine.Engine ROLLBACK\n```\n\n\u003e 지금은 api 서버에서 처리하는 방법을 보이기 위해 이렇게 코드를 작성했습니다.\n\u003e 하지만 **더 간단하게 중복을 제외하는 방법**이 있습니다.\n\u003e `user.user` 모델을 정의할 때, `email` 필드에 `sa_column_kwargs={\"unique\": True}` 파라미터를 추가하면 됩니다.\n\u003e 그러면 api 서버가 아닌, db에서 중복을 확인하고, 에러를 반환할 것입니다.\n\u003e 다만, **이 에러에 대한 예외처리는 직접 해야합니다.**\n\n## 유저 정보를 수정한 최종 일자 기록\n\n기존 `user` 모델은 최초 입력 일자에 대한 정보만 보존하고, 수정한 일자에 대해서는 보존하지 않습니다. 이는 테이블에 새로운 필드를 추가해야 가능한 일이므로, `user`모델을 직접적으로 수정하겠습니다.\n\n```python\n# api/scripts/models/user/__init__.py\n(전략)\n\nclass user(SQLModel, table=True):\n    id: Optional[int] = Field(None, primary_key=True)\n    name: str = Field(..., min_length=1, nullable=False)\n    email: EmailStr = Field(..., nullable=False)\n    registered_date: datetime = Field(default_factory=datetime.today)\n    last_updated_date: datetime = Field(default_factory=datetime.today)\n```\n\n`last_updated_date` 필드만 추가하고 끝냈습니다.\n지금 이상태 그대로 진행하면 `update` api를 수정하더라도, 에러를 반환할 것입니다. 기존에 db 생성한 `user`테이블에는 `last_updated_date` 필드가 없기 때문입니다.\nsql의 `alter` 쿼리를 사용해도 되고, `sqlalchemy`의 `drop_all` 메소드를 사용해도 됩니다.\n지금은 개발 초기중의 초기이므로 `drop_all`로 해결하겠습니다.\n\n```python\n# api/scripts/database/default.py\n(전략)\n\nasync def create_model_table() -\u003e None:\n    async with engine.begin() as conn:\n        if settings.debug:\n            await conn.run_sync(SQLModel.metadata.drop_all)\n        await conn.run_sync(SQLModel.metadata.create_all)\n```\n\n기존에 없던 `await conn.run_sync(SQLModel.metadata.drop_all)`를 추가했습니다.\n`create_model_table`함수가 이미 서버를 시작할때 실행되도록 설정돼 있기 때문에, 이제 서버를 시작하면 작성한 모델에 대응하는 테이블을 모두 `drop`하고 다시 `create`할 것입니다.\n개발중에만 사용하자는 의미로 `settings.debug`를 확인하도록 했습니다. 실제로는 더 엄격하게 확인하는게 맞습니다.\n\n이제 `update` api를 수정하겠습니다.\n\n```python\n# api/scripts/routes/user/crud.py\n\nfrom datetime import datetime\n\nfrom fastapi import Depends, HTTPException, Path\nfrom sqlmodel import select\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom ...database import get_session\nfrom ...models import user\nfrom .app import app\n\n(중략)\n\n@app.patch(\"/update_user/{user_id}\", response_model=user.user)\nasync def update_user(\n    data: user.user,\n    user_id: int = Path(..., ge=1),\n    *,\n    session: AsyncSession = Depends(get_session),\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    update_data = data.dict(exclude_unset=True)\n    for key, value in update_data.items():\n        setattr(user_instance, key, value)\n\n    user_instance.last_updated_date = datetime.today()\n\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n(후략)\n```\n\n`user_instance.last_updated_date = datetime.today()`가 추가됐습니다.\n이제 정상적으로 `update` api가 실행되면, `last_update_date` 값이 변합니다.\n\n실제로 실행해보면, 다음과 같은 결과를 반환받습니다.\n\n```json\n{\n  \"id\": 1,\n  \"registered_date\": \"2021-11-26T23:59:37.359332\",\n  \"last_updated_date\": \"2021-11-26T23:59:52.837064\",\n  \"name\": \"aaa\",\n  \"email\": \"user@example.com\"\n}\n```\n\n## 각 api의 `response_model`과 `body` 형태 수정\n\n지금까지 작성된 `crud` api는 `delete`를 제외하고 `response_model=user.user` 파라미터를 가지고 있습니다. 이것은 반환한 값이 `user.user` 인스턴스이고, `user.user` 의 스키마로 데이터를 반환해라는 의미입니다.\n\n하지만 모든 api에서 그렇게 하는 것은 **위험한 일**입니다.\n지금은 따로 설정하지 않았지만 사용자의 **비밀번호**가 필드에 있을 수도 있고, **민감한 개인정보** 또한 가능합니다.\n\n또한 입력받는 `body` 역시 `user.user`의 스키마로 구성된 데이터를 받습니다. 하지만 이것은 불필요한 일이고, 어쩌면 **오류를 발생시킬 수도 있습니다.**\n\n사용자가 `user`를 추가할 때, `id`나 `registered_date`와 같이 레코드에 자동으로 입력되는 값은 **사용자가 입력한 값을 받을 필요도 없고, 받아선 안되는 값입니다.**\n\n따라서, 사용자가 입력하는 값과, 사용자에게 반환할 값에 대한 새로운 스키마가 필요합니다. 이에 대한 모델을 새로 생성하면서, 기존의 모델을 정의하는데 있어서 **약간의 변화**를 주겠습니다.\n\n```python\n# api/scripts/models/user/__init__.py\n\n(전략)\n\nclass user_base(SQLModel):\n    name: str = Field(..., min_length=1, nullable=False)\n    email: EmailStr = Field(..., nullable=False)\n\n\nclass user_create(user_base):\n    pass\n\n\nclass user_read(user_base):\n    id: int\n\n\nclass user_update(user_base):\n    name: Optional[str] = Field(None, min_length=1)\n    email: Optional[EmailStr] = None\n\n\nclass user(user_base, table=True):\n    id: Optional[int] = Field(None, primary_key=True)\n    registered_date: datetime = Field(default_factory=datetime.today)\n    last_updated_date: datetime = Field(default_factory=datetime.today)\n```\n\n`user_base`를 기준으로 `create`, `read`, `update`에 대응하는 모델과 `user` 테이블에 해당하는 모델을 생성했습니다.\n\n\u003e `user_update`는 `user_base`에서 정의된 모든 필드를 덮어씌우지만, 그렇지 않은 경우도 있을 수 있으니 일단 상속했습니다.\n\n이전에 `table=True` 파라미터가 있어야 db에 테이블이 생성된다고 한 적이 있습니다. 위 코드에서 확인할 수 있듯이, `user` 클래스만 `table=True` 파라미터를 가지고 있습니다. 따라서 `user` 클래스를 제외한 모델은 사실상 `pydantic`의 모델로 활용하게 됩니다.\n\n이제 이 모델을 적용한 `crud` api를 수정합니다.\n\n```python\n# api/scripts/routes/user/crud.py\n\n(전략)\n\n@app.post(\"/create_user\", response_model=user.user_read)\nasync def create_user(\n    data: user.user_create, *, session: AsyncSession = Depends(get_session)\n):\n    user_email = await session.exec(select(user.user.email))  # type: ignore\n    if data.email in user_email:  # type: ignore\n        raise HTTPException(status_code=400, detail=\"동일한 email 유저 있음\")\n\n    user_instance = user.user.from_orm(data)\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n@app.get(\"/get_user/{user_id}\", response_model=user.user_read)\nasync def get_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    return user_instance\n\n\n@app.patch(\"/update_user/{user_id}\", response_model=user.user_read)\nasync def update_user(\n    data: user.user_update,\n    user_id: int = Path(..., ge=1),\n    *,\n    session: AsyncSession = Depends(get_session),\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    update_data = data.dict(exclude_unset=True)\n    for key, value in update_data.items():\n        setattr(user_instance, key, value)\n\n    user_instance.last_updated_date = datetime.today()\n\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n@app.delete(\"/delete_user/{user_id}\")\nasync def delete_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    await session.delete(user_instance)\n    await session.commit()\n\n    return user_id\n```\n\n`reponse_model`을 `user.user_read`로 수정하고, `body`에 해당하는 `data`의 타입을 `user.user_create` 또는 `user.user_update`로 수정했습니다.\n`response_model`을 `user.user_read`로 정했기 때문에, `user.user` 인스턴스를 반환하더라도, `user.user_read`의 스키마에 따라 값이 반환됩니다.\n![](/images/9a191a49-09af-4cad-acf6-fe48c31b5fa5-docs.png)\ndocs에서 한 눈에 확인 가능합니다.\n\n## 끝으로..\n\n더 적고 싶은데, 더 적을게 뭐가 있을지 잘 모르겠어요.\n일단 여기서 중단\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/FastAPI, sqlmodel로 간단한 crud api 생성 4","data":{"title":"FastAPI, sqlmodel로 간단한 crud api 생성 4","date":"2021-11-27T00:28:51.285+09:00","tags":["crud","fastapi","python","sqlmodel","@all"],"page":"FastAPI, sqlmodel로 간단한 crud api 생성","summary":"이제 기존에 작성한 crud api를 보완해보겠습니다."}},"next_post":{"name":"파이썬으로 동시성 프로그래밍을 쉽게 하는법 - 2","content":"\n비동기 프로그래밍의 핵심은 무엇일까? 저는 **작업을 생성**하고, 각 작업의 **전환점을 명시**하고, 각 작업간 **정보를 주고받는 것**이라고 생각합니다.\n\n**전환점을 명시**하는 것은 `python`에 특별한 키워드로 추가됐기에, 명확합니다. 각 작업간 전환이 가능하다(`awaitable`이라고 하는 것 같습니다)는 것을 알리는 `async`와, 전환점을 명확하게 알리는 `await`입니다.\n\n그렇다면 **작업을 생성**하고, **정보를 주고받는 것**은 어떻게 해야할까요?\n\n## `anyio`의 작업 생성\n\n`anyio`는 `trio`의 작업 생성 방식을 따라합니다. 그리고 `trio`는 **암시적 동시성**이 없습니다. 따라서 모든 기능은 위에서 아래로 실행합니다.\n\n`trio`는 사용자가 작업을 생성할 때, 그 작업에 대한 책임을 지도록 설계되었습니다. 이 설계는 `async with` 블록으로 나타내며, 이 블록에서 `start_soon`메소드로 호출된 모든 `awaitable` 함수는 동시에 실행되는 하나의 작업으로 생성됩니다. `trio`는 이것을 `nursery`라고 명명했습니다.\n\n`anyio`에서는 이러한 과정을 `task_group`이라 명명해서 보다 직관적으로 알 수 있게 했습니다. 실제 코드로 확인해보겠습니다.\n\n```python\nfrom datetime import datetime\n\nimport anyio\n\n\nasync def just_sleep(num: int, second: float):\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep start\")\n    await anyio.sleep(second)\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep end\")\n\n\nasync def main():\n    async with anyio.create_task_group() as task_group:\n        for num in range(5):\n            task_group.start_soon(just_sleep, num, 5)\n        return\n\n\nif __name__ == \"__main__\":\n    print(f\"{datetime.today()}:: main start\")\n    result = anyio.run(main)\n    print(f\"{datetime.today()}:: main end??? {result=}\")\n```\n\n이 코드에서 실제로 실행되는 함수는 `main` 함수입니다. 이 함수의 코드를 확인해보면, 우선 `async with anyio.create_task_group`으로 `task_group`을 생성합니다. 그리고 이 `task_group` 블록 안에서 `task_group.start_soon`메소드를 이용하여 5개의 `just_sleep`을 호출했습니다.\n\n따라서 이 `task_group` 블록에는, 총 5개의 `just_sleep` 작업이 예정되어있습니다. 하지만 `task_group` 블록을 나가기 전에, `return` 키워드를 작성해서, `task_group` 블록에 5개의 작업을 호출한 직후 해당 함수를 종료하도록 했습니다.\n\n만약 의도한대로 실행된다면, 5개의 `just_sleep` 작업이 생성되지만, 그 직후 main 함수는 `None`을 반환하고, main end??? 는 main start 출력 이후 1초 내에 출력될 것입니다.\n\n```log\n2021-11-29 17:56:17.798277:: main start\n2021-11-29 17:56:17.800793:: num=0, second=5 sleep start\n2021-11-29 17:56:17.800829:: num=1, second=5 sleep start\n2021-11-29 17:56:17.800853:: num=2, second=5 sleep start\n2021-11-29 17:56:17.800869:: num=3, second=5 sleep start\n2021-11-29 17:56:17.800884:: num=4, second=5 sleep start\n2021-11-29 17:56:22.806281:: num=0, second=5 sleep end\n2021-11-29 17:56:22.806401:: num=1, second=5 sleep end\n2021-11-29 17:56:22.806443:: num=2, second=5 sleep end\n2021-11-29 17:56:22.806479:: num=3, second=5 sleep end\n2021-11-29 17:56:22.806513:: num=4, second=5 sleep end\n2021-11-29 17:56:22.807098:: main end??? result=None\n```\n\n하지만 실제 결과는, `return`과 무관하게 생성한 작업이 모두 끝난 이후 `return`이 실행됩니다. 즉, 사용자는 작업을 생성할 때, 각 작업을 어떤식으로든 완료되는 것을 확인 할 의무가 있습니다. 만약 작업 도중 `return`을 실행할 일이 있다면, 그에 맞는 조건을 설정하여 해당 `task_group`을 종료시킨 다음 `return`하는 것이 맞습니다.\n\n말이 길어졌기에, 요약하자면\n\n\u003e 1. `awaitable` 함수는 `async with anyio.create_task_group` 블록 내부에서 `task_group.start_soon` 메소드로 호출한다.\n\u003e 2. 생성된 작업은, 어떤식으로든 완료시켜야 한다.\n\n이 2가지만 기억해도 큰 문제가 없습니다.\n\n## `anyio`의 정보 주고받기\n\nanyio에서 정보를 주고받을때 사용하는 것을 `stream`이라고 합니다. 이 `stream`은 크게 두가지로 분류되는데, 바이트 스트림과 객체 스트림입니다.\n\n객체 스트림은 기존에 사용하던 큐와 거의 같은 형태로 사용이 가능합니다. `stream`의 버퍼 사이즈를 지정하고, 버퍼 사이즈 만큼 객체를 입력하고, 버퍼에 객체가 있으면 그 객체를 가져오는 간단한 방식입니다. `trio`에서는 `channel`이라고 명명합니다.\n\n바이트 스트림은 약간 다릅니다. 만약 사용자가 `b'qwe'`, `b'rty'`라는 두개의 바이트 객체를 입력했다면, 이 스트림에서 객체를 받을 때, `b'qwe'`, `b'rty'`라고 받을 수도 있지만, `b'q'`, `b'wer'`, `b'ty'`라고 받을 수도 있고, `b'qwert'`, `b'y'`라고 받을 수도 있습니다. `trio`에서는 `stream`이라고 명명합니다.\n\n실제로 `stream`을 사용하는 코드로 확인하겠습니다.\n\n```python\nfrom datetime import datetime\nfrom random import uniform\n\nimport anyio\nfrom anyio.abc import ObjectReceiveStream, ObjectSendStream\n\n\nasync def ping(num: int, send: ObjectSendStream):\n    print(f\"{datetime.today()}:: {num=}, ping start\")\n    async with send:\n        sleep_time = uniform(0, 3)\n        await anyio.sleep(sleep_time)\n        await send.send((f\"ping from {num=}, {sleep_time=}\", sleep_time))\n    print(f\"{datetime.today()}:: {num=}, ping end\")\n\n\nasync def pong(receive: ObjectReceiveStream):\n    sleep_time_sum = 0\n    print(f\"{datetime.today()}:: pong start\")\n    async for text, sleep_time in receive:\n        print(f\"{datetime.today()}:: pong:: {text}\")\n        sleep_time_sum += sleep_time\n    print(f\"{datetime.today()}:: pong end:: {sleep_time_sum=}\")\n\n\nasync def main():\n    async with anyio.create_task_group() as task_group:\n        send, receive = anyio.create_memory_object_stream(0)\n        async with send:\n            for num in range(5):\n                task_group.start_soon(ping, num, send.clone())\n        async with receive:\n            task_group.start_soon(pong, receive.clone())\n\n\nif __name__ == \"__main__\":\n    result = anyio.run(main)\n```\n\n우선 `main`함수부터 확인하겠습니다.\n\n`create_task_group`으로 `task_group` 블록을 생성합니다. 그리고 `create_memory_object_stream`으로 각 작업간 정보를 주고받기 위한 `stream`을 생성합니다.\n\n\u003e 이때 생성된 `stream`은 send와 receive 두개로 나뉘어 반환됩니다.\n\n이어서 5개의 `ping`과 1개의 `pong` 작업을 호출해서, 실제로 `main`을 실행할 때 실행될 작업을 지정합니다.\n\n여기서 사용되는 `async with send`와 `async with receive`는 안전한 프로그래밍을 위해 필요한 문법으로, 해당 블록이 끝나면 따로 `close` 메소드를 호출 할 필요 없이, 자동으로 해당 객체를 닫습니다.\n\n그리고 `start_soon`으로 호출되는 각 작업에 send와 receive를 보낼 때 사용되는 `clone`메소드는, 해당 `stream`의 새로운 send와 receive를 생성해서 보내기 위해서 사용됩니다. 만약 send나 receive를 사용하는 작업이 하나가 아닐 때 `clone` 메소드를 사용하지 않는다면, 의도치 않은 `ClosedResourceError`를 만나게 될 수 있습니다.\n\n`main`에서 호출된 작업은 간단합니다.\n`ping`은 0~3초 사이의 랜덤한 시간동안 대기한 다음, 해당 시간에 대한 정보를 send를 이용해서 보냅니다.\n`pong`은 receive를 통해 받은 정보를 출력하고, 합산합니다.\n또한, 각 `ping` 작업은 `main`에서 사용된 방식과 같은 방식으로 `async with` 블록으로 구성되어 있으므로, 따로 `close` 메소드를 호출 할 필요가 없습니다.\n\n이 방식은 상당히 유용한데, 모든 send가 닫히고, 더이상 버퍼에 정보가 없다면 `async for` 블록 또한 자동으로 닫히게 됩니다.\n\n위 코드를 실행해보면 다음과 같은 출력을 확인할 수 있습니다.\n\n```log\n2021-11-29 18:34:55.095995:: num=0, ping start\n2021-11-29 18:34:55.096041:: num=1, ping start\n2021-11-29 18:34:55.096056:: num=2, ping start\n2021-11-29 18:34:55.096068:: num=3, ping start\n2021-11-29 18:34:55.096080:: num=4, ping start\n2021-11-29 18:34:55.096091:: pong start\n2021-11-29 18:34:55.348744:: num=4, ping end\n2021-11-29 18:34:55.348931:: pong:: ping from num=4, sleep_time=0.25142686937439906\n2021-11-29 18:34:56.042114:: num=3, ping end\n2021-11-29 18:34:56.042310:: pong:: ping from num=3, sleep_time=0.9448073290170278\n2021-11-29 18:34:56.779485:: num=1, ping end\n2021-11-29 18:34:56.779686:: pong:: ping from num=1, sleep_time=1.6822150526554853\n2021-11-29 18:34:56.925375:: num=2, ping end\n2021-11-29 18:34:56.925595:: pong:: ping from num=2, sleep_time=1.8275787340996095\n2021-11-29 18:34:57.535689:: num=0, ping end\n2021-11-29 18:34:57.535911:: pong:: ping from num=0, sleep_time=2.4386441219878816\n2021-11-29 18:34:57.536030:: pong end:: sleep_time_sum=7.144672107134403\n```\n\n바이트 스트림 또한 대동소이합니다.\n\n요약하자면\n\n\u003e 1. 바이트 스트림과 객체 스트림으로 정보를 주고받을 수 있다.\n\u003e 2. send와 receive 두개로 나누어 사용한다.\n\u003e 3. send 또는 receive를 사용하는 작업이 여러개라면 `clone` 메소드를 사용한다.\n\u003e 4. `async with`, `async for`를 사용하면 좀 더 깔끔하고 명확하게 작성할 수 있다.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/파이썬으로 동시성 프로그래밍을 쉽게 하는법 - 2","data":{"title":"파이썬으로 동시성 프로그래밍을 쉽게 하는법 - 2","date":"2021-11-29T18:42:54.419+09:00","tags":["anyio","async","python","@all"],"page":"파이썬 동시성 프로그래밍","summary":"anyio로 작업 생성 + 작업간 정보 주고받기"}},"page_posts":[{"name":"파이썬으로 동시성 프로그래밍을 쉽게 하는법","content":"\n## 동시성 프로그래밍이란\n\n동시성 프로그래밍은, **한 사람이 두가지 이상의 일을 같이 작업하는 것**을 말합니다.\n\n예를 들자면, 한 사람이 세탁기를 돌리고, 세탁기가 돌아가던 중 설거지를 하고, 설거지를 하던 중 전화를 받고, 세탁기가 끝나서 빨래를 널고, 설거지를 마저 끝내는 것입니다.\n\n이것을 만약 순차적으로 한다면, 세탁기를 돌리고 끝날 때 까지 기다린 다음 빨래를 널고, 이후 설거지를 합니다. 설거지가 끝나지 않았으니 전화는 받을 수 없고, 설거지가 끝난 다음 전화를 받습니다.\n\n어떤 방식이 더 효율적인지는 따로 설명하지 않아도 알 수 있습니다.\n\n### `asyncio`, 동시성 프로그래밍의 아주 간단한 예\n\n```python\nimport asyncio\nfrom datetime import datetime\n\n\nasync def just_sleep(num: int, second: float):\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep start\")\n    await asyncio.sleep(second)\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep end\")\n\n\nasync def main():\n    tasks = [just_sleep(num, 1) for num in range(5)]\n    await asyncio.gather(*tasks)\n\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n```\n\n`asyncio`는 파이썬의 동시성 프로그래밍을 위한 기본 라이브러리입니다. 동시성 프로그래밍을 위해서는 `async`와 `await` 키워드를 알아야 합니다.\n\n\u003e `async`는 이 함수가 다른 작업을 위해 기다릴 수 있다는 것을 의미합니다.\n\u003e `await`은 `async`로 정의된 함수가 기다리는 지점을 특정합니다.\n\n따라서 위 코드는 1초간 기다리는 5개의 작업을 실시하는 간단한 코드입니다.\n\n\u003e 1초간 기다리 행위는, 데이터를 쓰거나 읽는 등의 작업이 걸리는 시간을 흉내내는 것입니다.\n\n실제로 실행해보면, 다음과 같은 출력을 얻습니다.\n\n```log\n2021-11-27 16:17:25.901585:: num=0, second=1 sleep start\n2021-11-27 16:17:25.901626:: num=1, second=1 sleep start\n2021-11-27 16:17:25.901642:: num=2, second=1 sleep start\n2021-11-27 16:17:25.901653:: num=3, second=1 sleep start\n2021-11-27 16:17:25.901662:: num=4, second=1 sleep start\n2021-11-27 16:17:26.902915:: num=0, second=1 sleep end\n2021-11-27 16:17:26.902996:: num=1, second=1 sleep end\n2021-11-27 16:17:26.903025:: num=2, second=1 sleep end\n2021-11-27 16:17:26.903053:: num=3, second=1 sleep end\n2021-11-27 16:17:26.903080:: num=4, second=1 sleep end\n```\n\n`num=0`인 작업이 `await asyncio.sleep(sencond=1)`에서 1초간 대기하기 때문에, 그동안 `num=1`작업을 실행할 수 있습니다.\n\n\u003e #### 왜 `time.sleep`이 아닌 `asyncio.sleep`인가?\n\u003e\n\u003e `time.sleep`은 블로킹 함수입니다. 블로킹 함수는 `async`로 정의되지 않아 기다릴 수 없는 함수입니다. 만약 `asyncio.sleep`대신 `time.sleep`을 사용한다면, io작업을 흉내낸다기 보다, cpu작업을 흉내내게 됩니다.\n\n### 하지만 뭔가 어색하다\n\n구글에서 검색해서 얻을 수 있는 자료나, 시중에서 판매하는 책을 보면 `yield` 키워드를 쓴다던가, `ensure_future`를 쓴다던가, `get_running_loop`를 쓴다던가.. 최신의 `asyncio`의 사용법에 맞지 않은 방법을 소개하는 글이 많습니다.\n\n\u003e 물론 `ensure_future`나 `get_running_loop`와 같은 함수를 쓸 수도 있습니다. 하지만 **저수준 api를 다뤄야 할 때 필요하지, 대부분의 경우 그렇지 않습니다.**\n\n아직 파이썬에서 동시성 프로그래밍을 제대로 지원한지 얼마 되지 않아, 버전이 올라갈수록 변경사항이 많아서 이런 일이 생긴겁니다.\n\n## `trio`, 조금 더 현대적인 방식으로\n\n그렇다면 차라리 더 최근에 만들어진 라이브러리를 사용하는게 어떨까요? 적어도 검색했을때 헷갈리는 일은 없을테니까요.\n\n기본 라이브러리인 `asyncio` 대신 `trio`라는 라이브러리가 있습니다. 개인적으로 좋아하는 `open_nursery`라는 함수가 있습니다. ~~끔찍한 gather는 이제 그만두고~~ 앞에서 `asyncio`로 작성한 코드를 `trio`로는 어떻게 작성할 수 있을까요.\n\n```python\nfrom datetime import datetime\n\nimport trio\n\n\nasync def just_sleep(num: int, second: float):\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep start\")\n    await trio.sleep(second)\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep end\")\n\n\nasync def main():\n    async with trio.open_nursery() as nursery:\n        for num in range(5):\n            nursery.start_soon(just_sleep, num, 1)\n\n\nif __name__ == \"__main__\":\n    trio.run(main)\n```\n\n사실 여기서 달라진건 많이 없습니다. 특징적인 부분은 `gather`로 작업을 모으는 대신, `nursery` 블록에서 `nursery.start_soon` 메소드로 `just_sleep` 작업 5개를 지시한 것입니다.\n\n출력 결과를 보면 이전과 대동소이합니다.\n\n```log\n2021-11-27 16:38:19.661314:: num=4, second=1 sleep start\n2021-11-27 16:38:19.661370:: num=3, second=1 sleep start\n2021-11-27 16:38:19.661393:: num=2, second=1 sleep start\n2021-11-27 16:38:19.661415:: num=1, second=1 sleep start\n2021-11-27 16:38:19.661434:: num=0, second=1 sleep start\n2021-11-27 16:38:20.662955:: num=4, second=1 sleep end\n2021-11-27 16:38:20.663113:: num=3, second=1 sleep end\n2021-11-27 16:38:20.663196:: num=2, second=1 sleep end\n2021-11-27 16:38:20.663272:: num=1, second=1 sleep end\n2021-11-27 16:38:20.663347:: num=0, second=1 sleep end\n```\n\n### 다른게 별로 없는데 왜 `trio`를 써야하지\n\n위 코드만 봤을때, `trio`를 써서 얻는 이득은 그다지 없어 보입니다. 하지만 그건 지금 코드가 아주 간단한 형태로 작성되어 있기 때문에 그렇습니다. 이후 사용하게 될 `channel` (`anyio`에서는 `stream`) 과 `CancelScope`, `Semaphore` 에서 그 이점이 드러나게 됩니다.\n\n### 잘 작성된 document\n\n`trio`의 [document](https://trio.readthedocs.io/en/stable/index.html)는 꽤 잘만들었다 생각합니다. 사용하다 막히는 부분이 있을때 따로 검색하기 보다는 공식 문서를 다시 한번 읽어보는게 도움이 되는 경우가 더 많았습니다.\n\n### 아쉽게도 기존 asyncio와 호환 안됨\n\n`trio`는 다 좋은데 기존 `asyncio`와 호환이 되지 않습니다. 즉, 이미 `asyncio`로 작성된 코드가 있다면 `trio`를 사용하기 위해서는 전부 수정을 해야합니다.\n\n무엇보다도 `uvloop`를 지원하지 않습니다. `uvloop`는 간단한 사용법으로 파이썬 동시성 프로그래밍의 성능을 끌어올릴 수 있는데, `trio`에서는 사용할 수가 없습니다.\n\n그렇다면 `trio`의 기능적 특징을 가지고, `asyncio`와 호환되고, `uvloop`도 지원하는 그런 라이브러리는 없을까요? **있습니다.** `anyio`라는 라이브러리를 사용하면 됩니다.\n\n## `anyio`, 현대적 방식과 호환성을 한번에\n\n`anyio`는 `asyncio`와 `trio`를 둘 다 사용할 수 있습니다. `asyncio`를 사용하고 싶다면 백엔드로 `asyncio`를 지정하고, `trio`를 사용하고 싶다면 `trio`를 지정하기만 하면 됩니다. `uvloop`를 사용하고 싶다면? `use_uvloop=True` 파라미터를 입력하기만 하면 됩니다.\n\n\u003e 그렇다면 `trio`의 기능을 사용하기 위해 무조건 백엔드를 `trio`로 지정해야 할까요? **아닙니다.** `anyio`는 `trio`의 기능을 `asyncio`로 구현한 라이브러리이기 때문에, `asyncio`를 백엔드로 사용해도 아무 문제가 없습니다.\n\n앞에서 `asyncio`와 `trio`로 작성했던 코드를 `anyio`로 다시 작성하겠습니다.\n\n```python\nfrom datetime import datetime\n\nimport anyio\n\n\nasync def just_sleep(num: int, second: float):\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep start\")\n    await anyio.sleep(second)\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep end\")\n\n\nasync def main():\n    async with anyio.create_task_group() as task_group:\n        for num in range(5):\n            task_group.start_soon(just_sleep, num, 1)\n\n\nif __name__ == \"__main__\":\n    anyio.run(main, backend_options=dict(use_uvloop=True))\n```\n\n\u003e `uvloop` 사용이 가능하다는 것을 보이기 위해 `backend_options=dict(use_uvloop=True)` 파라미터를 추가했습니다. 추가하지 않아도 문제 없습니다.\n\n`trio`로 작성된 코드와 차이점이 있다면 `trio.open_nursery`가 `anyio.create_task_group`로 바뀐 것 정도입니다. 실제로 대부분 용어의 문제지, `trio`에서 작성된 [document](https://trio.readthedocs.io/en/stable/index.html)는 `anyio`에 대부분 적용이 가능합니다.\n\n### 상대적으로 빈약한 document\n\n`anyio`의 [document](https://anyio.readthedocs.io/en/stable/index.html)는 상대적으로 좀 부족하다는 느낌을 받았습니다. 그래서 쓰다가 부족한 부분이 있으면 `trio`의 [document](https://trio.readthedocs.io/en/stable/index.html)를 읽어보고, `trio`와 대응하는 `anyio`의 모듈을 찾아서 해결하곤 했습니다.\n\n## 내 선택은 `anyio`\n\n저는 동시성 프로그래밍을 해야 할 일이 있으면 우선 `anyio`를 사용하는 편입니다. 특히 제가 좋아하는 프레임워크인 `fastapi`에서 `anyio`를 사용하기 때문에 거리낌 없이 사용할 수 있습니다. (`fastapi`에서 사용하는 `starlette`의 특정 버전부터 `anyio`를 지원하기 때문에 가능한 것으로, `anyio`를 사용하려면 버전 확인이 필요합니다.)\n\n이후 글에서는 `anyio`의 메소드와 클래스를 활용하는 것에 대해 작성할 예정입니다.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/파이썬으로 동시성 프로그래밍을 쉽게 하는법","data":{"title":"파이썬으로 동시성 프로그래밍을 쉽게 하는법","date":"2021-11-27T17:20:16.241+09:00","tags":["anyio","async","asyncio","python","trio","@all"],"page":"파이썬 동시성 프로그래밍","summary":"asyncio? trio? anyio!"}},{"name":"파이썬으로 동시성 프로그래밍을 쉽게 하는법 - 2","content":"\n비동기 프로그래밍의 핵심은 무엇일까? 저는 **작업을 생성**하고, 각 작업의 **전환점을 명시**하고, 각 작업간 **정보를 주고받는 것**이라고 생각합니다.\n\n**전환점을 명시**하는 것은 `python`에 특별한 키워드로 추가됐기에, 명확합니다. 각 작업간 전환이 가능하다(`awaitable`이라고 하는 것 같습니다)는 것을 알리는 `async`와, 전환점을 명확하게 알리는 `await`입니다.\n\n그렇다면 **작업을 생성**하고, **정보를 주고받는 것**은 어떻게 해야할까요?\n\n## `anyio`의 작업 생성\n\n`anyio`는 `trio`의 작업 생성 방식을 따라합니다. 그리고 `trio`는 **암시적 동시성**이 없습니다. 따라서 모든 기능은 위에서 아래로 실행합니다.\n\n`trio`는 사용자가 작업을 생성할 때, 그 작업에 대한 책임을 지도록 설계되었습니다. 이 설계는 `async with` 블록으로 나타내며, 이 블록에서 `start_soon`메소드로 호출된 모든 `awaitable` 함수는 동시에 실행되는 하나의 작업으로 생성됩니다. `trio`는 이것을 `nursery`라고 명명했습니다.\n\n`anyio`에서는 이러한 과정을 `task_group`이라 명명해서 보다 직관적으로 알 수 있게 했습니다. 실제 코드로 확인해보겠습니다.\n\n```python\nfrom datetime import datetime\n\nimport anyio\n\n\nasync def just_sleep(num: int, second: float):\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep start\")\n    await anyio.sleep(second)\n    print(f\"{datetime.today()}:: {num=}, {second=} sleep end\")\n\n\nasync def main():\n    async with anyio.create_task_group() as task_group:\n        for num in range(5):\n            task_group.start_soon(just_sleep, num, 5)\n        return\n\n\nif __name__ == \"__main__\":\n    print(f\"{datetime.today()}:: main start\")\n    result = anyio.run(main)\n    print(f\"{datetime.today()}:: main end??? {result=}\")\n```\n\n이 코드에서 실제로 실행되는 함수는 `main` 함수입니다. 이 함수의 코드를 확인해보면, 우선 `async with anyio.create_task_group`으로 `task_group`을 생성합니다. 그리고 이 `task_group` 블록 안에서 `task_group.start_soon`메소드를 이용하여 5개의 `just_sleep`을 호출했습니다.\n\n따라서 이 `task_group` 블록에는, 총 5개의 `just_sleep` 작업이 예정되어있습니다. 하지만 `task_group` 블록을 나가기 전에, `return` 키워드를 작성해서, `task_group` 블록에 5개의 작업을 호출한 직후 해당 함수를 종료하도록 했습니다.\n\n만약 의도한대로 실행된다면, 5개의 `just_sleep` 작업이 생성되지만, 그 직후 main 함수는 `None`을 반환하고, main end??? 는 main start 출력 이후 1초 내에 출력될 것입니다.\n\n```log\n2021-11-29 17:56:17.798277:: main start\n2021-11-29 17:56:17.800793:: num=0, second=5 sleep start\n2021-11-29 17:56:17.800829:: num=1, second=5 sleep start\n2021-11-29 17:56:17.800853:: num=2, second=5 sleep start\n2021-11-29 17:56:17.800869:: num=3, second=5 sleep start\n2021-11-29 17:56:17.800884:: num=4, second=5 sleep start\n2021-11-29 17:56:22.806281:: num=0, second=5 sleep end\n2021-11-29 17:56:22.806401:: num=1, second=5 sleep end\n2021-11-29 17:56:22.806443:: num=2, second=5 sleep end\n2021-11-29 17:56:22.806479:: num=3, second=5 sleep end\n2021-11-29 17:56:22.806513:: num=4, second=5 sleep end\n2021-11-29 17:56:22.807098:: main end??? result=None\n```\n\n하지만 실제 결과는, `return`과 무관하게 생성한 작업이 모두 끝난 이후 `return`이 실행됩니다. 즉, 사용자는 작업을 생성할 때, 각 작업을 어떤식으로든 완료되는 것을 확인 할 의무가 있습니다. 만약 작업 도중 `return`을 실행할 일이 있다면, 그에 맞는 조건을 설정하여 해당 `task_group`을 종료시킨 다음 `return`하는 것이 맞습니다.\n\n말이 길어졌기에, 요약하자면\n\n\u003e 1. `awaitable` 함수는 `async with anyio.create_task_group` 블록 내부에서 `task_group.start_soon` 메소드로 호출한다.\n\u003e 2. 생성된 작업은, 어떤식으로든 완료시켜야 한다.\n\n이 2가지만 기억해도 큰 문제가 없습니다.\n\n## `anyio`의 정보 주고받기\n\nanyio에서 정보를 주고받을때 사용하는 것을 `stream`이라고 합니다. 이 `stream`은 크게 두가지로 분류되는데, 바이트 스트림과 객체 스트림입니다.\n\n객체 스트림은 기존에 사용하던 큐와 거의 같은 형태로 사용이 가능합니다. `stream`의 버퍼 사이즈를 지정하고, 버퍼 사이즈 만큼 객체를 입력하고, 버퍼에 객체가 있으면 그 객체를 가져오는 간단한 방식입니다. `trio`에서는 `channel`이라고 명명합니다.\n\n바이트 스트림은 약간 다릅니다. 만약 사용자가 `b'qwe'`, `b'rty'`라는 두개의 바이트 객체를 입력했다면, 이 스트림에서 객체를 받을 때, `b'qwe'`, `b'rty'`라고 받을 수도 있지만, `b'q'`, `b'wer'`, `b'ty'`라고 받을 수도 있고, `b'qwert'`, `b'y'`라고 받을 수도 있습니다. `trio`에서는 `stream`이라고 명명합니다.\n\n실제로 `stream`을 사용하는 코드로 확인하겠습니다.\n\n```python\nfrom datetime import datetime\nfrom random import uniform\n\nimport anyio\nfrom anyio.abc import ObjectReceiveStream, ObjectSendStream\n\n\nasync def ping(num: int, send: ObjectSendStream):\n    print(f\"{datetime.today()}:: {num=}, ping start\")\n    async with send:\n        sleep_time = uniform(0, 3)\n        await anyio.sleep(sleep_time)\n        await send.send((f\"ping from {num=}, {sleep_time=}\", sleep_time))\n    print(f\"{datetime.today()}:: {num=}, ping end\")\n\n\nasync def pong(receive: ObjectReceiveStream):\n    sleep_time_sum = 0\n    print(f\"{datetime.today()}:: pong start\")\n    async for text, sleep_time in receive:\n        print(f\"{datetime.today()}:: pong:: {text}\")\n        sleep_time_sum += sleep_time\n    print(f\"{datetime.today()}:: pong end:: {sleep_time_sum=}\")\n\n\nasync def main():\n    async with anyio.create_task_group() as task_group:\n        send, receive = anyio.create_memory_object_stream(0)\n        async with send:\n            for num in range(5):\n                task_group.start_soon(ping, num, send.clone())\n        async with receive:\n            task_group.start_soon(pong, receive.clone())\n\n\nif __name__ == \"__main__\":\n    result = anyio.run(main)\n```\n\n우선 `main`함수부터 확인하겠습니다.\n\n`create_task_group`으로 `task_group` 블록을 생성합니다. 그리고 `create_memory_object_stream`으로 각 작업간 정보를 주고받기 위한 `stream`을 생성합니다.\n\n\u003e 이때 생성된 `stream`은 send와 receive 두개로 나뉘어 반환됩니다.\n\n이어서 5개의 `ping`과 1개의 `pong` 작업을 호출해서, 실제로 `main`을 실행할 때 실행될 작업을 지정합니다.\n\n여기서 사용되는 `async with send`와 `async with receive`는 안전한 프로그래밍을 위해 필요한 문법으로, 해당 블록이 끝나면 따로 `close` 메소드를 호출 할 필요 없이, 자동으로 해당 객체를 닫습니다.\n\n그리고 `start_soon`으로 호출되는 각 작업에 send와 receive를 보낼 때 사용되는 `clone`메소드는, 해당 `stream`의 새로운 send와 receive를 생성해서 보내기 위해서 사용됩니다. 만약 send나 receive를 사용하는 작업이 하나가 아닐 때 `clone` 메소드를 사용하지 않는다면, 의도치 않은 `ClosedResourceError`를 만나게 될 수 있습니다.\n\n`main`에서 호출된 작업은 간단합니다.\n`ping`은 0~3초 사이의 랜덤한 시간동안 대기한 다음, 해당 시간에 대한 정보를 send를 이용해서 보냅니다.\n`pong`은 receive를 통해 받은 정보를 출력하고, 합산합니다.\n또한, 각 `ping` 작업은 `main`에서 사용된 방식과 같은 방식으로 `async with` 블록으로 구성되어 있으므로, 따로 `close` 메소드를 호출 할 필요가 없습니다.\n\n이 방식은 상당히 유용한데, 모든 send가 닫히고, 더이상 버퍼에 정보가 없다면 `async for` 블록 또한 자동으로 닫히게 됩니다.\n\n위 코드를 실행해보면 다음과 같은 출력을 확인할 수 있습니다.\n\n```log\n2021-11-29 18:34:55.095995:: num=0, ping start\n2021-11-29 18:34:55.096041:: num=1, ping start\n2021-11-29 18:34:55.096056:: num=2, ping start\n2021-11-29 18:34:55.096068:: num=3, ping start\n2021-11-29 18:34:55.096080:: num=4, ping start\n2021-11-29 18:34:55.096091:: pong start\n2021-11-29 18:34:55.348744:: num=4, ping end\n2021-11-29 18:34:55.348931:: pong:: ping from num=4, sleep_time=0.25142686937439906\n2021-11-29 18:34:56.042114:: num=3, ping end\n2021-11-29 18:34:56.042310:: pong:: ping from num=3, sleep_time=0.9448073290170278\n2021-11-29 18:34:56.779485:: num=1, ping end\n2021-11-29 18:34:56.779686:: pong:: ping from num=1, sleep_time=1.6822150526554853\n2021-11-29 18:34:56.925375:: num=2, ping end\n2021-11-29 18:34:56.925595:: pong:: ping from num=2, sleep_time=1.8275787340996095\n2021-11-29 18:34:57.535689:: num=0, ping end\n2021-11-29 18:34:57.535911:: pong:: ping from num=0, sleep_time=2.4386441219878816\n2021-11-29 18:34:57.536030:: pong end:: sleep_time_sum=7.144672107134403\n```\n\n바이트 스트림 또한 대동소이합니다.\n\n요약하자면\n\n\u003e 1. 바이트 스트림과 객체 스트림으로 정보를 주고받을 수 있다.\n\u003e 2. send와 receive 두개로 나누어 사용한다.\n\u003e 3. send 또는 receive를 사용하는 작업이 여러개라면 `clone` 메소드를 사용한다.\n\u003e 4. `async with`, `async for`를 사용하면 좀 더 깔끔하고 명확하게 작성할 수 있다.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/파이썬으로 동시성 프로그래밍을 쉽게 하는법 - 2","data":{"title":"파이썬으로 동시성 프로그래밍을 쉽게 하는법 - 2","date":"2021-11-29T18:42:54.419+09:00","tags":["anyio","async","python","@all"],"page":"파이썬 동시성 프로그래밍","summary":"anyio로 작업 생성 + 작업간 정보 주고받기"}}]},"__N_SSG":true},"page":"/posts/[...name]","query":{"name":["velog","파이썬으로 동시성 프로그래밍을 쉽게 하는법"]},"buildId":"MQ_lMVQgBI0RkmUA6wvVT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>