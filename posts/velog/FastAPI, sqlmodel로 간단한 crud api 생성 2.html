<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="author" content="phi.friday@gmail.com, phi"/><meta name="robots" content="index,follow,noarchive"/><meta name="google-site-verification" content="lW107Dj5ageygd67UUzTm-kGls5d-THy9jJQZqLoauw"/><title>phi.log - FastAPI, sqlmodel로 간단한 crud api 생성 2</title><link href="https://use.fontawesome.com/releases/v5.15.1/css/all.css" rel="stylesheet"/><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/e61452b80f7f8356.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e61452b80f7f8356.css" data-n-g=""/><link rel="preload" href="/_next/static/css/1f4d813b299120ae.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1f4d813b299120ae.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-5752944655d749a0.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-5dc3bdee87ff18dd.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f6271bdec05edb1f.js" defer=""></script><script src="/_next/static/chunks/996-f3cf67c2e3ac5e06.js" defer=""></script><script src="/_next/static/chunks/756-1349105dbea71525.js" defer=""></script><script src="/_next/static/chunks/3-4b8664ceef873544.js" defer=""></script><script src="/_next/static/chunks/224-ddba219ecdd5c904.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...name%5D-98f81935dc747879.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_buildManifest.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_ssgManifest.js" defer=""></script><script src="/_next/static/MQ_lMVQgBI0RkmUA6wvVT/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><style>
      #nprogress {
        pointer-events: none;
      }
      #nprogress .bar {
        background: #29D;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
      }
      #nprogress .peg {
        display: block;
        position: absolute;
        right: 0px;
        width: 100px;
        height: 100%;
        box-shadow: 0 0 10px #29D, 0 0 5px #29D;
        opacity: 1;
        -webkit-transform: rotate(3deg) translate(0px, -4px);
        -ms-transform: rotate(3deg) translate(0px, -4px);
        transform: rotate(3deg) translate(0px, -4px);
      }
      #nprogress .spinner {
        display: block;
        position: fixed;
        z-index: 1031;
        top: 15px;
        right: 15px;
      }
      #nprogress .spinner-icon {
        width: 18px;
        height: 18px;
        box-sizing: border-box;
        border: solid 2px transparent;
        border-top-color: #29D;
        border-left-color: #29D;
        border-radius: 50%;
        -webkit-animation: nprogresss-spinner 400ms linear infinite;
        animation: nprogress-spinner 400ms linear infinite;
      }
      .nprogress-custom-parent {
        overflow: hidden;
        position: relative;
      }
      .nprogress-custom-parent #nprogress .spinner,
      .nprogress-custom-parent #nprogress .bar {
        position: absolute;
      }
      @-webkit-keyframes nprogress-spinner {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }
      @keyframes nprogress-spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style><div class="container" style="max-width:900px;min-width:400px"><div class="container default_app"><header><div class="container"><nav class="navbar-light fixed-top navbar navbar-expand-sm bg-light" role="navigation"><div class="container" style="max-width:900px"><div class="container-fluid"><ul class="navbar-nav w-100"><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-home"></i> Home</div></a></li><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/posts/@tag"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-hashtag"></i> Post</div></a></li><li class="nav-item"><a data-test="nav-link" class="nav-link" href="/posts/@page"><div class="text-nowrap nav_text__4OEN1"><i class="fa fa-blog"></i> Page</div></a></li><div class="container d-flex justify-content-end align-self-center"><div class="row"><div class="col"><form class="input-group w-auto" method="get" action="https://www.google.com/search" target="_blank" style="min-width:230px"><input type="hidden" name="sitesearch" value="phi-friday.github.io"/><input type="search" class="form-control" placeholder="Search in Google" aria-label="Search" name="q" maxLength="255"/><button class="ripple ripple-surface btn btn-outline-primary" role="button"><i class="fa fa-search"></i></button></form></div></div></div></ul></div></div></nav></div></header><main><div class="container"><article><div class="row"><div class="display-6 mb-3">FastAPI, sqlmodel로 간단한 crud api 생성 2</div><h6 class="mb-0 text-muted text-end"><time dateTime="2021-11-26T00:21:45.352+09:00">작성일: 2021년 11월 26일 24시 21분 45초</time></h6><h6 class="mt-0 text-muted text-end"><time dateTime="2022-08-13T00:12:20.000+09:00">수정일: 2022년 8월 13일 24시 12분 20초</time></h6><div class="d-flex justify-content-end"><div><span><span class="badge bg-info mx-1">#crud<!-- --> </span></span><span><span class="badge bg-info mx-1">#fastapi<!-- --> </span></span><span><span class="badge bg-info mx-1">#python<!-- --> </span></span><span><span class="badge bg-info mx-1">#sqlmodel<!-- --> </span></span></div></div></div><div class="row"><div class="mt-3 mb-5 border-top"></div></div><div class="row"><div><div class="toolbar"><div class="accordion mx-1 mb-4"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button">@Page: FastAPI, sqlmodel로 간단한 crud api 생성</button></h2><div id="1" class="collapse"><div class="accordion-body"><div href="velog/FastAPI, sqlmodel로 간단한 crud api 생성"><a class="mb-2"><small class="text-muted">1<!-- -->. </small>FastAPI, sqlmodel로 간단한 crud api 생성</a></div><div href="velog/FastAPI, sqlmodel로 간단한 crud api 생성 2"><a class="mb-2"><small class="text-muted">2<!-- -->. </small>FastAPI, sqlmodel로 간단한 crud api 생성 2</a></div><div href="velog/FastAPI, sqlmodel로 간단한 crud api 생성 3"><a class="mb-2"><small class="text-muted">3<!-- -->. </small>FastAPI, sqlmodel로 간단한 crud api 생성 3</a></div><div href="velog/FastAPI, sqlmodel로 간단한 crud api 생성 4"><a class="mb-2"><small class="text-muted">4<!-- -->. </small>FastAPI, sqlmodel로 간단한 crud api 생성 4</a></div></div></div></div></div></div><div class="markdown-body"><nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#db접속-모듈-생성">db접속 모듈 생성</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#db접속-모듈-테스트">db접속 모듈 테스트</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#사용할-모델-및-테이블-생성">사용할 모델 및 테이블 생성</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#테이블에-레코드를-추가하는-post-api-생성">테이블에 레코드를 추가하는 post api 생성</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#레코드를-조회하는-get-api-생성">레코드를 조회하는 get api 생성</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#레코드를-수정하는-patch-api-생성">레코드를 수정하는 patch api 생성</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#레코드를-제거하는-delete-api-생성">레코드를 제거하는 delete api 생성</a></li></ol></li></ol></nav><h2 id="db접속-모듈-생성">db접속 모듈 생성</h2>
<p>지난 글에서 db 컨테이너를 생성했지만 사용은 하지 않고 끝냈습니다. 이제 db를 연결하기 위한 작업을 진행하겠습니다.</p>
<blockquote>
<p>저는 <code>fastapi</code>와 <code>sqlmodel</code>의 기능을 최대한 사용하기 위해 <code>Field</code>나 <code>Depends</code>, <code>Path</code> 등을 가능하다면 사용하지만, <strong>사용하지 않아도 대부분의 경우 문제가 없습니다.</strong> &gt; <code>fastapi</code> 와 <code>sqlmodel</code>이 <strong>알아서 해결합니다.</strong></p>
</blockquote>
<p><code>fastapi</code>는 <code>Depends</code>라는 재밌는 함수를 가지고 있습니다. 이걸 이용하면 코드를 깔끔하게 작성할 수 있는데, 이때 사용할 수 있는 형태로 database.py를 작성하겠습니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-python" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#808080"># api/database.py</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span></span><span class="token" style="color:#cc7832">from</span><span> os </span><span class="token" style="color:#cc7832">import</span><span> environ
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span></span><span class="token" style="color:#cc7832">from</span><span> typing </span><span class="token" style="color:#cc7832">import</span><span> AsyncGenerator
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlalchemy</span><span class="token" style="color:#a9b7c6">.</span><span>engine</span><span class="token" style="color:#a9b7c6">.</span><span>url </span><span class="token" style="color:#cc7832">import</span><span> URL
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlalchemy</span><span class="token" style="color:#a9b7c6">.</span><span>ext</span><span class="token" style="color:#a9b7c6">.</span><span>asyncio</span><span class="token" style="color:#a9b7c6">.</span><span>engine </span><span class="token" style="color:#cc7832">import</span><span> create_async_engine
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlmodel </span><span class="token" style="color:#cc7832">import</span><span> SQLModel
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlmodel</span><span class="token" style="color:#a9b7c6">.</span><span>ext</span><span class="token" style="color:#a9b7c6">.</span><span>asyncio</span><span class="token" style="color:#a9b7c6">.</span><span>session </span><span class="token" style="color:#cc7832">import</span><span> AsyncSession
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span><span>database </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#e8bf6a">dict</span><span class="token" style="color:#a9b7c6">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">11</span><span>    drivername</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6a8759">&quot;postgresql+asyncpg&quot;</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">12</span><span>    username</span><span class="token" style="color:#a9b7c6">=</span><span>environ</span><span class="token" style="color:#a9b7c6">[</span><span class="token" style="color:#6a8759">&quot;POSTGRES_USER&quot;</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">13</span><span>    password</span><span class="token" style="color:#a9b7c6">=</span><span>environ</span><span class="token" style="color:#a9b7c6">[</span><span class="token" style="color:#6a8759">&quot;POSTGRES_PASSWORD&quot;</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">14</span><span>    host</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6a8759">&quot;db&quot;</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">15</span><span>    port</span><span class="token" style="color:#a9b7c6">=</span><span>environ</span><span class="token" style="color:#a9b7c6">[</span><span class="token" style="color:#6a8759">&quot;POSTGRES_PORT&quot;</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">16</span><span>    database</span><span class="token" style="color:#a9b7c6">=</span><span>environ</span><span class="token" style="color:#a9b7c6">[</span><span class="token" style="color:#6a8759">&quot;POSTGRES_DB&quot;</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">17</span><span></span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">18</span><span>url </span><span class="token" style="color:#a9b7c6">=</span><span> URL</span><span class="token" style="color:#a9b7c6">.</span><span>create</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">**</span><span>database</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">19</span><span>engine </span><span class="token" style="color:#a9b7c6">=</span><span> create_async_engine</span><span class="token" style="color:#a9b7c6">(</span><span>url</span><span class="token" style="color:#a9b7c6">,</span><span> echo</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#e8bf6a">bool</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#e8bf6a">int</span><span class="token" style="color:#a9b7c6">(</span><span>environ</span><span class="token" style="color:#a9b7c6">[</span><span class="token" style="color:#6a8759">&quot;RESTAPI_DEBUG&quot;</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">20</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">21</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">22</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">get_session</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span> </span><span class="token" style="color:#a9b7c6">-</span><span class="token" style="color:#a9b7c6">&gt;</span><span> AsyncGenerator</span><span class="token" style="color:#a9b7c6">[</span><span>AsyncSession</span><span class="token" style="color:#a9b7c6">,</span><span> </span><span class="token" style="color:#cc7832">None</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">23</span><span>    </span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">with</span><span> AsyncSession</span><span class="token" style="color:#a9b7c6">(</span><span>engine</span><span class="token" style="color:#a9b7c6">)</span><span> </span><span class="token" style="color:#cc7832">as</span><span> session</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">24</span><span>        </span><span class="token" style="color:#cc7832">yield</span><span> session
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">25</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">26</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">27</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">create_model_table</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span> </span><span class="token" style="color:#a9b7c6">-</span><span class="token" style="color:#a9b7c6">&gt;</span><span> </span><span class="token" style="color:#cc7832">None</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">28</span><span>    </span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">with</span><span> engine</span><span class="token" style="color:#a9b7c6">.</span><span>begin</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span> </span><span class="token" style="color:#cc7832">as</span><span> conn</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">29</span><span>        </span><span class="token" style="color:#cc7832">await</span><span> conn</span><span class="token" style="color:#a9b7c6">.</span><span>run_sync</span><span class="token" style="color:#a9b7c6">(</span><span>SQLModel</span><span class="token" style="color:#a9b7c6">.</span><span>metadata</span><span class="token" style="color:#a9b7c6">.</span><span>create_all</span><span class="token" style="color:#a9b7c6">)</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">python</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p>db에서 비동기 세션을 사용할 계획이므로, <code>create_engine</code>대신 <code>create_async_engine</code>을 사용합니다.</p>
<p><code>get_session</code>함수는 각 요청에서 사용할 session을 생성할때 사용하고,
<code>create_model_table</code>은 작성한 모델에 대응하는 테이블을 db에 생성하는 함수입니다. 나중에 모델을 생성하고 나면, fastapi가 시작할때 자동으로 실행되도록 할 계획입니다.</p>
<blockquote>
<p>만약 동기 세션을 사용한다면, <code>from sqlmodel import create_engine</code>으로 엔진을 생성하고,
<code>AsyncSession</code> 대신 <code>from sqlmodel import Session</code>으로 <code>Session</code>을 사용하면 됩니다.
물론 <code>get_session</code>을 작성할 때, <code>async with</code> 대신 <code>with</code>로 바꿔야 합니다.
그리고 <code>create_model_table</code> 내부에서 <code>with context</code>를 사용할 필요 없이, <code>create_all</code> 메소드를 실행하면 됩니다.</p>
</blockquote>
<h2 id="db접속-모듈-테스트">db접속 모듈 테스트</h2>
<p>작성한 함수가 잘 실행되는지 확인하기 위해 main.py에 간단한 <code>get</code> api를 생성하겠습니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-python" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#808080"># api/main.py</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span></span><span class="token" style="color:#cc7832">from</span><span> os </span><span class="token" style="color:#cc7832">import</span><span> environ
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span></span><span class="token" style="color:#cc7832">import</span><span> uvicorn
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token" style="color:#cc7832">from</span><span> fastapi </span><span class="token" style="color:#cc7832">import</span><span> Depends</span><span class="token" style="color:#a9b7c6">,</span><span> FastAPI
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlalchemy</span><span class="token" style="color:#a9b7c6">.</span><span>sql </span><span class="token" style="color:#cc7832">import</span><span> text
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlmodel</span><span class="token" style="color:#a9b7c6">.</span><span>ext</span><span class="token" style="color:#a9b7c6">.</span><span>asyncio</span><span class="token" style="color:#a9b7c6">.</span><span>session </span><span class="token" style="color:#cc7832">import</span><span> AsyncSession
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span><span></span><span class="token" style="color:#cc7832">from</span><span> database </span><span class="token" style="color:#cc7832">import</span><span> get_session
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">11</span><span></span><span class="token" style="color:#808080"># 중략</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">12</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">14</span><span></span><span class="token decorator annotation" style="color:#a9b7c6">@app</span><span class="token decorator annotation" style="color:#a9b7c6">.</span><span class="token decorator annotation" style="color:#a9b7c6">get</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&quot;/session_test&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">15</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">session_test</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">*</span><span class="token" style="color:#a9b7c6">,</span><span> session</span><span class="token" style="color:#a9b7c6">:</span><span> AsyncSession </span><span class="token" style="color:#a9b7c6">=</span><span> Depends</span><span class="token" style="color:#a9b7c6">(</span><span>get_session</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">16</span><span>    data </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#cc7832">await</span><span> session</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#cc7832">exec</span><span class="token" style="color:#a9b7c6">(</span><span>text</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&quot;select 1&quot;</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">)</span><span>  </span><span class="token" style="color:#808080"># type: ignore</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">17</span><span>    </span><span class="token" style="color:#cc7832">return</span><span> data</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#e8bf6a">all</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">18</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">19</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">20</span><span></span><span class="token" style="color:#808080"># 후략</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">python</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<blockquote>
<p><code># type: ignore</code>는 <code>vscode</code>의 확장 프로그램인 <code>pylance</code>가 해당 라인의 정적 타입 확인을 하지 않도록 합니다.
이유는 모르겠는데, <code>text</code>가 <code>excutable</code>한데도 <code>excutable</code>한 객체로 인정하지를 않습니다.
사실 <code>sqlalchemy</code>자체가 정적 타입 체크시 많은 에러를 뿜긴 합니다.</p>
</blockquote>
<blockquote>
<p><code>session</code>의 <code>exec</code> 메소드는 <code>sqlalchemy</code>에 없는 메소드입니다. 기존 실행 메소드인 <code>execute</code>를 사용해도 무방하지만, <code>exec</code>는 <code>execute</code>의 <code>wrapper</code>이면서 type hint가 잘 되어 있으므로, 정적 타입 체크나 <code>vscode</code>의 자동완성 등에서 상당한 편의를 얻을 수 있습니다.</p>
</blockquote>
<p><code>select 1</code> 쿼리를 실행하는 간단한 형태의 <code>get</code> api를 작성했습니다. 정상적으로 작성하셨다면</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-json" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#a9b7c6">[</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span>  </span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span>    </span><span class="token" style="color:#9876aa">&quot;?column?&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6897bb">1</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span>  </span><span class="token" style="color:#a9b7c6">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token" style="color:#a9b7c6">]</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">json</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p>와 같은 결과를 받게 됩니다.
여기서 사용된 <code>Depends</code>는 단순히 <code>session</code>을 받는 용도지만, 이 외에도 많은 사용법이 있습니다.
관련 내용은 <a href="https://fastapi.tiangolo.com/tutorial/dependencies/">여기</a>에서 확인할 수 있습니다.</p>
<blockquote>
<p><code>fastapi</code>는 비동기 프로그래밍을 아주 잘 지원하기 때문에, <strong>원한다면 그냥 <code>async def</code>를 사용하면 되고, 비동기가 아닌 io 작업이 있다면 그냥 <code>def</code>를 사용해도 됩니다. await 키워드를 사용하지 않더라도 async def를 사용해도 좋습니다. 어떻게 작성하든 <code>fastapi</code>가 알아서 잘 실행합니다.</strong></p>
</blockquote>
<h2 id="사용할-모델-및-테이블-생성">사용할 모델 및 테이블 생성</h2>
<p>세션이 잘 붙은걸 확인했으니, 이제 사용할 모델을 생성하겠습니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-python" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#808080"># api/model.py</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span></span><span class="token" style="color:#cc7832">from</span><span> datetime </span><span class="token" style="color:#cc7832">import</span><span> datetime
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span></span><span class="token" style="color:#cc7832">from</span><span> typing </span><span class="token" style="color:#cc7832">import</span><span> Optional
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token" style="color:#cc7832">from</span><span> pydantic </span><span class="token" style="color:#cc7832">import</span><span> EmailStr
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlmodel </span><span class="token" style="color:#cc7832">import</span><span> Field</span><span class="token" style="color:#a9b7c6">,</span><span> SQLModel
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span><span></span><span class="token" style="color:#cc7832">class</span><span> </span><span class="token class-name">user</span><span class="token" style="color:#a9b7c6">(</span><span>SQLModel</span><span class="token" style="color:#a9b7c6">,</span><span> table</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#cc7832">True</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span><span>    </span><span class="token" style="color:#e8bf6a">id</span><span class="token" style="color:#a9b7c6">:</span><span> Optional</span><span class="token" style="color:#a9b7c6">[</span><span class="token" style="color:#e8bf6a">int</span><span class="token" style="color:#a9b7c6">]</span><span> </span><span class="token" style="color:#a9b7c6">=</span><span> Field</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#cc7832">None</span><span class="token" style="color:#a9b7c6">,</span><span> primary_key</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#cc7832">True</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">11</span><span>    name</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#e8bf6a">str</span><span> </span><span class="token" style="color:#a9b7c6">=</span><span> Field</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">,</span><span> min_length</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">,</span><span> nullable</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#cc7832">False</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">12</span><span>    email</span><span class="token" style="color:#a9b7c6">:</span><span> EmailStr </span><span class="token" style="color:#a9b7c6">=</span><span> Field</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">,</span><span> nullable</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#cc7832">False</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">13</span><span>    registered_date</span><span class="token" style="color:#a9b7c6">:</span><span> datetime </span><span class="token" style="color:#a9b7c6">=</span><span> Field</span><span class="token" style="color:#a9b7c6">(</span><span>default_factory</span><span class="token" style="color:#a9b7c6">=</span><span>datetime</span><span class="token" style="color:#a9b7c6">.</span><span>today</span><span class="token" style="color:#a9b7c6">)</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">python</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p><code>user</code>라는 모델이자 테이블인 클래스를 정의했습니다.
<code>name</code>과 <code>email</code>은 필수값이고, <code>registered_date</code>는 자동으로 생성되도록 했습니다.</p>
<blockquote>
<p><code>table=True</code> 파라미터는 <code>user</code> 클래스가 db에서 사용할 테이블이라는 것을 알려줍니다.
이 파라미터가 없으면, 이전에 작성한 <code>create_model_table</code> 함수를 실행해도 db에 테이블이 생성되지 않습니다.</p>
</blockquote>
<p>pk로 지정한 <code>id</code>가 <code>Optional</code>이어서 의아할 수 있는데,
api 서버에서 우선 <code>id</code>를 지정하지 않은 상태로 <code>user</code>인스턴스를 생성하고, 그 인스턴스를 <code>session</code>을 통해 추가하면 <code>user</code> 테이블에서는 정상적으로 <code>id</code>가 들어가게 됩니다.
이후 api 서버에서 <code>id</code>를 확인하고 싶다면 <code>refresh</code>메소드를 사용하면 됩니다.</p>
<h3 id="테이블에-레코드를-추가하는-post-api-생성">테이블에 레코드를 추가하는 <code>post</code> api 생성</h3>
<p>이 과정을 담은 <code>post</code> api를 하나 생성하겠습니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-python" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#808080"># api/main.py</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span></span><span class="token" style="color:#cc7832">from</span><span> os </span><span class="token" style="color:#cc7832">import</span><span> environ
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span></span><span class="token" style="color:#cc7832">import</span><span> uvicorn
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token" style="color:#cc7832">from</span><span> fastapi </span><span class="token" style="color:#cc7832">import</span><span> Depends</span><span class="token" style="color:#a9b7c6">,</span><span> FastAPI
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlalchemy</span><span class="token" style="color:#a9b7c6">.</span><span>sql </span><span class="token" style="color:#cc7832">import</span><span> text
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlmodel</span><span class="token" style="color:#a9b7c6">.</span><span>ext</span><span class="token" style="color:#a9b7c6">.</span><span>asyncio</span><span class="token" style="color:#a9b7c6">.</span><span>session </span><span class="token" style="color:#cc7832">import</span><span> AsyncSession
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span><span></span><span class="token" style="color:#cc7832">from</span><span> database </span><span class="token" style="color:#cc7832">import</span><span> create_model_table</span><span class="token" style="color:#a9b7c6">,</span><span> get_session
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span><span></span><span class="token" style="color:#cc7832">from</span><span> model </span><span class="token" style="color:#cc7832">import</span><span> user
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">11</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">12</span><span>app </span><span class="token" style="color:#a9b7c6">=</span><span> FastAPI</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">13</span><span>app</span><span class="token" style="color:#a9b7c6">.</span><span>on_event</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&quot;startup&quot;</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">(</span><span>create_model_table</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">15</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">16</span><span></span><span class="token" style="color:#808080"># 중략</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">17</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">18</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">19</span><span></span><span class="token decorator annotation" style="color:#a9b7c6">@app</span><span class="token decorator annotation" style="color:#a9b7c6">.</span><span class="token decorator annotation" style="color:#a9b7c6">post</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&quot;/create_user&quot;</span><span class="token" style="color:#a9b7c6">,</span><span> response_model</span><span class="token" style="color:#a9b7c6">=</span><span>user</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">20</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">create_user</span><span class="token" style="color:#a9b7c6">(</span><span>data</span><span class="token" style="color:#a9b7c6">:</span><span> user</span><span class="token" style="color:#a9b7c6">,</span><span> </span><span class="token" style="color:#a9b7c6">*</span><span class="token" style="color:#a9b7c6">,</span><span> session</span><span class="token" style="color:#a9b7c6">:</span><span> AsyncSession </span><span class="token" style="color:#a9b7c6">=</span><span> Depends</span><span class="token" style="color:#a9b7c6">(</span><span>get_session</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">21</span><span>    user_instance </span><span class="token" style="color:#a9b7c6">=</span><span> user</span><span class="token" style="color:#a9b7c6">.</span><span>from_orm</span><span class="token" style="color:#a9b7c6">(</span><span>data</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">22</span><span>    session</span><span class="token" style="color:#a9b7c6">.</span><span>add</span><span class="token" style="color:#a9b7c6">(</span><span>user_instance</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">23</span><span>    </span><span class="token" style="color:#cc7832">await</span><span> session</span><span class="token" style="color:#a9b7c6">.</span><span>commit</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">24</span><span>    </span><span class="token" style="color:#cc7832">await</span><span> session</span><span class="token" style="color:#a9b7c6">.</span><span>refresh</span><span class="token" style="color:#a9b7c6">(</span><span>user_instance</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">25</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">26</span><span>    </span><span class="token" style="color:#cc7832">return</span><span> user_instance
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">27</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">28</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">29</span><span></span><span class="token" style="color:#808080"># 후략</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">python</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p>기존에 작성했던 <code>create_model_table</code>함수를 <code>app.on_event(...)</code> 데코레이터를 이용해서 자동으로 실행되도록 했습니다.
현재 <code>main.py</code>에 <code>user</code> 클래스가 있으므로 api 서버가 실행될때 <code>user</code> 테이블이 db에 없다면 자동으로 생성됩니다.</p>
<p><code>.env</code> 파일에 <code>RESTAPI_DEBUG=1</code>로 작성하셨다면, 다음과 같은 쿼리로 테이블이 생성됐다는 것을 로그에서 확인할 수 있습니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-sql" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#cc7832">CREATE</span><span> </span><span class="token" style="color:#cc7832">TABLE</span><span> </span><span class="token" style="color:#6a8759">&quot;user&quot;</span><span> </span><span class="token" style="color:#a9b7c6">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span>        id </span><span class="token" style="color:#cc7832">SERIAL</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span>        name </span><span class="token" style="color:#cc7832">VARCHAR</span><span> </span><span class="token" style="color:#a9b7c6">NOT</span><span> </span><span class="token" style="color:#cc7832">NULL</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span>        email </span><span class="token" style="color:#cc7832">VARCHAR</span><span> </span><span class="token" style="color:#a9b7c6">NOT</span><span> </span><span class="token" style="color:#cc7832">NULL</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span>        registered_date </span><span class="token" style="color:#cc7832">TIMESTAMP</span><span> WITHOUT </span><span class="token" style="color:#cc7832">TIME</span><span> ZONE</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span>        </span><span class="token" style="color:#cc7832">PRIMARY</span><span> </span><span class="token" style="color:#cc7832">KEY</span><span> </span><span class="token" style="color:#a9b7c6">(</span><span>id</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span></span><span class="token" style="color:#a9b7c6">)</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">sql</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<blockquote>
<p>아직 문자열을 <code>nvarchar</code>로 간단하게 설정하는 방법은 <code>sqlmodel</code>에 없습니다. <code>sqlalchemy</code>의 <code>Column</code>을 직접 작성해서 <code>Field</code>에 대응하는 방식으로만 가능합니다.
<code>type_</code> 파라미터를 사용할 수 있도록 PR된 상태이니, 다음 버전에서는 가능할 것 같습니다.</p>
</blockquote>
<p>다음과 같은 <code>body</code>로 <code>post</code>를 요청하면</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-json" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span>  </span><span class="token" style="color:#9876aa">&quot;name&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;string&quot;</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span>  </span><span class="token" style="color:#9876aa">&quot;email&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;user@example.com&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span></span><span class="token" style="color:#a9b7c6">}</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">json</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p>다음과 같은 결과를 받게 됩니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-json" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span>  </span><span class="token" style="color:#9876aa">&quot;id&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span>  </span><span class="token" style="color:#9876aa">&quot;registered_date&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;2021-11-25T23:51:26.156134&quot;</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span>  </span><span class="token" style="color:#9876aa">&quot;name&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;string&quot;</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span>  </span><span class="token" style="color:#9876aa">&quot;email&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;user@example.com&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#a9b7c6">}</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">json</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<h3 id="레코드를-조회하는-get-api-생성">레코드를 조회하는 <code>get</code> api 생성</h3>
<p>이제 이 유저 정보를 조회하는 <code>get</code> api를 생성하겠습니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-python" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#808080"># api/main.py</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span></span><span class="token" style="color:#cc7832">from</span><span> os </span><span class="token" style="color:#cc7832">import</span><span> environ
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span></span><span class="token" style="color:#cc7832">import</span><span> uvicorn
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token" style="color:#cc7832">from</span><span> fastapi </span><span class="token" style="color:#cc7832">import</span><span> Depends</span><span class="token" style="color:#a9b7c6">,</span><span> FastAPI</span><span class="token" style="color:#a9b7c6">,</span><span> HTTPException</span><span class="token" style="color:#a9b7c6">,</span><span> Path
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlalchemy</span><span class="token" style="color:#a9b7c6">.</span><span>sql </span><span class="token" style="color:#cc7832">import</span><span> text
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlmodel</span><span class="token" style="color:#a9b7c6">.</span><span>ext</span><span class="token" style="color:#a9b7c6">.</span><span>asyncio</span><span class="token" style="color:#a9b7c6">.</span><span>session </span><span class="token" style="color:#cc7832">import</span><span> AsyncSession
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span><span></span><span class="token" style="color:#cc7832">from</span><span> database </span><span class="token" style="color:#cc7832">import</span><span> create_model_table</span><span class="token" style="color:#a9b7c6">,</span><span> get_session
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span><span></span><span class="token" style="color:#cc7832">from</span><span> model </span><span class="token" style="color:#cc7832">import</span><span> user
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">11</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">12</span><span></span><span class="token" style="color:#808080"># 중략</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">15</span><span></span><span class="token decorator annotation" style="color:#a9b7c6">@app</span><span class="token decorator annotation" style="color:#a9b7c6">.</span><span class="token decorator annotation" style="color:#a9b7c6">get</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&quot;/get_user/{user_id}&quot;</span><span class="token" style="color:#a9b7c6">,</span><span> response_model</span><span class="token" style="color:#a9b7c6">=</span><span>user</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">16</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">get_user</span><span class="token" style="color:#a9b7c6">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">17</span><span>    user_id</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#e8bf6a">int</span><span> </span><span class="token" style="color:#a9b7c6">=</span><span> Path</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">,</span><span> ge</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span><span> </span><span class="token" style="color:#a9b7c6">*</span><span class="token" style="color:#a9b7c6">,</span><span> session</span><span class="token" style="color:#a9b7c6">:</span><span> AsyncSession </span><span class="token" style="color:#a9b7c6">=</span><span> Depends</span><span class="token" style="color:#a9b7c6">(</span><span>get_session</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">18</span><span></span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">19</span><span>    user_instance </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#cc7832">await</span><span> session</span><span class="token" style="color:#a9b7c6">.</span><span>get</span><span class="token" style="color:#a9b7c6">(</span><span>user</span><span class="token" style="color:#a9b7c6">,</span><span> user_id</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">20</span><span>    </span><span class="token" style="color:#cc7832">if</span><span> </span><span class="token" style="color:#cc7832">not</span><span> user_instance</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">21</span><span>        </span><span class="token" style="color:#cc7832">raise</span><span> HTTPException</span><span class="token" style="color:#a9b7c6">(</span><span>status_code</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">404</span><span class="token" style="color:#a9b7c6">,</span><span> detail</span><span class="token" style="color:#a9b7c6">=</span><span class="token string-interpolation" style="color:#6a8759">f&quot;there is not </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759"> user&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">22</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">23</span><span>    </span><span class="token" style="color:#cc7832">return</span><span> user_instance
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">24</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">25</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">26</span><span></span><span class="token" style="color:#808080"># 후략</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">python</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<blockquote>
<p>여기서 사용된 <code>Path</code>는 <strong>없어도 아무 문제가 없습니다.</strong></p>
</blockquote>
<p><code>user_id</code>에 해당하는 <code>user</code>가 없을 경우 404에러를 반환하도록 했습니다.
<code>fastapi</code>에서 제공하는 <code>Path</code>를 이용해서, <code>user_id</code>는 1 이상의 값만 받도록 제한했습니다. 내부적으로 <code>pydantic</code>을 사용하기 때문에, 빠르고 정확합니다.</p>
<h3 id="레코드를-수정하는-patch-api-생성">레코드를 수정하는 <code>patch</code> api 생성</h3>
<p>이어서 유저 정보를 수정하는 <code>patch</code> api를 작성합니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-python" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#808080"># api/main.py</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span></span><span class="token" style="color:#cc7832">from</span><span> os </span><span class="token" style="color:#cc7832">import</span><span> environ
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span></span><span class="token" style="color:#cc7832">import</span><span> uvicorn
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token" style="color:#cc7832">from</span><span> fastapi </span><span class="token" style="color:#cc7832">import</span><span> Depends</span><span class="token" style="color:#a9b7c6">,</span><span> FastAPI</span><span class="token" style="color:#a9b7c6">,</span><span> HTTPException</span><span class="token" style="color:#a9b7c6">,</span><span> Path
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlalchemy</span><span class="token" style="color:#a9b7c6">.</span><span>sql </span><span class="token" style="color:#cc7832">import</span><span> text
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlmodel</span><span class="token" style="color:#a9b7c6">.</span><span>ext</span><span class="token" style="color:#a9b7c6">.</span><span>asyncio</span><span class="token" style="color:#a9b7c6">.</span><span>session </span><span class="token" style="color:#cc7832">import</span><span> AsyncSession
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span><span></span><span class="token" style="color:#cc7832">from</span><span> database </span><span class="token" style="color:#cc7832">import</span><span> create_model_table</span><span class="token" style="color:#a9b7c6">,</span><span> get_session
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span><span></span><span class="token" style="color:#cc7832">from</span><span> model </span><span class="token" style="color:#cc7832">import</span><span> user
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">11</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">12</span><span></span><span class="token" style="color:#808080"># 중략</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">15</span><span></span><span class="token decorator annotation" style="color:#a9b7c6">@app</span><span class="token decorator annotation" style="color:#a9b7c6">.</span><span class="token decorator annotation" style="color:#a9b7c6">patch</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&quot;/update_user/{user_id}&quot;</span><span class="token" style="color:#a9b7c6">,</span><span> response_model</span><span class="token" style="color:#a9b7c6">=</span><span>user</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">16</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">update_user</span><span class="token" style="color:#a9b7c6">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">17</span><span>    data</span><span class="token" style="color:#a9b7c6">:</span><span> user</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">18</span><span>    user_id</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#e8bf6a">int</span><span> </span><span class="token" style="color:#a9b7c6">=</span><span> Path</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">,</span><span> ge</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">19</span><span>    </span><span class="token" style="color:#a9b7c6">*</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">20</span><span>    session</span><span class="token" style="color:#a9b7c6">:</span><span> AsyncSession </span><span class="token" style="color:#a9b7c6">=</span><span> Depends</span><span class="token" style="color:#a9b7c6">(</span><span>get_session</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">21</span><span></span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">22</span><span>    user_instance </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#cc7832">await</span><span> session</span><span class="token" style="color:#a9b7c6">.</span><span>get</span><span class="token" style="color:#a9b7c6">(</span><span>user</span><span class="token" style="color:#a9b7c6">,</span><span> user_id</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">23</span><span>    </span><span class="token" style="color:#cc7832">if</span><span> </span><span class="token" style="color:#cc7832">not</span><span> user_instance</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">24</span><span>        </span><span class="token" style="color:#cc7832">raise</span><span> HTTPException</span><span class="token" style="color:#a9b7c6">(</span><span>status_code</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">404</span><span class="token" style="color:#a9b7c6">,</span><span> detail</span><span class="token" style="color:#a9b7c6">=</span><span class="token string-interpolation" style="color:#6a8759">f&quot;there is not </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759"> user&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">25</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">26</span><span>    update_data </span><span class="token" style="color:#a9b7c6">=</span><span> data</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#e8bf6a">dict</span><span class="token" style="color:#a9b7c6">(</span><span>exclude_unset</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#cc7832">True</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">27</span><span>    </span><span class="token" style="color:#cc7832">for</span><span> key</span><span class="token" style="color:#a9b7c6">,</span><span> value </span><span class="token" style="color:#cc7832">in</span><span> update_data</span><span class="token" style="color:#a9b7c6">.</span><span>items</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">28</span><span>        </span><span class="token" style="color:#e8bf6a">setattr</span><span class="token" style="color:#a9b7c6">(</span><span>user_instance</span><span class="token" style="color:#a9b7c6">,</span><span> key</span><span class="token" style="color:#a9b7c6">,</span><span> value</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">29</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">30</span><span>    session</span><span class="token" style="color:#a9b7c6">.</span><span>add</span><span class="token" style="color:#a9b7c6">(</span><span>user_instance</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">31</span><span>    </span><span class="token" style="color:#cc7832">await</span><span> session</span><span class="token" style="color:#a9b7c6">.</span><span>commit</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">32</span><span>    </span><span class="token" style="color:#cc7832">await</span><span> session</span><span class="token" style="color:#a9b7c6">.</span><span>refresh</span><span class="token" style="color:#a9b7c6">(</span><span>user_instance</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">33</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">34</span><span>    </span><span class="token" style="color:#cc7832">return</span><span> user_instance
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">35</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">36</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">37</span><span></span><span class="token" style="color:#808080"># 후략</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">python</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p><code>data.dict</code> 메소드의 <code>exclude_unset=True</code> 파라미터는 <code>user</code> 클래스에 정의된 속성이면서 사용자가 <code>body</code>에 포함하지 않은 값을 제외한 딕셔너리를 반환하게 합니다.</p>
<p><code>user_id=1</code>에 다음과 같은 <code>body</code>를 보내면</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-json" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span>  </span><span class="token" style="color:#9876aa">&quot;name&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;aaa&quot;</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span>  </span><span class="token" style="color:#9876aa">&quot;email&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;aaaa@example.com&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span></span><span class="token" style="color:#a9b7c6">}</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">json</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p>다음과 같은 <code>user</code>를 반환합니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-json" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span>  </span><span class="token" style="color:#9876aa">&quot;id&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span>  </span><span class="token" style="color:#9876aa">&quot;registered_date&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;2021-11-25T23:51:26.156134&quot;</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span>  </span><span class="token" style="color:#9876aa">&quot;name&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;aaa&quot;</span><span class="token" style="color:#a9b7c6">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span>  </span><span class="token" style="color:#9876aa">&quot;email&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;aaaa@example.com&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#a9b7c6">}</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">json</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p>이전에 생성한 <code>get</code> api로 조회해보면, 정상적으로 수정된 것을 확인할 수 있습니다.</p>
<h3 id="레코드를-제거하는-delete-api-생성">레코드를 제거하는 <code>delete</code> api 생성</h3>
<p>마지막으로 <code>delete</code> api를 작성합니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-python" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#808080"># api/main.py</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span></span><span class="token" style="color:#cc7832">from</span><span> os </span><span class="token" style="color:#cc7832">import</span><span> environ
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">4</span><span></span><span class="token" style="color:#cc7832">import</span><span> uvicorn
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">5</span><span></span><span class="token" style="color:#cc7832">from</span><span> fastapi </span><span class="token" style="color:#cc7832">import</span><span> Depends</span><span class="token" style="color:#a9b7c6">,</span><span> FastAPI</span><span class="token" style="color:#a9b7c6">,</span><span> HTTPException</span><span class="token" style="color:#a9b7c6">,</span><span> Path
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">6</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlalchemy</span><span class="token" style="color:#a9b7c6">.</span><span>sql </span><span class="token" style="color:#cc7832">import</span><span> text
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">7</span><span></span><span class="token" style="color:#cc7832">from</span><span> sqlmodel</span><span class="token" style="color:#a9b7c6">.</span><span>ext</span><span class="token" style="color:#a9b7c6">.</span><span>asyncio</span><span class="token" style="color:#a9b7c6">.</span><span>session </span><span class="token" style="color:#cc7832">import</span><span> AsyncSession
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">9</span><span></span><span class="token" style="color:#cc7832">from</span><span> database </span><span class="token" style="color:#cc7832">import</span><span> create_model_table</span><span class="token" style="color:#a9b7c6">,</span><span> get_session
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">10</span><span></span><span class="token" style="color:#cc7832">from</span><span> model </span><span class="token" style="color:#cc7832">import</span><span> user
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">11</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">12</span><span></span><span class="token" style="color:#808080"># 중략</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">15</span><span></span><span class="token decorator annotation" style="color:#a9b7c6">@app</span><span class="token decorator annotation" style="color:#a9b7c6">.</span><span class="token decorator annotation" style="color:#a9b7c6">delete</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&quot;/delete_user/{user_id}&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">16</span><span></span><span class="token" style="color:#cc7832">async</span><span> </span><span class="token" style="color:#cc7832">def</span><span> </span><span class="token" style="color:#ffc66d">delete_user</span><span class="token" style="color:#a9b7c6">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">17</span><span>    user_id</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#e8bf6a">int</span><span> </span><span class="token" style="color:#a9b7c6">=</span><span> Path</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#a9b7c6">,</span><span> ge</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">1</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span><span> </span><span class="token" style="color:#a9b7c6">*</span><span class="token" style="color:#a9b7c6">,</span><span> session</span><span class="token" style="color:#a9b7c6">:</span><span> AsyncSession </span><span class="token" style="color:#a9b7c6">=</span><span> Depends</span><span class="token" style="color:#a9b7c6">(</span><span>get_session</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">18</span><span></span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">19</span><span>    user_instance </span><span class="token" style="color:#a9b7c6">=</span><span> </span><span class="token" style="color:#cc7832">await</span><span> session</span><span class="token" style="color:#a9b7c6">.</span><span>get</span><span class="token" style="color:#a9b7c6">(</span><span>user</span><span class="token" style="color:#a9b7c6">,</span><span> user_id</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">20</span><span>    </span><span class="token" style="color:#cc7832">if</span><span> </span><span class="token" style="color:#cc7832">not</span><span> user_instance</span><span class="token" style="color:#a9b7c6">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">21</span><span>        </span><span class="token" style="color:#cc7832">raise</span><span> HTTPException</span><span class="token" style="color:#a9b7c6">(</span><span>status_code</span><span class="token" style="color:#a9b7c6">=</span><span class="token" style="color:#6897bb">404</span><span class="token" style="color:#a9b7c6">,</span><span> detail</span><span class="token" style="color:#a9b7c6">=</span><span class="token string-interpolation" style="color:#6a8759">f&quot;there is no </span><span class="token string-interpolation interpolation" style="color:#a9b7c6">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">=</span><span class="token string-interpolation interpolation" style="color:#a9b7c6">}</span><span class="token string-interpolation" style="color:#6a8759"> user&quot;</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">22</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">23</span><span>    </span><span class="token" style="color:#cc7832">await</span><span> session</span><span class="token" style="color:#a9b7c6">.</span><span>delete</span><span class="token" style="color:#a9b7c6">(</span><span>user_instance</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">24</span><span>    </span><span class="token" style="color:#cc7832">await</span><span> session</span><span class="token" style="color:#a9b7c6">.</span><span>commit</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">25</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">26</span><span>    </span><span class="token" style="color:#cc7832">return</span><span> user_id
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">27</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">28</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">29</span><span></span><span class="token" style="color:#808080"># 후략</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">python</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p><code>user_id=1</code>로 <code>delete</code> api를 요청 한 다음 <code>get</code> api를 요청하면 다음과 같은 메세지를 보냅니다.</p>
<pre style="padding:unset" node="[object Object]"><div class="code-toolbar"><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b;font-size:16px"><code class="language-json" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">1</span><span class="token" style="color:#a9b7c6">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">2</span><span>  </span><span class="token" style="color:#9876aa">&quot;detail&quot;</span><span class="token" style="color:#a9b7c6">:</span><span> </span><span class="token" style="color:#6a8759">&quot;there is no user_id=1 user&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#808080">3</span><span></span><span class="token" style="color:#a9b7c6">}</span></code></pre><div class="toolbar" style="opacity:1"><div class="btn-group btn-group-sm" role="group"><button class="ripple ripple-surface btn btn-outline-light" disabled="" role="button"><span class="text-capitalize">json</span></button><button class="ripple ripple-surface btn btn-dark" role="button"><i class="fas fa-copy text-light"></i></button></div></div></div></pre>
<p>기초적인 형태의 <code>crud</code> api를 작성하고, 정상적으로 실행되는지 확인했습니다.
몇몇 아쉬운 부분들이 눈에 띕니다.</p>
<ul>
<li>유저를 추가할때 중복을 확인하지 않는다.</li>
<li>유저를 수정한 일자가 없다.</li>
<li>왜 <code>response_model</code>은 user로 고정이지?</li>
<li>etc...</li>
</ul>
<p>이러한 부분들은 다음 글에서 확인하겠습니다.</p></div></div></div><div class="row"><div class="mt-5 mb-3 border-bottom"></div></div><div class="row"><span class="d-flex justify-content-between"><span><h6 class=""><i class="fa fa-angle-left mx-2"></i>FastAPI, sqlmodel로 간단한...</h6></span><span><h6 class="">FastAPI, sqlmodel로 간단한...<i class="fa fa-angle-right mx-2"></i></h6></span></span><div class="mt-3"><div><section style="width:100%"></section></div></div></div></article></div></main><footer class="text-center text-muted"></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"name":"FastAPI, sqlmodel로 간단한 crud api 생성 2","content":"\n## db접속 모듈 생성\n\n지난 글에서 db 컨테이너를 생성했지만 사용은 하지 않고 끝냈습니다. 이제 db를 연결하기 위한 작업을 진행하겠습니다.\n\n\u003e 저는 `fastapi`와 `sqlmodel`의 기능을 최대한 사용하기 위해 `Field`나 `Depends`, `Path` 등을 가능하다면 사용하지만, **사용하지 않아도 대부분의 경우 문제가 없습니다.** \u003e `fastapi` 와 `sqlmodel`이 **알아서 해결합니다.**\n\n`fastapi`는 `Depends`라는 재밌는 함수를 가지고 있습니다. 이걸 이용하면 코드를 깔끔하게 작성할 수 있는데, 이때 사용할 수 있는 형태로 database.py를 작성하겠습니다.\n\n```python\n# api/database.py\nfrom os import environ\nfrom typing import AsyncGenerator\n\nfrom sqlalchemy.engine.url import URL\nfrom sqlalchemy.ext.asyncio.engine import create_async_engine\nfrom sqlmodel import SQLModel\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\ndatabase = dict(\n    drivername=\"postgresql+asyncpg\",\n    username=environ[\"POSTGRES_USER\"],\n    password=environ[\"POSTGRES_PASSWORD\"],\n    host=\"db\",\n    port=environ[\"POSTGRES_PORT\"],\n    database=environ[\"POSTGRES_DB\"],\n)\nurl = URL.create(**database)\nengine = create_async_engine(url, echo=bool(int(environ[\"RESTAPI_DEBUG\"])))\n\n\nasync def get_session() -\u003e AsyncGenerator[AsyncSession, None]:\n    async with AsyncSession(engine) as session:\n        yield session\n\n\nasync def create_model_table() -\u003e None:\n    async with engine.begin() as conn:\n        await conn.run_sync(SQLModel.metadata.create_all)\n```\n\ndb에서 비동기 세션을 사용할 계획이므로, `create_engine`대신 `create_async_engine`을 사용합니다.\n\n`get_session`함수는 각 요청에서 사용할 session을 생성할때 사용하고,\n`create_model_table`은 작성한 모델에 대응하는 테이블을 db에 생성하는 함수입니다. 나중에 모델을 생성하고 나면, fastapi가 시작할때 자동으로 실행되도록 할 계획입니다.\n\n\u003e 만약 동기 세션을 사용한다면, `from sqlmodel import create_engine`으로 엔진을 생성하고,\n\u003e `AsyncSession` 대신 `from sqlmodel import Session`으로 `Session`을 사용하면 됩니다.\n\u003e 물론 `get_session`을 작성할 때, `async with` 대신 `with`로 바꿔야 합니다.\n\u003e 그리고 `create_model_table` 내부에서 `with context`를 사용할 필요 없이, `create_all` 메소드를 실행하면 됩니다.\n\n## db접속 모듈 테스트\n\n작성한 함수가 잘 실행되는지 확인하기 위해 main.py에 간단한 `get` api를 생성하겠습니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import Depends, FastAPI\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom database import get_session\n\n# 중략\n\n\n@app.get(\"/session_test\")\nasync def session_test(*, session: AsyncSession = Depends(get_session)):\n    data = await session.exec(text(\"select 1\"))  # type: ignore\n    return data.all()\n\n\n# 후략\n```\n\n\u003e `# type: ignore`는 `vscode`의 확장 프로그램인 `pylance`가 해당 라인의 정적 타입 확인을 하지 않도록 합니다.\n\u003e 이유는 모르겠는데, `text`가 `excutable`한데도 `excutable`한 객체로 인정하지를 않습니다.\n\u003e 사실 `sqlalchemy`자체가 정적 타입 체크시 많은 에러를 뿜긴 합니다.\n\n\u003e `session`의 `exec` 메소드는 `sqlalchemy`에 없는 메소드입니다. 기존 실행 메소드인 `execute`를 사용해도 무방하지만, `exec`는 `execute`의 `wrapper`이면서 type hint가 잘 되어 있으므로, 정적 타입 체크나 `vscode`의 자동완성 등에서 상당한 편의를 얻을 수 있습니다.\n\n`select 1` 쿼리를 실행하는 간단한 형태의 `get` api를 작성했습니다. 정상적으로 작성하셨다면\n\n```json\n[\n  {\n    \"?column?\": 1\n  }\n]\n```\n\n와 같은 결과를 받게 됩니다.\n여기서 사용된 `Depends`는 단순히 `session`을 받는 용도지만, 이 외에도 많은 사용법이 있습니다.\n관련 내용은 [여기](https://fastapi.tiangolo.com/tutorial/dependencies/)에서 확인할 수 있습니다.\n\n\u003e `fastapi`는 비동기 프로그래밍을 아주 잘 지원하기 때문에, **원한다면 그냥 `async def`를 사용하면 되고, 비동기가 아닌 io 작업이 있다면 그냥 `def`를 사용해도 됩니다. await 키워드를 사용하지 않더라도 async def를 사용해도 좋습니다. 어떻게 작성하든 `fastapi`가 알아서 잘 실행합니다.**\n\n## 사용할 모델 및 테이블 생성\n\n세션이 잘 붙은걸 확인했으니, 이제 사용할 모델을 생성하겠습니다.\n\n```python\n# api/model.py\nfrom datetime import datetime\nfrom typing import Optional\n\nfrom pydantic import EmailStr\nfrom sqlmodel import Field, SQLModel\n\n\nclass user(SQLModel, table=True):\n    id: Optional[int] = Field(None, primary_key=True)\n    name: str = Field(..., min_length=1, nullable=False)\n    email: EmailStr = Field(..., nullable=False)\n    registered_date: datetime = Field(default_factory=datetime.today)\n```\n\n`user`라는 모델이자 테이블인 클래스를 정의했습니다.\n`name`과 `email`은 필수값이고, `registered_date`는 자동으로 생성되도록 했습니다.\n\n\u003e `table=True` 파라미터는 `user` 클래스가 db에서 사용할 테이블이라는 것을 알려줍니다.\n\u003e 이 파라미터가 없으면, 이전에 작성한 `create_model_table` 함수를 실행해도 db에 테이블이 생성되지 않습니다.\n\npk로 지정한 `id`가 `Optional`이어서 의아할 수 있는데,\napi 서버에서 우선 `id`를 지정하지 않은 상태로 `user`인스턴스를 생성하고, 그 인스턴스를 `session`을 통해 추가하면 `user` 테이블에서는 정상적으로 `id`가 들어가게 됩니다.\n이후 api 서버에서 `id`를 확인하고 싶다면 `refresh`메소드를 사용하면 됩니다.\n\n### 테이블에 레코드를 추가하는 `post` api 생성\n\n이 과정을 담은 `post` api를 하나 생성하겠습니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import Depends, FastAPI\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom database import create_model_table, get_session\nfrom model import user\n\napp = FastAPI()\napp.on_event(\"startup\")(create_model_table)\n\n\n# 중략\n\n\n@app.post(\"/create_user\", response_model=user)\nasync def create_user(data: user, *, session: AsyncSession = Depends(get_session)):\n    user_instance = user.from_orm(data)\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n# 후략\n```\n\n기존에 작성했던 `create_model_table`함수를 `app.on_event(...)` 데코레이터를 이용해서 자동으로 실행되도록 했습니다.\n현재 `main.py`에 `user` 클래스가 있으므로 api 서버가 실행될때 `user` 테이블이 db에 없다면 자동으로 생성됩니다.\n\n`.env` 파일에 `RESTAPI_DEBUG=1`로 작성하셨다면, 다음과 같은 쿼리로 테이블이 생성됐다는 것을 로그에서 확인할 수 있습니다.\n\n```sql\nCREATE TABLE \"user\" (\n        id SERIAL,\n        name VARCHAR NOT NULL,\n        email VARCHAR NOT NULL,\n        registered_date TIMESTAMP WITHOUT TIME ZONE,\n        PRIMARY KEY (id)\n)\n```\n\n\u003e 아직 문자열을 `nvarchar`로 간단하게 설정하는 방법은 `sqlmodel`에 없습니다. `sqlalchemy`의 `Column`을 직접 작성해서 `Field`에 대응하는 방식으로만 가능합니다.\n\u003e `type_` 파라미터를 사용할 수 있도록 PR된 상태이니, 다음 버전에서는 가능할 것 같습니다.\n\n다음과 같은 `body`로 `post`를 요청하면\n\n```json\n{\n  \"name\": \"string\",\n  \"email\": \"user@example.com\"\n}\n```\n\n다음과 같은 결과를 받게 됩니다.\n\n```json\n{\n  \"id\": 1,\n  \"registered_date\": \"2021-11-25T23:51:26.156134\",\n  \"name\": \"string\",\n  \"email\": \"user@example.com\"\n}\n```\n\n### 레코드를 조회하는 `get` api 생성\n\n이제 이 유저 정보를 조회하는 `get` api를 생성하겠습니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import Depends, FastAPI, HTTPException, Path\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom database import create_model_table, get_session\nfrom model import user\n\n# 중략\n\n\n@app.get(\"/get_user/{user_id}\", response_model=user)\nasync def get_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    return user_instance\n\n\n# 후략\n```\n\n\u003e 여기서 사용된 `Path`는 **없어도 아무 문제가 없습니다.**\n\n`user_id`에 해당하는 `user`가 없을 경우 404에러를 반환하도록 했습니다.\n`fastapi`에서 제공하는 `Path`를 이용해서, `user_id`는 1 이상의 값만 받도록 제한했습니다. 내부적으로 `pydantic`을 사용하기 때문에, 빠르고 정확합니다.\n\n### 레코드를 수정하는 `patch` api 생성\n\n이어서 유저 정보를 수정하는 `patch` api를 작성합니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import Depends, FastAPI, HTTPException, Path\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom database import create_model_table, get_session\nfrom model import user\n\n# 중략\n\n\n@app.patch(\"/update_user/{user_id}\", response_model=user)\nasync def update_user(\n    data: user,\n    user_id: int = Path(..., ge=1),\n    *,\n    session: AsyncSession = Depends(get_session),\n):\n    user_instance = await session.get(user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    update_data = data.dict(exclude_unset=True)\n    for key, value in update_data.items():\n        setattr(user_instance, key, value)\n\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n# 후략\n```\n\n`data.dict` 메소드의 `exclude_unset=True` 파라미터는 `user` 클래스에 정의된 속성이면서 사용자가 `body`에 포함하지 않은 값을 제외한 딕셔너리를 반환하게 합니다.\n\n`user_id=1`에 다음과 같은 `body`를 보내면\n\n```json\n{\n  \"name\": \"aaa\",\n  \"email\": \"aaaa@example.com\"\n}\n```\n\n다음과 같은 `user`를 반환합니다.\n\n```json\n{\n  \"id\": 1,\n  \"registered_date\": \"2021-11-25T23:51:26.156134\",\n  \"name\": \"aaa\",\n  \"email\": \"aaaa@example.com\"\n}\n```\n\n이전에 생성한 `get` api로 조회해보면, 정상적으로 수정된 것을 확인할 수 있습니다.\n\n### 레코드를 제거하는 `delete` api 생성\n\n마지막으로 `delete` api를 작성합니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import Depends, FastAPI, HTTPException, Path\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom database import create_model_table, get_session\nfrom model import user\n\n# 중략\n\n\n@app.delete(\"/delete_user/{user_id}\")\nasync def delete_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is no {user_id=} user\")\n\n    await session.delete(user_instance)\n    await session.commit()\n\n    return user_id\n\n\n# 후략\n```\n\n`user_id=1`로 `delete` api를 요청 한 다음 `get` api를 요청하면 다음과 같은 메세지를 보냅니다.\n\n```json\n{\n  \"detail\": \"there is no user_id=1 user\"\n}\n```\n\n기초적인 형태의 `crud` api를 작성하고, 정상적으로 실행되는지 확인했습니다.\n몇몇 아쉬운 부분들이 눈에 띕니다.\n\n- 유저를 추가할때 중복을 확인하지 않는다.\n- 유저를 수정한 일자가 없다.\n- 왜 `response_model`은 user로 고정이지?\n- etc...\n\n이러한 부분들은 다음 글에서 확인하겠습니다.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/FastAPI, sqlmodel로 간단한 crud api 생성 2","data":{"title":"FastAPI, sqlmodel로 간단한 crud api 생성 2","date":"2021-11-26T00:21:45.352+09:00","tags":["crud","fastapi","python","sqlmodel","@all"],"page":"FastAPI, sqlmodel로 간단한 crud api 생성","summary":"db와 연결 후 기초적인 형태의 crud api 생성"}},"prev_post":{"name":"FastAPI, sqlmodel로 간단한 crud api 생성","content":"\n## 사용 라이브러리?프레임워크? 간단 소개\n\n### [FastAPI](https://fastapi.tiangolo.com/ko/)\n\npython type hint를 적극적으로 활용해서\n`rest api`를 만들때 생산성이 아주 좋습니다.\n`uvicorn`을 사용하기 때문에, `uvloop`로 성능도 준수해서 더욱 좋습니다.\n공식 [document](https://fastapi.tiangolo.com/ko/tutorial/)가 아주 잘 작성돼서 혼자 공부하기도 좋습니다.\n\n정말 좋으니까, `flask`를 써야할 일이 생긴다면 **꼭** `FastAPI`를 사용해보세요.\n\n### [SQLModel](https://sqlmodel.tiangolo.com/)\n\n`pydantic`과 `sqlalchemy`를 정교하게 섞어서 사용할 수 있도록 만든 라이브러리입니다.\n`FastAPI`와 작성자가 같습니다.\n`FastAPI`는 쿼리나 바디 등의 변수 타입 검증을 위해 `pydantic`을 사용하는데, `crud`용 테이블은 정작 `sqlalchemy`로 따로 작성해야해서 두번 작성하는 귀찮은 일이 많았습니다.\n`SQLModel`을 사용하면 그런 일이 없으니 편합니다.\n다만 아직 초기 개발 단계이고, 공식 [document](https://sqlmodel.tiangolo.com/tutorial/)도 그렇게 좋지는 않습니다.\n\n## api 작성 전 초기작업\n\npython 버전은 `3.9.9`를 사용합니다.\ndb는 `postgres`를 사용합니다.\n간단하게 만들 생각이기 때문에, 많이 설치하지 않습니다.\n`fastapi`, `uvicorn`, `email-validator`, `sqlmodel`, `asyncpg`\n이렇게 5개만 설치하겠습니다.\n\n`podman`를 간단하게나마 사용할 예정이기 때문에, `dockerfile`을 작성합니다.\n\n\u003e `podman`을 사용하지만 `dockerfile`을 사용하는 것 처럼, 그냥 `docker`를 사용하셔도 아무 문제가 없습니다.\n\u003e\n\u003e \u003e 저는 zshrc에 `podman`과 `podman-compose`를 각각 `docker`와 `docker-compose`로 alias설정했습니다.\n\n```\n# dockerfile\nFROM python:3.9-bullseye\n\nWORKDIR /api\n\nADD https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh /\nRUN [\"chmod\", \"+x\", \"/wait-for-it.sh\"]\n\nCOPY ./requirements.txt /requirements.txt\nRUN pip install --no-cache-dir --upgrade -r /requirements.txt\n```\n\n처음에 추가한 `wait-for-it.sh`는 db가 정상적으로 생성되고, 연결이 가능한지 확인하기 위한 쉘스크립트입니다.\n\n`wait-for-it.sh`를 다운로드 한 다음 실행권한을 주고,\n로컬에 존재하는 `requirements.txt`를 가져와서 pip로 필요한 패키지를 설치하는 간단한 구성의 `dockerfile`입니다.\n\n이어서 db와 api에서 사용할 환경변수를 `.env`파일로 작성합니다.\n\n```bash\n# .env\nPOSTGRES_USER=safeuser\nPOSTGRES_PASSWORD=s@fep@ssw0rd\nPOSTGRES_DB=restapi\nPOSTGRES_PORT=8081\n\nRESTAPI_PORT=8000\nRESTAPI_OUT_PORT=8000\nRESTAPI_DEBUG=1\n```\n\n순서대로, sql에서 사용할 아이디, 비밀번호, database이름, 포트,\n그리고 FastAPI가 실행될 포트, 도커 외부에서 api에 접속할 포트, 디버그 여부 플래그입니다.\n\n그리고 `docker-compose.yml`을 작성합니다.\n\n```yml\n# docker-compose.yml\nversion: '3'\n\nservices:\n  db:\n    image: postgres:latest\n    env_file:\n      - .env\n    command: -p ${POSTGRES_PORT}\n    volumes:\n      - ./db:/var/lib/postgresql/data\n\n  api:\n    build:\n      context: .\n      dockerfile: ./dockerfile\n    image: restapi:latest\n    env_file:\n      - .env\n    command:\n      - bash\n      - -c\n      - |\n        /wait-for-it.sh db:${POSTGRES_PORT} -t 10\n        python main.py\n    ports:\n      - '${RESTAPI_OUT_PORT}:${RESTAPI_PORT}'\n    depends_on:\n      - db\n    volumes:\n      - ./api:/api\n      - /etc/localtime:/etc/localtime:ro\n```\n\n컨테이너가 종료되더라도 db가 유지될 수 있게 로컬경로의 db폴더를 마운트 할 예정입니다. `docker volume`을 사용해도 되지만, 지금은 별로 중요한게 아닙니다.\n\n빌드되는 이미지 명은 별 생각없이 restapi라고 했습니다.\napi 컨테이너는 우선 db가 연결 가능한 상태인지 확인하고, 최대 10초간 대기합니다.\n연결이 가능하거나, 10초가 지나면, 현재 폴더의 `main.py`를 실행하도록 했습니다.\n\nvolumes에 작성된 것 처럼, 로컬 경로의 api폴더를 컨테이너 내부의 /api에 마운트했습니다.\n당연하게도, 로컬 경로의 api폴더에 FastAPI로 작성할 모든 결과물이 들어가게 됩니다.\n\n끝으로 실제로 실행할 `main.py`를 작성합니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import FastAPI\n\napp = FastAPI()\n\n\n@app.get(\"/\")\ndef index():\n    return {\"hello\": \"world\"}\n\n\nif __name__ == \"__main__\":\n    uvicorn.run(\n        \"main:app\",\n        host=\"0.0.0.0\",\n        port=int(environ[\"RESTAPI_PORT\"]),\n        reload=bool(int(environ[\"RESTAPI_DEBUG\"])),\n    )\n```\n\ndb를 생성하긴 하지만, 당장은 db와 관련된 작업을 하지 않겠습니다. 다음 글에서 이어서 하는걸로..\n\n정상적으로 따라오셨다면, 다음과 같은 구조입니다.\n\n```\n.\n├── .env\n├── api\n│   └── main.py\n├── db\n├── docker-compose.yml\n├── dockerfile\n└── requirements.txt\n```\n\n이제 실행해봅시다.\n`docker-compose up`으로 실행이 가능합니다.\n\n이제 http://localhost:8000 에 접속하면\n\n```python\n{\"hello\":\"world\"}\n```\n\n을 확인할 수 있습니다.\n\n작성된 api를 확인하기 위해\nhttp://localhost:8000/docs 에 접속하면\n다음과 같이 확인할 수 있습니다.\n![](/images/dbba2083-54d9-4406-89d2-dfc5b61cf360-docs.png)\n\n다음에는 `SQLModel`을 사용해서 모델을 만들고,\n그 모델을 이용한 간단한 형태의 `crud` api를 생성해보겠습니다.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/FastAPI, sqlmodel로 간단한 crud api 생성","data":{"title":"FastAPI, sqlmodel로 간단한 crud api 생성","date":"2021-11-25T22:13:02.346+09:00","tags":["fastapi","python","sqlmodel","@all"],"page":"FastAPI, sqlmodel로 간단한 crud api 생성","summary":"fastapi로 index만 구성하는 것 까지 진행"}},"next_post":{"name":"FastAPI, sqlmodel로 간단한 crud api 생성 3","content":"\n이전 글에서 몇가지 의문점을 남겨놨습니다.\n\n- 유저를 추가할때 중복을 확인하지 않는다.\n- 유저를 수정한 일자가 없다.\n- 왜 response_model은 user로 고정이지?\n- etc...\n\n**다음 글**에서, 이러한 부분들을 고쳐가겠습니다.\n\n## 그 전에...\n\n지난 글까지 작성한 스크립트는 모두 한 폴더에 모여있습니다. 이런 구조는 지금같이 간단한 수준일때는 문제가 없지만, 점점 개발을 힘들게 만듭니다.\n그렇기 때문에, 간단한 형태로 구조화할 생각입니다.\n**아직 많이 부족하여, 효율적인 구조일지는 장담할 수 없습니다..**\n\n계획은 이렇습니다.\n\n\u003e 1. api 서버를 실행하는 스크립트를 최상위 폴더에 위치하고, `scripts` 폴더를 생성\n\u003e 2. `scripts` 폴더에 `config`, `database`, `models`, `routes` 폴더를 생성\n\u003e    \u003e `config` : 환경설정과 관련된 스크립트를 모아놓습니다. **다른 경로의 스크립트를 참조하지 않습니다.** \u003e\u003e `database` : db와 관련된 기본적인 작업에 대한 스크립트를 모아놓습니다.\n\u003e    \u003e `models` : 여러 api를 작성할 때 사용될 모델에 대한 스크립트를 모아놓습니다.\n\u003e    \u003e `routes` : 여러 api에 대해 입맛에 맞게 구조화하여 배치합니다.\n\u003e\n\u003e ### 왜 최상위 폴더가 아닌 `scripts` 폴더에?\n\u003e\n\u003e 파이썬에는 상대참조와 절대참조가 있습니다.\n\u003e 아직 많이 부족하여, 정확히 이건 어떻고 저건 어떻다 말할 수준은 못되지만, **상대참조는 패키지로 구성된 스크립트에서만 가능하다고 알고 있습니다.**\n\u003e 그렇기에, `scripts`폴더를 최상위 경로에서 사용할 수 있는 로컬 패키지처럼 사용하기 위해 `scripts`폴더를 생성 후, 하위 경로로 다른 폴더를 위치하게 했습니다.\n\n### 1. config\n\n앞으로 사용할 `settings` 클래스를 정의할 스크립트인 `default.py`를 생성하겠습니다.\n\n```python\n# api/scripts/config/default.py\nfrom typing import Any\n\nfrom pydantic import BaseSettings, Field\n\n\nclass database(BaseSettings):\n    drivername: str = \"postgresql+asyncpg\"\n    host: str = \"db\"\n\n    username: str = Field(..., env=\"POSTGRES_USER\")\n    password: str = Field(..., env=\"POSTGRES_PASSWORD\")\n    port: int = Field(..., env=\"POSTGRES_PORT\")\n    database: str = Field(..., env=\"POSTGRES_DB\")\n\n    query: dict[str, Any] = Field(default_factory=dict)\n\n\nclass settings(BaseSettings):\n    debug: bool = Field(..., env=\"RESTAPI_DEBUG\")\n\n    run_port: int = Field(..., env=\"RESTAPI_PORT\")\n    access_port: int = Field(..., env=\"RESTAPI_OUT_PORT\")\n\n    database: database = database()\n```\n\n그리고 `__ init__.py`를 생성해서 `settings` 클래스의 인스턴스를 생성합니다.\n\n```python\n# api/scripts/config/__init__.py\nfrom .default import settings\n\n__all__ = (\"settings\",)\n\nsettings = settings()\n```\n\n이제 `scripts.config.settings`로 설정값에 접근할 수 있습니다.\n\n### 2. database\n\n`routes`에서 빈번하게 사용될 `get_session`과 같은 범용적인 db관련 스크립트를 작성합니다.\n\n```python\n# api/scripts/database/default.py\nfrom typing import AsyncGenerator\n\nfrom sqlalchemy.engine.url import URL\nfrom sqlalchemy.ext.asyncio.engine import create_async_engine\nfrom sqlmodel import SQLModel\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom ..config import settings\n\nurl = URL.create(**settings.database.dict())\nengine = create_async_engine(url, echo=settings.debug)\n\n\nasync def get_session() -\u003e AsyncGenerator[AsyncSession, None]:\n    async with AsyncSession(engine) as session:\n        yield session\n\n\nasync def create_model_table() -\u003e None:\n    async with engine.begin() as conn:\n        await conn.run_sync(SQLModel.metadata.create_all)\n```\n\n기존에 최상위 경로에 생성했던 `database.py`와 달라진 점은, **직접 환경변수를 불러오지 않고,** 이전에 작성한 `scripts.config.settings`를 불러와서 사용한다는 것입니다.\n\n이어서 `__ init__.py`를 작성해서, 실제로 사용할 함수를 모아놓습니다.\n\n```python\n# api/scripts/database/__init__.py\nfrom .default import create_model_table, get_session\n\n__all__ = (\"get_session\", \"create_model_table\")\n```\n\n### 3. models\n\n우선 `user`폴더를 생성한 다음, 그 폴더에 `__ init__.py`를 작성하겠습니다.\n\n\u003e 굳이 이렇게 하는 이유는\n\n- 각 라우트 혹은 모델별로 다른 폴더에 관리하면 편했던 기억이 있어서 그렇고,\n- 지금은 사용하지 않지만, `orjson`으로 `json`을 loads, dumps 할때, `pydantic`의 `BaseModel`을 상속한 새로운 모델을 만들어서 사용하는데, 그 모델을 `models.__init__.py`에 작성해두면 나중에 쓸때 편했기 때문입니다.\n\n**`api/scripts/models/user/__init__.py`는 기존 `model.py`와 같으므로 생략합니다.**\n\n### 4. routes\n\n기존에 `main.py`에 있던 `crud` api를 옮깁니다.\n이것도 `models`와 같이, `user`폴더를 생성 한 다음 해당 폴더에 스크립트를 작성합니다.\n\n우선 `main.py`에 정의된 `app`에 연결할 라우터를 정의할 `app.py`부터 작성합니다.\n\n```python\n# api/scripts/routes/user/app.py\nfrom fastapi import APIRouter\n\napp = APIRouter()\n```\n\n굳이 이렇게 따로 뺀 이유는 순환 참조 오류를 방지하기 위해서 입니다.\n\n여기서 `tags`와 `prefix`를 설정할 수도 있지만, 개인적으로 `main.py`에서 일괄적으로 확인하고 수정할 수 있는게 편해서 지금은 하지 않았습니다.\n\n다음으로 이전에 작성한 `crud` api를 모아놓은 `crud.py`를 작성합니다.\n\n```python\n# api/scripts/scripts/routes/user/crud.py\nfrom fastapi import Depends, HTTPException, Path\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom ...database import get_session\nfrom ...models import user\nfrom .app import app\n\n\n@app.post(\"/create_user\", response_model=user.user)\nasync def create_user(data: user.user, *, session: AsyncSession = Depends(get_session)):\n    user_instance = user.user.from_orm(data)\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n@app.get(\"/get_user/{user_id}\", response_model=user.user)\nasync def get_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    return user_instance\n\n\n@app.patch(\"/update_user/{user_id}\", response_model=user.user)\nasync def update_user(\n    data: user.user,\n    user_id: int = Path(..., ge=1),\n    *,\n    session: AsyncSession = Depends(get_session),\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    update_data = data.dict(exclude_unset=True)\n    for key, value in update_data.items():\n        setattr(user_instance, key, value)\n\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n@app.delete(\"/delete_user/{user_id}\")\nasync def delete_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    await session.delete(user_instance)\n    await session.commit()\n\n    return user_id\n```\n\n여기서 사용되는 `app`은 `main.py`의 `app`이 아닌, 같은 폴더의 `app.py`의 `app`입니다.\n\n마지막으로 `__ init__.py`를 작성합니다.\n\n```python\n# api/scripts/routes/user/__init__.py\nfrom .crud import app\n```\n\n여기서 불러온 앱은 `crud` api가 기억된 상태로, 나중에 `main.py`에서 불러옵니다.\n\n이제 `main.py`를 정리합니다.\n\n```python\n# api/main.py\nimport uvicorn\nfrom fastapi import Depends, FastAPI\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom scripts.config import settings\nfrom scripts.database import create_model_table, get_session\nfrom scripts.routes import user\n\napp = FastAPI()\napp.on_event(\"startup\")(create_model_table)\napp.include_router(user.app, prefix=\"/user\", tags=[\"user\"])\n\n\n@app.get(\"/\")\ndef index():\n    return {\"hello\": \"world\"}\n\n\n@app.get(\"/session_test\")\nasync def session_test(*, session: AsyncSession = Depends(get_session)):\n    data = await session.exec(text(\"select 1\"))  # type: ignore\n    return data.all()\n\n\nif __name__ == \"__main__\":\n    uvicorn.run(\n        \"main:app\",\n        host=\"0.0.0.0\",\n        port=settings.run_port,\n        reload=settings.debug,\n    )\n```\n\n`api`폴더는 최상위 폴더이므로, `scripts`를 패키지처럼 다루면 됩니다.\n`user` 라우터는 `prefix=\"user\"`, `tags=[\"user\"]`로 파라미터를 줬습니다. 나중에 docs에서 확인해보면 차이를 알 수 있습니다.\n이제는 사용하지 않는 기존 `api/database.py`, `api/model.py`를 제거합니다.\n정상적으로 진행했다면, 다음과 같은 구조를 가지게 됩니다.\n\n```\n.\n├── .env\n├── api\n│   ├── main.py\n│   └── scripts\n│       ├── config\n│       │   ├── __init__.py\n│       │   └── default.py\n│       ├── database\n│       │   ├── __init__.py\n│       │   └── default.py\n│       ├── models\n│       │   └── user\n│       │       └── __init__.py\n│       └── routes\n│           └── user\n│               ├── __init__.py\n│               ├── app.py\n│               └── crud.py\n├── db [error opening dir]\n├── docker-compose.yml\n├── dockerfile\n└── requirements.txt\n```\n\n`db`폴더에 접근이 불가능 한 것은, 컨테이너 내부에서 관리자 권한으로 작성됐기 때문입니다.\n이제 `docker-compose up`으로 실행해서 docs를 확인해봅시다.\n![](/images/80800d72-874a-4bc0-afd5-80792cf91bef-docs.png)\napi 경로에 `user`가 추가됐고,\n각 api가 사전에 설정한 `tags`를 기준으로 나뉘어 진 것을 확인할 수 있습니다.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/FastAPI, sqlmodel로 간단한 crud api 생성 3","data":{"title":"FastAPI, sqlmodel로 간단한 crud api 생성 3","date":"2021-11-26T22:52:37.564+09:00","tags":["crud","fastapi","python","sqlmodel","@all"],"page":"FastAPI, sqlmodel로 간단한 crud api 생성","summary":"crud api를 보완하기 전, 구조를 적당히 변환"}},"page_posts":[{"name":"FastAPI, sqlmodel로 간단한 crud api 생성","content":"\n## 사용 라이브러리?프레임워크? 간단 소개\n\n### [FastAPI](https://fastapi.tiangolo.com/ko/)\n\npython type hint를 적극적으로 활용해서\n`rest api`를 만들때 생산성이 아주 좋습니다.\n`uvicorn`을 사용하기 때문에, `uvloop`로 성능도 준수해서 더욱 좋습니다.\n공식 [document](https://fastapi.tiangolo.com/ko/tutorial/)가 아주 잘 작성돼서 혼자 공부하기도 좋습니다.\n\n정말 좋으니까, `flask`를 써야할 일이 생긴다면 **꼭** `FastAPI`를 사용해보세요.\n\n### [SQLModel](https://sqlmodel.tiangolo.com/)\n\n`pydantic`과 `sqlalchemy`를 정교하게 섞어서 사용할 수 있도록 만든 라이브러리입니다.\n`FastAPI`와 작성자가 같습니다.\n`FastAPI`는 쿼리나 바디 등의 변수 타입 검증을 위해 `pydantic`을 사용하는데, `crud`용 테이블은 정작 `sqlalchemy`로 따로 작성해야해서 두번 작성하는 귀찮은 일이 많았습니다.\n`SQLModel`을 사용하면 그런 일이 없으니 편합니다.\n다만 아직 초기 개발 단계이고, 공식 [document](https://sqlmodel.tiangolo.com/tutorial/)도 그렇게 좋지는 않습니다.\n\n## api 작성 전 초기작업\n\npython 버전은 `3.9.9`를 사용합니다.\ndb는 `postgres`를 사용합니다.\n간단하게 만들 생각이기 때문에, 많이 설치하지 않습니다.\n`fastapi`, `uvicorn`, `email-validator`, `sqlmodel`, `asyncpg`\n이렇게 5개만 설치하겠습니다.\n\n`podman`를 간단하게나마 사용할 예정이기 때문에, `dockerfile`을 작성합니다.\n\n\u003e `podman`을 사용하지만 `dockerfile`을 사용하는 것 처럼, 그냥 `docker`를 사용하셔도 아무 문제가 없습니다.\n\u003e\n\u003e \u003e 저는 zshrc에 `podman`과 `podman-compose`를 각각 `docker`와 `docker-compose`로 alias설정했습니다.\n\n```\n# dockerfile\nFROM python:3.9-bullseye\n\nWORKDIR /api\n\nADD https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh /\nRUN [\"chmod\", \"+x\", \"/wait-for-it.sh\"]\n\nCOPY ./requirements.txt /requirements.txt\nRUN pip install --no-cache-dir --upgrade -r /requirements.txt\n```\n\n처음에 추가한 `wait-for-it.sh`는 db가 정상적으로 생성되고, 연결이 가능한지 확인하기 위한 쉘스크립트입니다.\n\n`wait-for-it.sh`를 다운로드 한 다음 실행권한을 주고,\n로컬에 존재하는 `requirements.txt`를 가져와서 pip로 필요한 패키지를 설치하는 간단한 구성의 `dockerfile`입니다.\n\n이어서 db와 api에서 사용할 환경변수를 `.env`파일로 작성합니다.\n\n```bash\n# .env\nPOSTGRES_USER=safeuser\nPOSTGRES_PASSWORD=s@fep@ssw0rd\nPOSTGRES_DB=restapi\nPOSTGRES_PORT=8081\n\nRESTAPI_PORT=8000\nRESTAPI_OUT_PORT=8000\nRESTAPI_DEBUG=1\n```\n\n순서대로, sql에서 사용할 아이디, 비밀번호, database이름, 포트,\n그리고 FastAPI가 실행될 포트, 도커 외부에서 api에 접속할 포트, 디버그 여부 플래그입니다.\n\n그리고 `docker-compose.yml`을 작성합니다.\n\n```yml\n# docker-compose.yml\nversion: '3'\n\nservices:\n  db:\n    image: postgres:latest\n    env_file:\n      - .env\n    command: -p ${POSTGRES_PORT}\n    volumes:\n      - ./db:/var/lib/postgresql/data\n\n  api:\n    build:\n      context: .\n      dockerfile: ./dockerfile\n    image: restapi:latest\n    env_file:\n      - .env\n    command:\n      - bash\n      - -c\n      - |\n        /wait-for-it.sh db:${POSTGRES_PORT} -t 10\n        python main.py\n    ports:\n      - '${RESTAPI_OUT_PORT}:${RESTAPI_PORT}'\n    depends_on:\n      - db\n    volumes:\n      - ./api:/api\n      - /etc/localtime:/etc/localtime:ro\n```\n\n컨테이너가 종료되더라도 db가 유지될 수 있게 로컬경로의 db폴더를 마운트 할 예정입니다. `docker volume`을 사용해도 되지만, 지금은 별로 중요한게 아닙니다.\n\n빌드되는 이미지 명은 별 생각없이 restapi라고 했습니다.\napi 컨테이너는 우선 db가 연결 가능한 상태인지 확인하고, 최대 10초간 대기합니다.\n연결이 가능하거나, 10초가 지나면, 현재 폴더의 `main.py`를 실행하도록 했습니다.\n\nvolumes에 작성된 것 처럼, 로컬 경로의 api폴더를 컨테이너 내부의 /api에 마운트했습니다.\n당연하게도, 로컬 경로의 api폴더에 FastAPI로 작성할 모든 결과물이 들어가게 됩니다.\n\n끝으로 실제로 실행할 `main.py`를 작성합니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import FastAPI\n\napp = FastAPI()\n\n\n@app.get(\"/\")\ndef index():\n    return {\"hello\": \"world\"}\n\n\nif __name__ == \"__main__\":\n    uvicorn.run(\n        \"main:app\",\n        host=\"0.0.0.0\",\n        port=int(environ[\"RESTAPI_PORT\"]),\n        reload=bool(int(environ[\"RESTAPI_DEBUG\"])),\n    )\n```\n\ndb를 생성하긴 하지만, 당장은 db와 관련된 작업을 하지 않겠습니다. 다음 글에서 이어서 하는걸로..\n\n정상적으로 따라오셨다면, 다음과 같은 구조입니다.\n\n```\n.\n├── .env\n├── api\n│   └── main.py\n├── db\n├── docker-compose.yml\n├── dockerfile\n└── requirements.txt\n```\n\n이제 실행해봅시다.\n`docker-compose up`으로 실행이 가능합니다.\n\n이제 http://localhost:8000 에 접속하면\n\n```python\n{\"hello\":\"world\"}\n```\n\n을 확인할 수 있습니다.\n\n작성된 api를 확인하기 위해\nhttp://localhost:8000/docs 에 접속하면\n다음과 같이 확인할 수 있습니다.\n![](/images/dbba2083-54d9-4406-89d2-dfc5b61cf360-docs.png)\n\n다음에는 `SQLModel`을 사용해서 모델을 만들고,\n그 모델을 이용한 간단한 형태의 `crud` api를 생성해보겠습니다.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/FastAPI, sqlmodel로 간단한 crud api 생성","data":{"title":"FastAPI, sqlmodel로 간단한 crud api 생성","date":"2021-11-25T22:13:02.346+09:00","tags":["fastapi","python","sqlmodel","@all"],"page":"FastAPI, sqlmodel로 간단한 crud api 생성","summary":"fastapi로 index만 구성하는 것 까지 진행"}},{"name":"FastAPI, sqlmodel로 간단한 crud api 생성 2","content":"\n## db접속 모듈 생성\n\n지난 글에서 db 컨테이너를 생성했지만 사용은 하지 않고 끝냈습니다. 이제 db를 연결하기 위한 작업을 진행하겠습니다.\n\n\u003e 저는 `fastapi`와 `sqlmodel`의 기능을 최대한 사용하기 위해 `Field`나 `Depends`, `Path` 등을 가능하다면 사용하지만, **사용하지 않아도 대부분의 경우 문제가 없습니다.** \u003e `fastapi` 와 `sqlmodel`이 **알아서 해결합니다.**\n\n`fastapi`는 `Depends`라는 재밌는 함수를 가지고 있습니다. 이걸 이용하면 코드를 깔끔하게 작성할 수 있는데, 이때 사용할 수 있는 형태로 database.py를 작성하겠습니다.\n\n```python\n# api/database.py\nfrom os import environ\nfrom typing import AsyncGenerator\n\nfrom sqlalchemy.engine.url import URL\nfrom sqlalchemy.ext.asyncio.engine import create_async_engine\nfrom sqlmodel import SQLModel\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\ndatabase = dict(\n    drivername=\"postgresql+asyncpg\",\n    username=environ[\"POSTGRES_USER\"],\n    password=environ[\"POSTGRES_PASSWORD\"],\n    host=\"db\",\n    port=environ[\"POSTGRES_PORT\"],\n    database=environ[\"POSTGRES_DB\"],\n)\nurl = URL.create(**database)\nengine = create_async_engine(url, echo=bool(int(environ[\"RESTAPI_DEBUG\"])))\n\n\nasync def get_session() -\u003e AsyncGenerator[AsyncSession, None]:\n    async with AsyncSession(engine) as session:\n        yield session\n\n\nasync def create_model_table() -\u003e None:\n    async with engine.begin() as conn:\n        await conn.run_sync(SQLModel.metadata.create_all)\n```\n\ndb에서 비동기 세션을 사용할 계획이므로, `create_engine`대신 `create_async_engine`을 사용합니다.\n\n`get_session`함수는 각 요청에서 사용할 session을 생성할때 사용하고,\n`create_model_table`은 작성한 모델에 대응하는 테이블을 db에 생성하는 함수입니다. 나중에 모델을 생성하고 나면, fastapi가 시작할때 자동으로 실행되도록 할 계획입니다.\n\n\u003e 만약 동기 세션을 사용한다면, `from sqlmodel import create_engine`으로 엔진을 생성하고,\n\u003e `AsyncSession` 대신 `from sqlmodel import Session`으로 `Session`을 사용하면 됩니다.\n\u003e 물론 `get_session`을 작성할 때, `async with` 대신 `with`로 바꿔야 합니다.\n\u003e 그리고 `create_model_table` 내부에서 `with context`를 사용할 필요 없이, `create_all` 메소드를 실행하면 됩니다.\n\n## db접속 모듈 테스트\n\n작성한 함수가 잘 실행되는지 확인하기 위해 main.py에 간단한 `get` api를 생성하겠습니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import Depends, FastAPI\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom database import get_session\n\n# 중략\n\n\n@app.get(\"/session_test\")\nasync def session_test(*, session: AsyncSession = Depends(get_session)):\n    data = await session.exec(text(\"select 1\"))  # type: ignore\n    return data.all()\n\n\n# 후략\n```\n\n\u003e `# type: ignore`는 `vscode`의 확장 프로그램인 `pylance`가 해당 라인의 정적 타입 확인을 하지 않도록 합니다.\n\u003e 이유는 모르겠는데, `text`가 `excutable`한데도 `excutable`한 객체로 인정하지를 않습니다.\n\u003e 사실 `sqlalchemy`자체가 정적 타입 체크시 많은 에러를 뿜긴 합니다.\n\n\u003e `session`의 `exec` 메소드는 `sqlalchemy`에 없는 메소드입니다. 기존 실행 메소드인 `execute`를 사용해도 무방하지만, `exec`는 `execute`의 `wrapper`이면서 type hint가 잘 되어 있으므로, 정적 타입 체크나 `vscode`의 자동완성 등에서 상당한 편의를 얻을 수 있습니다.\n\n`select 1` 쿼리를 실행하는 간단한 형태의 `get` api를 작성했습니다. 정상적으로 작성하셨다면\n\n```json\n[\n  {\n    \"?column?\": 1\n  }\n]\n```\n\n와 같은 결과를 받게 됩니다.\n여기서 사용된 `Depends`는 단순히 `session`을 받는 용도지만, 이 외에도 많은 사용법이 있습니다.\n관련 내용은 [여기](https://fastapi.tiangolo.com/tutorial/dependencies/)에서 확인할 수 있습니다.\n\n\u003e `fastapi`는 비동기 프로그래밍을 아주 잘 지원하기 때문에, **원한다면 그냥 `async def`를 사용하면 되고, 비동기가 아닌 io 작업이 있다면 그냥 `def`를 사용해도 됩니다. await 키워드를 사용하지 않더라도 async def를 사용해도 좋습니다. 어떻게 작성하든 `fastapi`가 알아서 잘 실행합니다.**\n\n## 사용할 모델 및 테이블 생성\n\n세션이 잘 붙은걸 확인했으니, 이제 사용할 모델을 생성하겠습니다.\n\n```python\n# api/model.py\nfrom datetime import datetime\nfrom typing import Optional\n\nfrom pydantic import EmailStr\nfrom sqlmodel import Field, SQLModel\n\n\nclass user(SQLModel, table=True):\n    id: Optional[int] = Field(None, primary_key=True)\n    name: str = Field(..., min_length=1, nullable=False)\n    email: EmailStr = Field(..., nullable=False)\n    registered_date: datetime = Field(default_factory=datetime.today)\n```\n\n`user`라는 모델이자 테이블인 클래스를 정의했습니다.\n`name`과 `email`은 필수값이고, `registered_date`는 자동으로 생성되도록 했습니다.\n\n\u003e `table=True` 파라미터는 `user` 클래스가 db에서 사용할 테이블이라는 것을 알려줍니다.\n\u003e 이 파라미터가 없으면, 이전에 작성한 `create_model_table` 함수를 실행해도 db에 테이블이 생성되지 않습니다.\n\npk로 지정한 `id`가 `Optional`이어서 의아할 수 있는데,\napi 서버에서 우선 `id`를 지정하지 않은 상태로 `user`인스턴스를 생성하고, 그 인스턴스를 `session`을 통해 추가하면 `user` 테이블에서는 정상적으로 `id`가 들어가게 됩니다.\n이후 api 서버에서 `id`를 확인하고 싶다면 `refresh`메소드를 사용하면 됩니다.\n\n### 테이블에 레코드를 추가하는 `post` api 생성\n\n이 과정을 담은 `post` api를 하나 생성하겠습니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import Depends, FastAPI\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom database import create_model_table, get_session\nfrom model import user\n\napp = FastAPI()\napp.on_event(\"startup\")(create_model_table)\n\n\n# 중략\n\n\n@app.post(\"/create_user\", response_model=user)\nasync def create_user(data: user, *, session: AsyncSession = Depends(get_session)):\n    user_instance = user.from_orm(data)\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n# 후략\n```\n\n기존에 작성했던 `create_model_table`함수를 `app.on_event(...)` 데코레이터를 이용해서 자동으로 실행되도록 했습니다.\n현재 `main.py`에 `user` 클래스가 있으므로 api 서버가 실행될때 `user` 테이블이 db에 없다면 자동으로 생성됩니다.\n\n`.env` 파일에 `RESTAPI_DEBUG=1`로 작성하셨다면, 다음과 같은 쿼리로 테이블이 생성됐다는 것을 로그에서 확인할 수 있습니다.\n\n```sql\nCREATE TABLE \"user\" (\n        id SERIAL,\n        name VARCHAR NOT NULL,\n        email VARCHAR NOT NULL,\n        registered_date TIMESTAMP WITHOUT TIME ZONE,\n        PRIMARY KEY (id)\n)\n```\n\n\u003e 아직 문자열을 `nvarchar`로 간단하게 설정하는 방법은 `sqlmodel`에 없습니다. `sqlalchemy`의 `Column`을 직접 작성해서 `Field`에 대응하는 방식으로만 가능합니다.\n\u003e `type_` 파라미터를 사용할 수 있도록 PR된 상태이니, 다음 버전에서는 가능할 것 같습니다.\n\n다음과 같은 `body`로 `post`를 요청하면\n\n```json\n{\n  \"name\": \"string\",\n  \"email\": \"user@example.com\"\n}\n```\n\n다음과 같은 결과를 받게 됩니다.\n\n```json\n{\n  \"id\": 1,\n  \"registered_date\": \"2021-11-25T23:51:26.156134\",\n  \"name\": \"string\",\n  \"email\": \"user@example.com\"\n}\n```\n\n### 레코드를 조회하는 `get` api 생성\n\n이제 이 유저 정보를 조회하는 `get` api를 생성하겠습니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import Depends, FastAPI, HTTPException, Path\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom database import create_model_table, get_session\nfrom model import user\n\n# 중략\n\n\n@app.get(\"/get_user/{user_id}\", response_model=user)\nasync def get_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    return user_instance\n\n\n# 후략\n```\n\n\u003e 여기서 사용된 `Path`는 **없어도 아무 문제가 없습니다.**\n\n`user_id`에 해당하는 `user`가 없을 경우 404에러를 반환하도록 했습니다.\n`fastapi`에서 제공하는 `Path`를 이용해서, `user_id`는 1 이상의 값만 받도록 제한했습니다. 내부적으로 `pydantic`을 사용하기 때문에, 빠르고 정확합니다.\n\n### 레코드를 수정하는 `patch` api 생성\n\n이어서 유저 정보를 수정하는 `patch` api를 작성합니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import Depends, FastAPI, HTTPException, Path\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom database import create_model_table, get_session\nfrom model import user\n\n# 중략\n\n\n@app.patch(\"/update_user/{user_id}\", response_model=user)\nasync def update_user(\n    data: user,\n    user_id: int = Path(..., ge=1),\n    *,\n    session: AsyncSession = Depends(get_session),\n):\n    user_instance = await session.get(user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    update_data = data.dict(exclude_unset=True)\n    for key, value in update_data.items():\n        setattr(user_instance, key, value)\n\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n# 후략\n```\n\n`data.dict` 메소드의 `exclude_unset=True` 파라미터는 `user` 클래스에 정의된 속성이면서 사용자가 `body`에 포함하지 않은 값을 제외한 딕셔너리를 반환하게 합니다.\n\n`user_id=1`에 다음과 같은 `body`를 보내면\n\n```json\n{\n  \"name\": \"aaa\",\n  \"email\": \"aaaa@example.com\"\n}\n```\n\n다음과 같은 `user`를 반환합니다.\n\n```json\n{\n  \"id\": 1,\n  \"registered_date\": \"2021-11-25T23:51:26.156134\",\n  \"name\": \"aaa\",\n  \"email\": \"aaaa@example.com\"\n}\n```\n\n이전에 생성한 `get` api로 조회해보면, 정상적으로 수정된 것을 확인할 수 있습니다.\n\n### 레코드를 제거하는 `delete` api 생성\n\n마지막으로 `delete` api를 작성합니다.\n\n```python\n# api/main.py\nfrom os import environ\n\nimport uvicorn\nfrom fastapi import Depends, FastAPI, HTTPException, Path\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom database import create_model_table, get_session\nfrom model import user\n\n# 중략\n\n\n@app.delete(\"/delete_user/{user_id}\")\nasync def delete_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is no {user_id=} user\")\n\n    await session.delete(user_instance)\n    await session.commit()\n\n    return user_id\n\n\n# 후략\n```\n\n`user_id=1`로 `delete` api를 요청 한 다음 `get` api를 요청하면 다음과 같은 메세지를 보냅니다.\n\n```json\n{\n  \"detail\": \"there is no user_id=1 user\"\n}\n```\n\n기초적인 형태의 `crud` api를 작성하고, 정상적으로 실행되는지 확인했습니다.\n몇몇 아쉬운 부분들이 눈에 띕니다.\n\n- 유저를 추가할때 중복을 확인하지 않는다.\n- 유저를 수정한 일자가 없다.\n- 왜 `response_model`은 user로 고정이지?\n- etc...\n\n이러한 부분들은 다음 글에서 확인하겠습니다.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/FastAPI, sqlmodel로 간단한 crud api 생성 2","data":{"title":"FastAPI, sqlmodel로 간단한 crud api 생성 2","date":"2021-11-26T00:21:45.352+09:00","tags":["crud","fastapi","python","sqlmodel","@all"],"page":"FastAPI, sqlmodel로 간단한 crud api 생성","summary":"db와 연결 후 기초적인 형태의 crud api 생성"}},{"name":"FastAPI, sqlmodel로 간단한 crud api 생성 3","content":"\n이전 글에서 몇가지 의문점을 남겨놨습니다.\n\n- 유저를 추가할때 중복을 확인하지 않는다.\n- 유저를 수정한 일자가 없다.\n- 왜 response_model은 user로 고정이지?\n- etc...\n\n**다음 글**에서, 이러한 부분들을 고쳐가겠습니다.\n\n## 그 전에...\n\n지난 글까지 작성한 스크립트는 모두 한 폴더에 모여있습니다. 이런 구조는 지금같이 간단한 수준일때는 문제가 없지만, 점점 개발을 힘들게 만듭니다.\n그렇기 때문에, 간단한 형태로 구조화할 생각입니다.\n**아직 많이 부족하여, 효율적인 구조일지는 장담할 수 없습니다..**\n\n계획은 이렇습니다.\n\n\u003e 1. api 서버를 실행하는 스크립트를 최상위 폴더에 위치하고, `scripts` 폴더를 생성\n\u003e 2. `scripts` 폴더에 `config`, `database`, `models`, `routes` 폴더를 생성\n\u003e    \u003e `config` : 환경설정과 관련된 스크립트를 모아놓습니다. **다른 경로의 스크립트를 참조하지 않습니다.** \u003e\u003e `database` : db와 관련된 기본적인 작업에 대한 스크립트를 모아놓습니다.\n\u003e    \u003e `models` : 여러 api를 작성할 때 사용될 모델에 대한 스크립트를 모아놓습니다.\n\u003e    \u003e `routes` : 여러 api에 대해 입맛에 맞게 구조화하여 배치합니다.\n\u003e\n\u003e ### 왜 최상위 폴더가 아닌 `scripts` 폴더에?\n\u003e\n\u003e 파이썬에는 상대참조와 절대참조가 있습니다.\n\u003e 아직 많이 부족하여, 정확히 이건 어떻고 저건 어떻다 말할 수준은 못되지만, **상대참조는 패키지로 구성된 스크립트에서만 가능하다고 알고 있습니다.**\n\u003e 그렇기에, `scripts`폴더를 최상위 경로에서 사용할 수 있는 로컬 패키지처럼 사용하기 위해 `scripts`폴더를 생성 후, 하위 경로로 다른 폴더를 위치하게 했습니다.\n\n### 1. config\n\n앞으로 사용할 `settings` 클래스를 정의할 스크립트인 `default.py`를 생성하겠습니다.\n\n```python\n# api/scripts/config/default.py\nfrom typing import Any\n\nfrom pydantic import BaseSettings, Field\n\n\nclass database(BaseSettings):\n    drivername: str = \"postgresql+asyncpg\"\n    host: str = \"db\"\n\n    username: str = Field(..., env=\"POSTGRES_USER\")\n    password: str = Field(..., env=\"POSTGRES_PASSWORD\")\n    port: int = Field(..., env=\"POSTGRES_PORT\")\n    database: str = Field(..., env=\"POSTGRES_DB\")\n\n    query: dict[str, Any] = Field(default_factory=dict)\n\n\nclass settings(BaseSettings):\n    debug: bool = Field(..., env=\"RESTAPI_DEBUG\")\n\n    run_port: int = Field(..., env=\"RESTAPI_PORT\")\n    access_port: int = Field(..., env=\"RESTAPI_OUT_PORT\")\n\n    database: database = database()\n```\n\n그리고 `__ init__.py`를 생성해서 `settings` 클래스의 인스턴스를 생성합니다.\n\n```python\n# api/scripts/config/__init__.py\nfrom .default import settings\n\n__all__ = (\"settings\",)\n\nsettings = settings()\n```\n\n이제 `scripts.config.settings`로 설정값에 접근할 수 있습니다.\n\n### 2. database\n\n`routes`에서 빈번하게 사용될 `get_session`과 같은 범용적인 db관련 스크립트를 작성합니다.\n\n```python\n# api/scripts/database/default.py\nfrom typing import AsyncGenerator\n\nfrom sqlalchemy.engine.url import URL\nfrom sqlalchemy.ext.asyncio.engine import create_async_engine\nfrom sqlmodel import SQLModel\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom ..config import settings\n\nurl = URL.create(**settings.database.dict())\nengine = create_async_engine(url, echo=settings.debug)\n\n\nasync def get_session() -\u003e AsyncGenerator[AsyncSession, None]:\n    async with AsyncSession(engine) as session:\n        yield session\n\n\nasync def create_model_table() -\u003e None:\n    async with engine.begin() as conn:\n        await conn.run_sync(SQLModel.metadata.create_all)\n```\n\n기존에 최상위 경로에 생성했던 `database.py`와 달라진 점은, **직접 환경변수를 불러오지 않고,** 이전에 작성한 `scripts.config.settings`를 불러와서 사용한다는 것입니다.\n\n이어서 `__ init__.py`를 작성해서, 실제로 사용할 함수를 모아놓습니다.\n\n```python\n# api/scripts/database/__init__.py\nfrom .default import create_model_table, get_session\n\n__all__ = (\"get_session\", \"create_model_table\")\n```\n\n### 3. models\n\n우선 `user`폴더를 생성한 다음, 그 폴더에 `__ init__.py`를 작성하겠습니다.\n\n\u003e 굳이 이렇게 하는 이유는\n\n- 각 라우트 혹은 모델별로 다른 폴더에 관리하면 편했던 기억이 있어서 그렇고,\n- 지금은 사용하지 않지만, `orjson`으로 `json`을 loads, dumps 할때, `pydantic`의 `BaseModel`을 상속한 새로운 모델을 만들어서 사용하는데, 그 모델을 `models.__init__.py`에 작성해두면 나중에 쓸때 편했기 때문입니다.\n\n**`api/scripts/models/user/__init__.py`는 기존 `model.py`와 같으므로 생략합니다.**\n\n### 4. routes\n\n기존에 `main.py`에 있던 `crud` api를 옮깁니다.\n이것도 `models`와 같이, `user`폴더를 생성 한 다음 해당 폴더에 스크립트를 작성합니다.\n\n우선 `main.py`에 정의된 `app`에 연결할 라우터를 정의할 `app.py`부터 작성합니다.\n\n```python\n# api/scripts/routes/user/app.py\nfrom fastapi import APIRouter\n\napp = APIRouter()\n```\n\n굳이 이렇게 따로 뺀 이유는 순환 참조 오류를 방지하기 위해서 입니다.\n\n여기서 `tags`와 `prefix`를 설정할 수도 있지만, 개인적으로 `main.py`에서 일괄적으로 확인하고 수정할 수 있는게 편해서 지금은 하지 않았습니다.\n\n다음으로 이전에 작성한 `crud` api를 모아놓은 `crud.py`를 작성합니다.\n\n```python\n# api/scripts/scripts/routes/user/crud.py\nfrom fastapi import Depends, HTTPException, Path\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom ...database import get_session\nfrom ...models import user\nfrom .app import app\n\n\n@app.post(\"/create_user\", response_model=user.user)\nasync def create_user(data: user.user, *, session: AsyncSession = Depends(get_session)):\n    user_instance = user.user.from_orm(data)\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n@app.get(\"/get_user/{user_id}\", response_model=user.user)\nasync def get_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    return user_instance\n\n\n@app.patch(\"/update_user/{user_id}\", response_model=user.user)\nasync def update_user(\n    data: user.user,\n    user_id: int = Path(..., ge=1),\n    *,\n    session: AsyncSession = Depends(get_session),\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    update_data = data.dict(exclude_unset=True)\n    for key, value in update_data.items():\n        setattr(user_instance, key, value)\n\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n@app.delete(\"/delete_user/{user_id}\")\nasync def delete_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    await session.delete(user_instance)\n    await session.commit()\n\n    return user_id\n```\n\n여기서 사용되는 `app`은 `main.py`의 `app`이 아닌, 같은 폴더의 `app.py`의 `app`입니다.\n\n마지막으로 `__ init__.py`를 작성합니다.\n\n```python\n# api/scripts/routes/user/__init__.py\nfrom .crud import app\n```\n\n여기서 불러온 앱은 `crud` api가 기억된 상태로, 나중에 `main.py`에서 불러옵니다.\n\n이제 `main.py`를 정리합니다.\n\n```python\n# api/main.py\nimport uvicorn\nfrom fastapi import Depends, FastAPI\nfrom sqlalchemy.sql import text\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom scripts.config import settings\nfrom scripts.database import create_model_table, get_session\nfrom scripts.routes import user\n\napp = FastAPI()\napp.on_event(\"startup\")(create_model_table)\napp.include_router(user.app, prefix=\"/user\", tags=[\"user\"])\n\n\n@app.get(\"/\")\ndef index():\n    return {\"hello\": \"world\"}\n\n\n@app.get(\"/session_test\")\nasync def session_test(*, session: AsyncSession = Depends(get_session)):\n    data = await session.exec(text(\"select 1\"))  # type: ignore\n    return data.all()\n\n\nif __name__ == \"__main__\":\n    uvicorn.run(\n        \"main:app\",\n        host=\"0.0.0.0\",\n        port=settings.run_port,\n        reload=settings.debug,\n    )\n```\n\n`api`폴더는 최상위 폴더이므로, `scripts`를 패키지처럼 다루면 됩니다.\n`user` 라우터는 `prefix=\"user\"`, `tags=[\"user\"]`로 파라미터를 줬습니다. 나중에 docs에서 확인해보면 차이를 알 수 있습니다.\n이제는 사용하지 않는 기존 `api/database.py`, `api/model.py`를 제거합니다.\n정상적으로 진행했다면, 다음과 같은 구조를 가지게 됩니다.\n\n```\n.\n├── .env\n├── api\n│   ├── main.py\n│   └── scripts\n│       ├── config\n│       │   ├── __init__.py\n│       │   └── default.py\n│       ├── database\n│       │   ├── __init__.py\n│       │   └── default.py\n│       ├── models\n│       │   └── user\n│       │       └── __init__.py\n│       └── routes\n│           └── user\n│               ├── __init__.py\n│               ├── app.py\n│               └── crud.py\n├── db [error opening dir]\n├── docker-compose.yml\n├── dockerfile\n└── requirements.txt\n```\n\n`db`폴더에 접근이 불가능 한 것은, 컨테이너 내부에서 관리자 권한으로 작성됐기 때문입니다.\n이제 `docker-compose up`으로 실행해서 docs를 확인해봅시다.\n![](/images/80800d72-874a-4bc0-afd5-80792cf91bef-docs.png)\napi 경로에 `user`가 추가됐고,\n각 api가 사전에 설정한 `tags`를 기준으로 나뉘어 진 것을 확인할 수 있습니다.\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/FastAPI, sqlmodel로 간단한 crud api 생성 3","data":{"title":"FastAPI, sqlmodel로 간단한 crud api 생성 3","date":"2021-11-26T22:52:37.564+09:00","tags":["crud","fastapi","python","sqlmodel","@all"],"page":"FastAPI, sqlmodel로 간단한 crud api 생성","summary":"crud api를 보완하기 전, 구조를 적당히 변환"}},{"name":"FastAPI, sqlmodel로 간단한 crud api 생성 4","content":"\n이제 기존에 작성한 `crud` api를 보완해보겠습니다.\n\n## 유저를 추가할때 중복 확인\n\n기존 작성된 `create` api는 입력받은 `body`를 그대로 db에 새로운 레코드로 추가하는 역할만 했습니다.\n이제 `email`속성을 기준으로 중복을 확인 한 다음 레코드로 추가할 수 있게 코드를 수정하겠습니다.\n\n```python\n# api/scripts/routes/user/crud.py\n(전략)\n\n@app.post(\"/create_user\", response_model=user.user)\nasync def create_user(data: user.user, *, session: AsyncSession = Depends(get_session)):\n    user_email = await session.exec(select(user.user.email))  # type: ignore\n    if data.email in user_email: # type: ignore\n        raise HTTPException(status_code=400, detail=\"동일한 email 유저 있음\")\n\n    user_instance = user.user.from_orm(data)\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n(후략)\n```\n\n이제 중복된 유저 데이터를 입력하면 다음과 같은 400에러와 함께 다음과 같은 값을 반환합니다.\n\n```json\n{\n  \"detail\": \"동일한 email 유저 있음\"\n}\n```\n\n로그를 확인해보면 다음과 같이 에러를 반환하는 것을 확인할 수 있습니다.\n\n```sql\nINFO sqlalchemy.engine.Engine BEGIN (implicit)\nINFO sqlalchemy.engine.Engine SELECT \"user\".email\nFROM \"user\"\nINFO sqlalchemy.engine.Engine [no key 0.00018s] ()\nINFO:     10.0.2.100:43750 - \"POST /user/create_user HTTP/1.1\" 400 Bad Request\nINFO sqlalchemy.engine.Engine ROLLBACK\n```\n\n만약 중복이 아닌 데이터를 입력하면, 다음과 같은 로그를 확인할 수 있습니다.\n\n```sql\nINFO sqlalchemy.engine.Engine BEGIN (implicit)\nINFO sqlalchemy.engine.Engine SELECT \"user\".email\nFROM \"user\"\nINFO sqlalchemy.engine.Engine [no key 0.00016s] ()\nINFO sqlalchemy.engine.Engine INSERT INTO \"user\" (name, email, registered_date) VALUES (%s, %s, %s) RETURNING \"user\".id\nINFO sqlalchemy.engine.Engine [cached since 276.6s ago] ('test', 'test@example.com', datetime.datetime(--))\nINFO sqlalchemy.engine.Engine COMMIT\nINFO sqlalchemy.engine.Engine BEGIN (implicit)\nINFO sqlalchemy.engine.Engine SELECT \"user\".id, \"user\".name, \"user\".email, \"user\".registered_date\nFROM \"user\"\nWHERE \"user\".id = %s\nINFO sqlalchemy.engine.Engine [cached since 276.6s ago] (3,)\nINFO:     10.0.2.100:43796 - \"POST /user/create_user HTTP/1.1\" 200 OK\nINFO sqlalchemy.engine.Engine ROLLBACK\n```\n\n\u003e 지금은 api 서버에서 처리하는 방법을 보이기 위해 이렇게 코드를 작성했습니다.\n\u003e 하지만 **더 간단하게 중복을 제외하는 방법**이 있습니다.\n\u003e `user.user` 모델을 정의할 때, `email` 필드에 `sa_column_kwargs={\"unique\": True}` 파라미터를 추가하면 됩니다.\n\u003e 그러면 api 서버가 아닌, db에서 중복을 확인하고, 에러를 반환할 것입니다.\n\u003e 다만, **이 에러에 대한 예외처리는 직접 해야합니다.**\n\n## 유저 정보를 수정한 최종 일자 기록\n\n기존 `user` 모델은 최초 입력 일자에 대한 정보만 보존하고, 수정한 일자에 대해서는 보존하지 않습니다. 이는 테이블에 새로운 필드를 추가해야 가능한 일이므로, `user`모델을 직접적으로 수정하겠습니다.\n\n```python\n# api/scripts/models/user/__init__.py\n(전략)\n\nclass user(SQLModel, table=True):\n    id: Optional[int] = Field(None, primary_key=True)\n    name: str = Field(..., min_length=1, nullable=False)\n    email: EmailStr = Field(..., nullable=False)\n    registered_date: datetime = Field(default_factory=datetime.today)\n    last_updated_date: datetime = Field(default_factory=datetime.today)\n```\n\n`last_updated_date` 필드만 추가하고 끝냈습니다.\n지금 이상태 그대로 진행하면 `update` api를 수정하더라도, 에러를 반환할 것입니다. 기존에 db 생성한 `user`테이블에는 `last_updated_date` 필드가 없기 때문입니다.\nsql의 `alter` 쿼리를 사용해도 되고, `sqlalchemy`의 `drop_all` 메소드를 사용해도 됩니다.\n지금은 개발 초기중의 초기이므로 `drop_all`로 해결하겠습니다.\n\n```python\n# api/scripts/database/default.py\n(전략)\n\nasync def create_model_table() -\u003e None:\n    async with engine.begin() as conn:\n        if settings.debug:\n            await conn.run_sync(SQLModel.metadata.drop_all)\n        await conn.run_sync(SQLModel.metadata.create_all)\n```\n\n기존에 없던 `await conn.run_sync(SQLModel.metadata.drop_all)`를 추가했습니다.\n`create_model_table`함수가 이미 서버를 시작할때 실행되도록 설정돼 있기 때문에, 이제 서버를 시작하면 작성한 모델에 대응하는 테이블을 모두 `drop`하고 다시 `create`할 것입니다.\n개발중에만 사용하자는 의미로 `settings.debug`를 확인하도록 했습니다. 실제로는 더 엄격하게 확인하는게 맞습니다.\n\n이제 `update` api를 수정하겠습니다.\n\n```python\n# api/scripts/routes/user/crud.py\n\nfrom datetime import datetime\n\nfrom fastapi import Depends, HTTPException, Path\nfrom sqlmodel import select\nfrom sqlmodel.ext.asyncio.session import AsyncSession\n\nfrom ...database import get_session\nfrom ...models import user\nfrom .app import app\n\n(중략)\n\n@app.patch(\"/update_user/{user_id}\", response_model=user.user)\nasync def update_user(\n    data: user.user,\n    user_id: int = Path(..., ge=1),\n    *,\n    session: AsyncSession = Depends(get_session),\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    update_data = data.dict(exclude_unset=True)\n    for key, value in update_data.items():\n        setattr(user_instance, key, value)\n\n    user_instance.last_updated_date = datetime.today()\n\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n(후략)\n```\n\n`user_instance.last_updated_date = datetime.today()`가 추가됐습니다.\n이제 정상적으로 `update` api가 실행되면, `last_update_date` 값이 변합니다.\n\n실제로 실행해보면, 다음과 같은 결과를 반환받습니다.\n\n```json\n{\n  \"id\": 1,\n  \"registered_date\": \"2021-11-26T23:59:37.359332\",\n  \"last_updated_date\": \"2021-11-26T23:59:52.837064\",\n  \"name\": \"aaa\",\n  \"email\": \"user@example.com\"\n}\n```\n\n## 각 api의 `response_model`과 `body` 형태 수정\n\n지금까지 작성된 `crud` api는 `delete`를 제외하고 `response_model=user.user` 파라미터를 가지고 있습니다. 이것은 반환한 값이 `user.user` 인스턴스이고, `user.user` 의 스키마로 데이터를 반환해라는 의미입니다.\n\n하지만 모든 api에서 그렇게 하는 것은 **위험한 일**입니다.\n지금은 따로 설정하지 않았지만 사용자의 **비밀번호**가 필드에 있을 수도 있고, **민감한 개인정보** 또한 가능합니다.\n\n또한 입력받는 `body` 역시 `user.user`의 스키마로 구성된 데이터를 받습니다. 하지만 이것은 불필요한 일이고, 어쩌면 **오류를 발생시킬 수도 있습니다.**\n\n사용자가 `user`를 추가할 때, `id`나 `registered_date`와 같이 레코드에 자동으로 입력되는 값은 **사용자가 입력한 값을 받을 필요도 없고, 받아선 안되는 값입니다.**\n\n따라서, 사용자가 입력하는 값과, 사용자에게 반환할 값에 대한 새로운 스키마가 필요합니다. 이에 대한 모델을 새로 생성하면서, 기존의 모델을 정의하는데 있어서 **약간의 변화**를 주겠습니다.\n\n```python\n# api/scripts/models/user/__init__.py\n\n(전략)\n\nclass user_base(SQLModel):\n    name: str = Field(..., min_length=1, nullable=False)\n    email: EmailStr = Field(..., nullable=False)\n\n\nclass user_create(user_base):\n    pass\n\n\nclass user_read(user_base):\n    id: int\n\n\nclass user_update(user_base):\n    name: Optional[str] = Field(None, min_length=1)\n    email: Optional[EmailStr] = None\n\n\nclass user(user_base, table=True):\n    id: Optional[int] = Field(None, primary_key=True)\n    registered_date: datetime = Field(default_factory=datetime.today)\n    last_updated_date: datetime = Field(default_factory=datetime.today)\n```\n\n`user_base`를 기준으로 `create`, `read`, `update`에 대응하는 모델과 `user` 테이블에 해당하는 모델을 생성했습니다.\n\n\u003e `user_update`는 `user_base`에서 정의된 모든 필드를 덮어씌우지만, 그렇지 않은 경우도 있을 수 있으니 일단 상속했습니다.\n\n이전에 `table=True` 파라미터가 있어야 db에 테이블이 생성된다고 한 적이 있습니다. 위 코드에서 확인할 수 있듯이, `user` 클래스만 `table=True` 파라미터를 가지고 있습니다. 따라서 `user` 클래스를 제외한 모델은 사실상 `pydantic`의 모델로 활용하게 됩니다.\n\n이제 이 모델을 적용한 `crud` api를 수정합니다.\n\n```python\n# api/scripts/routes/user/crud.py\n\n(전략)\n\n@app.post(\"/create_user\", response_model=user.user_read)\nasync def create_user(\n    data: user.user_create, *, session: AsyncSession = Depends(get_session)\n):\n    user_email = await session.exec(select(user.user.email))  # type: ignore\n    if data.email in user_email:  # type: ignore\n        raise HTTPException(status_code=400, detail=\"동일한 email 유저 있음\")\n\n    user_instance = user.user.from_orm(data)\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n@app.get(\"/get_user/{user_id}\", response_model=user.user_read)\nasync def get_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    return user_instance\n\n\n@app.patch(\"/update_user/{user_id}\", response_model=user.user_read)\nasync def update_user(\n    data: user.user_update,\n    user_id: int = Path(..., ge=1),\n    *,\n    session: AsyncSession = Depends(get_session),\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    update_data = data.dict(exclude_unset=True)\n    for key, value in update_data.items():\n        setattr(user_instance, key, value)\n\n    user_instance.last_updated_date = datetime.today()\n\n    session.add(user_instance)\n    await session.commit()\n    await session.refresh(user_instance)\n\n    return user_instance\n\n\n@app.delete(\"/delete_user/{user_id}\")\nasync def delete_user(\n    user_id: int = Path(..., ge=1), *, session: AsyncSession = Depends(get_session)\n):\n    user_instance = await session.get(user.user, user_id)\n    if not user_instance:\n        raise HTTPException(status_code=404, detail=f\"there is not {user_id=} user\")\n\n    await session.delete(user_instance)\n    await session.commit()\n\n    return user_id\n```\n\n`reponse_model`을 `user.user_read`로 수정하고, `body`에 해당하는 `data`의 타입을 `user.user_create` 또는 `user.user_update`로 수정했습니다.\n`response_model`을 `user.user_read`로 정했기 때문에, `user.user` 인스턴스를 반환하더라도, `user.user_read`의 스키마에 따라 값이 반환됩니다.\n![](/images/9a191a49-09af-4cad-acf6-fe48c31b5fa5-docs.png)\ndocs에서 한 눈에 확인 가능합니다.\n\n## 끝으로..\n\n더 적고 싶은데, 더 적을게 뭐가 있을지 잘 모르겠어요.\n일단 여기서 중단\n","mtime":"2022-08-13T00:12:20.000+09:00","href":"velog/FastAPI, sqlmodel로 간단한 crud api 생성 4","data":{"title":"FastAPI, sqlmodel로 간단한 crud api 생성 4","date":"2021-11-27T00:28:51.285+09:00","tags":["crud","fastapi","python","sqlmodel","@all"],"page":"FastAPI, sqlmodel로 간단한 crud api 생성","summary":"이제 기존에 작성한 crud api를 보완해보겠습니다."}}]},"__N_SSG":true},"page":"/posts/[...name]","query":{"name":["velog","FastAPI, sqlmodel로 간단한 crud api 생성 2"]},"buildId":"MQ_lMVQgBI0RkmUA6wvVT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>